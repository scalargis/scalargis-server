{% extends "backoffice/_layout.html" %}
{% from "_custom_macros.html" import render_pagination_summary, render_pagination %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Emissão de Plantas<i class="fa fa-long-arrow-right  fa-fw" aria-hidden="true"></i>Plantas</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>


<div id="confirmDiv" >
</div>
<div id="informationDiv" >
</div>


<div class="module-content">
    <div class="panel-group" id="searchCatalog">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a data-toggle="collapse" data-parent="#searchCatalog" href="#collapseOne">Pesquisa</a>
            </div>
            <!--<div id="collapseOne" class="panel-collapse collapse @((Model.showSearchArea) ? "in" : "")">-->
            <div id="collapseOne" class="panel-collapse collapse">
                <div class="panel-body">
                    <form action="" method="POST">
                      {{ form.csrf_token }}
                      <input type="hidden" name="page" id="page" value="{{ form.page.data or '' }}" />
                      <input type="hidden" name="orderField" id="orderField" value="{{ form.orderField.data or '' }}" />
                      <input type="hidden" name="sortOrder" id="sortOrder" value="{{ form.sortOrder.data or '' }}" />
                      <fieldset>
                          <div class="row">
                            <div class="col-md-2">
                                <label>Id:</label>
                                <input type="text" name="id" id="id" class="form-control input-block-level" value="{{ form.id.data or '' }}">
                            </div>
                            <div class="col-md-2">
                                <label>Código:</label>
                                <input type="text" name="codigo" id="codigo" class="form-control input-block-level" value="{{ form.codigo.data or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label>Nome:</label>
                                <input type="text" name="nome" id="nome" class="form-control input-block-level" value="{{ form.nome.data or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label>Título:</label>
                                <input type="text" name="titulo" id="titulo" class="form-control input-block-level" value="{{ form.titulo.data or '' }}">
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-md-2">
                                <label>Escala:</label>
                                <input type="text" name="escala" id="escala" class="form-control input-block-level" value="{{ form.escala.data or '' }}">
                            </div>
                            <div class="col-md-2">
                                <label>Formato:</label>
                                <select name="formato" id="formato" class="form-control input-block-level">
                                    <option value=""></option>
                                    {% set formats = ['A4', 'A3', 'A2','A1','A0'] %}
                                    {% for f in formats %}
                                    <option value="{{ f }}" {% if f == form.formato.data %}selected{% endif %}>{{ f }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label>Orientação:</label>
                                <select name="orientacao" id="orientacao" class="form-control input-block-level">
                                    <option value=""></option>
                                    {% set orientations = ['Retrato', 'Paisagem'] %}
                                    {% for o in orientations %}
                                    <option value="{{ o }}" {% if o == form.orientacao.data %}selected{% endif %}>{{ o }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Mapa:</label>
                                <select name="mapa" id="mapa" class="form-control selectpicker" multiple data-actions-box="true">
                                    {% for m in mapas %}
                                    <option value="{{ m.codigo }}" data-subtext="{{ m.codigo }}" title="{{ m.codigo }}">{{ m.titulo }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label style="display:block">&nbsp;</label>
                                <button type="submit" class="btn btn-primary" id="pesquisar" name="pesquisar" value="true">Pesquisar</button>
                            </div>
                          </div>
                      </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="panel-group" id="resultsCatalog">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a data-toggle="collapse" data-parent="#resultsCatalog" href="#collapseTwo">Resultados</a>
            </div>
            <!--<div id="collapseTwo" class="panel-collapse collapse @((Model.showResultsArea) ? "in" : "")">-->
            <div id="collapseTwo" class="panel-collapse collapse in">
                <div class="panel-body">
                    <div style="text-align: right; margin-right: 10px">
                        <a href="{{ url_for('backoffice.plantas_create') }}" class="push"><i class="fa fa-plus"></i> Nova Planta</a>
                    </div>

                    {% if records %}
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <!--<th data-field="Id" class="columnheader @(Model.orderField == "Id" ? "sorting_" + Model.sortOrder : "sorting")">@T("Id")</th>
                                <th data-field="Titulo" class="columnheader @(Model.orderField == "Titulo" ? "sorting_" + Model.sortOrder : "sorting")">@T("Título")</th>-->
                                <th data-field="id" class="columnheader {%if form.orderField.data == 'id' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Id</th>
                                <th data-field="codigo" class="columnheader {%if form.orderField.data == 'codigo' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Código</th>
                                <th data-field="nome" class="columnheader {%if form.orderField.data == 'nome' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Nome</th>
                                <th data-field="titulo" class="columnheader {%if form.orderField.data == 'titulo' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Título</th>
                                <th>Configuração</th>
                                <th>Grupos</th>
                                <th>Mapas</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.id }}</td>
                                <td>{{ record.codigo }}</td>
                                <td>{{ record.nome }}</td>
                                <td>{{ record.titulo }}</td>
                                <td><a class="mapconfig" href="#" data-content="{{ record.configuracao }}">Ver</a></td>
                                <td>
                                    {% for t in record.tipos_plantas %}
                                        <span class="badge" title="{{t.tipo_planta.titulo}}">{{ t.tipo_planta.codigo }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for m in record.mapas %}
                                        <span class="badge" title="{{m.mapa.titulo}}">{{ m.mapa.codigo }}</span>
                                    {% endfor %}
                                </td>
                                <td style="width: 50px; min-width: 40px">
                                    <a href="{{ url_for('backoffice.plantas_edit', id=record.id) }}"><i class="fa fa-pencil"></i></a>
                                    <a href="#" data-id="{{ record.id }}" data-action="{{ url_for('backoffice.plantas_delete', id=record.id) }}" class="delete-confirm" title="Eliminar"><i class="fa fa-trash"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        {% if pagination %}
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="dataTables_info" id="dataTables-example_info" role="status" aria-live="polite" style="padding: 8px">
                                    {{ render_pagination_summary(pagination) }}
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="dataTables_paginate paging_simple_numbers" style="text-align: right">
                                    {{ render_pagination(pagination) }}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    {% else %}
                        <div style="padding: 5px">
                            <div class="alert alert-warning">
                                Não foram encontrados registos!
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block post_script %}
<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        confirmModal: function (options) {
            var html = '<div class="modal fade" id="confirmContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div>' +
            '<div class="modal-body">#Body#</div><div class="modal-footer">' +
            '<a href="#" class="btn btn-default" id="confirmYesBtn">Sim</a>' +
            '<button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button></div></div><div>';

            var defaults = {
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o registo?',
                btnClass: 'btn-danger',
                callback: null
            };

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body);
            $(this).html(html);
            $('#confirmYesBtn', this).addClass(options.btnClass);
            $('#confirmContainer', this).modal('show');
            var context = $(this);
            $('#confirmYesBtn', this).click(function () {
                $("#confirmContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>

<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        informationModal: function (options) {
            var html = '<div class="modal fade" id="infoContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div><div class="modal-body">' +
            '<div class="#MessageClass#">#Body#</div></div><div class="modal-footer">' +
            '<a href="#" class="btn btn-primary" data-dismiss="modal" id="infoCloseButton">Fechar</a></div></div><div>';

            var defaults = {
                heading: 'Informação',
                body: '',
                messageClass: 'alert alert-info',
                callback: null
            };

            $('#infoCloseButton', this).unbind();
            $('#informationDiv').unbind();

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body).replace('#MessageClass#', options.messageClass);

            $(this).html(html);
            $("#infoContainer", this).modal('show');
            var context = $(this);
            $('#infoCloseButton', this).click(function () {
                $("#infoContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>

<script type="text/javascript">
    $(function () {

        var mapas = '{{ form.mapa.data or  '' }}'.split(',');
        $('.selectpicker').selectpicker({
            title: '',
            selectAllText: 'Todos',
            deselectAllText: 'Nenhum'
        });
        $('.selectpicker').selectpicker('val', mapas);

        $(".columnheader").click(function () {
            $("#orderField").attr("value", $(this).attr("data-field"));

            if ($(this).hasClass("sorting_asc"))
                $("#sortOrder").attr("value", "desc");
            else
                $("#sortOrder").attr("value", "asc");

            $("#page", "form").val("1");

            $("form").submit();
        });

        $("a", ".paginate_button").click(function () {
            page = $(this).data("page");

            $("#page", "form").val(page);
            $("form").submit();
        });

        $(".mapconfig").click(function () {
            $("#informationDiv").informationModal({
                heading: 'Configuração',
                body: $(this).attr("data-content"),
                messageClass: "alert alert-text",
                callback: function () {
                    //$("form").submit();
                }
            });
        });

        $(".delete-confirm").click(function () {
            var url = $(this).attr("data-action");
            var id = $(this).attr("data-id");
            $("#confirmDiv").confirmModal({
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o registo?',
                callback: function () {
                    $.ajax({
                        type: 'POST',
                        url: url,
                        data: "id=" + id,
                        success: function (r) {
                            if (r.Success) {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: 'O registo foi eliminado com sucesso.',
                                    messageClass: "alert alert-success",
                                    callback: function () {
                                        $("form").submit();
                                    }
                                });
                            } else {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: '<strong>Não foi possível eliminar o registo!</strong> ' + r.Message,
                                    messageClass: 'alert alert-danger',
                                    callback: null
                                });
                            }
                        },
                        error: function (r) {
                            $("#informationDiv").informationModal({
                                heading: 'Informação',
                                body: '<strong>Não foi possível eliminar o registo!</strong> ' + r.Message,
                                messageClass: 'alert alert-danger',
                                callback: function () {
                                    $("form").submit();
                                }
                            });
                        }
                    });
                }
            });
        });

    });
</script>

{% endblock %}