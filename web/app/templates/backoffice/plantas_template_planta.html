{% extends "backoffice/_layout.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Emissão de Plantas<i class="fa fa-long-arrow-right  fa-fw" aria-hidden="true"></i>Templates (PDF)</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>


<div id="confirmDiv" >
</div>
<div id="informationDiv" >
</div>


<div class="module-content">
    <div class="col-md-7">
        <label>Directoria: {{ path }}</label>
        <label>Caminho relativo: pdf/</label>

        <form action="" method="POST" id="main">
          {{ form.csrf_token }}
          <input type="hidden" name="page" id="page" value="{{ form.page.data or '' }}" />
          <input type="hidden" name="orderField" id="orderField" value="{{ form.orderField.data or '' }}" />
          <input type="hidden" name="sortOrder" id="sortOrder" value="{{ form.sortOrder.data or '' }}" />
        </form>

        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th data-field="filename" class="columnheader {%if form.orderField.data == 'filename' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Ficheiro</th>
                <th data-field="date" class="columnheader {%if form.orderField.data == 'date' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Data</th>
                <th data-field="size" class="columnheader {%if form.orderField.data == 'size' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Dimensão</th>
                <th></th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for file in files %}
            <tr>
                <td>{{ file.filename }}</td>
                <td>{{ file.date }}</td>
                <td>{{ file.size }} KB</td>
                <td>
                    <a href="{{ url_for('file.get_planta_template', filename=file.filename) }}" target="_blank" title="Abrir"><i class="fa fa-file-pdf-o"></i></a>
                </td>
                <td style="width: 50px; min-width: 40px">
                    <a href="#" data-filename="{{ file.filename }}" data-action="{{ url_for('backoffice.plantas_template_delete', file=file.filename) }}" class="delete-confirm" title="Eliminar"><i class="fa fa-trash"></i></a>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="col-md-5">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Adicionar Template</h3>
            </div>
            <div class="panel-body">
                <form method="post" enctype="multipart/form-data" id="formFiles" action="{{ url_for('file.upload_planta_template') }}">
                    <input type="file" name="files[]" id="input_files" multiple />
                </form>
                <br />
                <div id="loading_spinner" style="display: none;"><i class="fa fa-spinner fa-pulse"></i> A enviar ...</div>
                <div id="result"></div>
                <div class="col-md-4 col-md-offset-4">
                    <button type="button" id="btn_cancel_files" class="btn btn-default center-block" style="display: none;">Cancelar</button>
                </div>
                <div class="col-md-4">
                    <button type="button" id="btn_upload_files" class="btn btn-primary center-block" style="display: none;">Submeter</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block post_script %}

<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        confirmModal: function (options) {
            var html = '<div class="modal fade" id="confirmContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div>' +
            '<div class="modal-body">#Body#</div><div class="modal-footer">' +
            '<a href="#" class="btn btn-default" id="confirmYesBtn">Sim</a>' +
            '<button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button></div></div><div>';

            var defaults = {
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o registo?',
                btnClass: 'btn-danger',
                callback: null
            };

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body);
            $(this).html(html);
            $('#confirmYesBtn', this).addClass(options.btnClass);
            $('#confirmContainer', this).modal('show');
            var context = $(this);
            $('#confirmYesBtn', this).click(function () {
                $("#confirmContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>

<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        informationModal: function (options) {
            var html = '<div class="modal fade" id="infoContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div><div class="modal-body">' +
            '<div class="#MessageClass#">#Body#</div></div><div class="modal-footer">' +
            '<a href="#" class="btn btn-primary" data-dismiss="modal" id="infoCloseButton">Fechar</a></div></div><div>';

            var defaults = {
                heading: 'Informação',
                body: '',
                messageClass: 'alert alert-info',
                callback: null
            };

            $('#infoCloseButton', this).unbind();
            $('#informationDiv').unbind();

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body).replace('#MessageClass#', options.messageClass);

            $(this).html(html);
            $("#infoContainer", this).modal('show');
            var context = $(this);
            $('#infoCloseButton', this).click(function () {
                $("#infoContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>

<script type="text/javascript">
    $(function () {

        $(".delete-confirm").click(function () {
            var url = $(this).attr("data-action");
            var file = $(this).attr("data-filename");
            $("#confirmDiv").confirmModal({
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o ficheiro <i>' + file + '</i> ?',
                callback: function () {
                    $.ajax({
                        type: 'POST',
                        url: url,
                        data: "file=" + file,
                        success: function (r) {
                            if (r.Success) {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: 'O ficheiro <i>' + r.Filename + '</i> foi eliminado com sucesso.',
                                    messageClass: "alert alert-success",
                                    callback: function () {
                                        $("#main").submit();
                                    }
                                });
                            } else {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: '<strong>Não foi possível eliminar o ficheiro!</strong> ' + r.Message,
                                    messageClass: 'alert alert-danger',
                                    callback: null
                                });
                            }
                        },
                        error: function (r) {
                            $("#informationDiv").informationModal({
                                heading: 'Informação',
                                body: '<strong>Não foi possível eliminar o ficheiro!</strong> ' + r.Message,
                                messageClass: 'alert alert-danger',
                                callback: function () {
                                    $("#main").submit();
                                }
                            });
                        }
                    });
                }
            });
        });

    });
</script>

<script type="text/javascript">

    var formdata = false;

    function TransferCompleteCallback(content){
        $("#btn_cancel_files").show();
        $("#btn_upload_files").show();
    }

    function resetFormFiles() {
        // reset formdata
        formdata = false;
        formdata = new FormData();

        $('#input_files').val('');

        $("#loading_spinner").hide();
        $("#btn_cancel_files").hide();
        $("#btn_upload_files").hide();

        $('#result').html('');
    }

    $( document ).ready(function() {
        if (window.FormData) {
            formdata = new FormData();
        }

        $(".columnheader").click(function () {
            $("#orderField").attr("value", $(this).attr("data-field"));

            if ($(this).hasClass("sorting_asc"))
                $("#sortOrder").attr("value", "desc");
            else
                $("#sortOrder").attr("value", "asc");

            $("#page", "#main").val("1");

            $("#main").submit();
        });

        $('#input_files').on('change',function(event){
            var len = this.files.length, img, reader, file;

            $('#result').html('');

            var files = [];

            for (var i=0; i < len; i++ ) {
                file = this.files[i];

                if(!!file.name.match(/.*\.pdf$/)){
                    if ( window.FileReader ) {
                        reader = new FileReader();
                        reader.onloadend = function (e) {
                            TransferCompleteCallback(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                    if (formdata) {
                        formdata.append("files[]", file);
                        files.push(file.name)
                    }
                } else {
                    alert(file.name+': não é um ficheiro PDF');
                }
            }

            if (files.length > 0) {
                var buf = '<ul class="list-group">';
                for(var x=0; x<files.length; x++){
                    buf+='<li class="list-group-item">'+files[x]+'</li>';
                }
                buf += '</ul>';
                $('#result').html('<strong>Ficheiros a adicionar:</strong>'+buf);
            } else {
                //$('#result').html('<strong>Não foram adicionados ficheiros</strong>');
                resetFormFiles();
            }
        });

        $("#btn_cancel_files").click(function (event) {
            event.preventDefault();

            // reset formdata
            resetFormFiles();

            return false;
        });

        $("#btn_upload_files").click(function (event) {
            event.preventDefault();

            if (formdata) {

                $("#loading_spinner").show();

                $.ajax({
                    url: "{{ url_for('file.upload_planta_template') }}",
                    type: "POST",
                    data: formdata,
                    processData: false,
                    contentType: false, // this is important!!!
                    success: function (res) {
                        if(res.Success === true){
                            // reset formdata
                            resetFormFiles();

                            var data = res.Data;
                            var msgError = '';
                            for (var i=0; i<data.length; i++) {
                                if (!data[i].Success) {
                                    msgError+='<li class="list-group-item">'+data[i].Filename+'</li>';
                                }
                            }
                            if (msgError != '') {
                                msgError = '<ul class="list-group">' + msgError + '</ul>';
                                msgError = '<div>Não foi possível realizar o upload de todos os ficheiros. Já existiam ficheiros como mesmo nome:</div>' +  msgError;

                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: msgError ,
                                    messageClass: "alert alert-warning",
                                    callback: function () {
                                        $("#main").submit();
                                    }
                                });
                            } else {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: 'Ficheiro(s) enviados(s) com sucesso.',
                                    messageClass: "alert alert-success",
                                    callback: function () {
                                        $("#main").submit();
                                    }
                                });
                            }
                        } else {
                            $('#result').html(res.Message);
                        }
                    }
                });
            }

            return false;
        });

    });
</script>

{% endblock %}