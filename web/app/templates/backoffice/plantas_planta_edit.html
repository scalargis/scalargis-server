{% extends "backoffice/_layout.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Plantas<i class="fa fa-long-arrow-right  fa-fw" aria-hidden="true"></i>Edição</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>

<div id="confirmDiv" >
</div>
<div id="informationDiv" >
</div>

<div class="module-content">
    <form method="post" id="formPlanta" name="formPlanta">
        {% with messages = get_flashed_messages() %}
           {% if messages %}
           <div class="alert alert-success alert-dismissible" role="alert">
              <a class="close" data-dismiss="alert">×</a>
              {% for message in messages %}
                 {{ message }}
              {% endfor %}
           </div>
           {% endif %}
        {% endwith %}

        {% if error %}
           <div class="alert alert-danger alert-dismissible" role="alert">
              <a class="close" data-dismiss="alert">×</a>
              <h4 class="alert-heading">Erros:</h4>
              <ul>
             {% if error and error.Message %}
               <li>{{ error.Message }}</li>
             {% endif %}
             {% for field in form if field.widget.input_type != 'hidden' %}
               {% if field.errors %}
                  <li><strong>{{ field.label.text }}</strong>:{% for error in field.errors %} {{ error }}.{% endfor %}</li>
               {% endif %}
             {% endfor %}
              </ul>
           </div>
        {% endif %}

        {{ form.csrf_token }}

        <fieldset>
            <!--
            <legend>Edição de Planta</legend>
            -->

            <div class="row">
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-3">
                            <label>Código</label>
                            <input type="text" name="codigo" id="codigo" class="form-control input-block-level" value="{{ form.codigo.data or '' }}" />
                        </div>
                        <div class="col-md-9">
                            <label>Nome:</label>
                            <input type="text" name="nome" id="nome" class="form-control input-block-level" value="{{ form.nome.data or '' }}" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <label>Título:</label>
                            <input type="text" name="titulo" id="titulo" class="form-control input-block-level" value="{{ form.titulo.data or '' }}" />
                        </div>
                     </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label>Escala:</label>
                            <input type="text" name="escala" id="escala" class="form-control input-block-level" value="{{ form.escala.data or '' }}" />
                        </div>
                        <div class="col-md-3">
                            <label>Formato:</label>
                            <select name="formato" id="formato" class="form-control input-block-level">
                                <option value=""></option>
                                {% set formats = ['A4', 'A3', 'A2','A1','A0'] %}
                                {% for f in formats %}
                                <option value="{{ f }}" {% if f == form.formato.data %}selected{% endif %}>{{ f }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Orientação:</label>
                            <select name="orientacao" id="orientacao" class="form-control input-block-level">
                                <option value=""></option>
                                {% set orientations = ['Retrato', 'Paisagem'] %}
                                {% for o in orientations %}
                                <option value="{{ o }}" {% if o == form.orientacao.data %}selected{% endif %}>{{ o }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <label>Sistema de Coordenadas:</label>
                            <select name="srid" id="srid" class="form-control input-block-level">
                                <option value=""></option>
                                {% for cs in coord_sys %}
                                <option value="{{ cs.srid }}" {% if cs.srid == form.srid.data %}selected{% endif %}>{{ cs.nome }} ({{ cs.codigo }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-12">
                            <label>Descrição:</label>
                            <textarea name="descricao" id="descricao" class="form-control input-block-level" rows="4">{{ form.descricao.data or '' }}</textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1">
                        </div>
                        <div class="col-md-4">
                            <label>&nbsp;</label>
                            <label class="checkbox">
                                <input name="activo" type="checkbox" value="{{ form.activo.data or '' }}" {% if form.activo.data %}checked{% endif %} />{{ form.activo.label.text }}
                            </label>
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <label class="checkbox">
                                <input name="identificacao" type="checkbox" value="{{ form.identificacao.data or '' }}" {% if form.identificacao.data %}checked{% endif %} />{{ form.identificacao.label.text }}
                            </label>
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <label class="checkbox">
                                <input name="tituloEmissao" type="checkbox" value="{{ form.tituloEmissao.data or '' }}" {% if form.tituloEmissao.data %}checked{% endif %} />{{ form.tituloEmissao.label.text }}
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1">
                        </div>
                        <div class="col-md-4">
                            <label class="checkbox">
                                <input name="marcacaoLocal" type="checkbox" value="{{ form.marcacaoLocal.data or '' }}" {% if form.marcacaoLocal.data %}checked{% endif %} />{{ form.marcacaoLocal.label.text }}
                            </label>
                        </div>
                        <div class="col-md-3">
                            <label class="checkbox">
                                <input name="desenharLocal" type="checkbox" value="{{ form.desenharLocal.data or '' }}" {% if form.desenharLocal.data %}checked{% endif %} />{{ form.desenharLocal.label.text }}
                            </label>
                        </div>
                        <div class="col-md-3">
                            <label class="checkbox">
                                <input name="multiGeom" type="checkbox" value="{{ form.multiGeom.data or '' }}" {% if form.multiGeom.data %}checked{% endif %} />Múltiplas Geometrias
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1">
                        </div>
                        <div class="col-md-4">
                            <label class="checkbox">
                                <input name="emissaoLivre" type="checkbox" value="{{ form.emissaoLivre.data or '' }}" {% if form.emissaoLivre.data %}checked{% endif %} />Emissão Livre
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="padding-left: 25px">
                <div class="col-md-4">
                    <!--<label>&nbsp;</label>-->
                    <label class="checkbox">
                        <input name="autorEmissao" type="checkbox" value="{{ form.autorEmissao.data or '' }}" {% if form.autorEmissao.data %}checked{% endif %} />{{ form.autorEmissao.label.text }}
                    </label>
                </div>
                <div class="col-md-4">
                    <!--<label>&nbsp;</label>-->
                    <label class="checkbox">
                        <input name="guiaPagamento" type="checkbox" value="{{ form.guiaPagamento.data or '' }}" {% if form.guiaPagamento.data %}checked{% endif %} />{{ form.guiaPagamento.label.text }}
                    </label>
                </div>
                <div class="col-md-4">
                    <!--<label>&nbsp;</label>-->
                    <label class="checkbox">
                        <input name="finalidadeEmissao" type="checkbox" value="{{ form.finalidadeEmissao.data or '' }}" {% if form.finalidadeEmissao.data %}checked{% endif %} />{{ form.finalidadeEmissao.label.text }}
                    </label>
                </div>
            </div>

            {% if record and record.id > 0 %}

            <div class="row" style="padding-top: 20px">
                <div class="col-md-12">
                    <div class="row">
                        <div>
                          <!-- Nav tabs -->
                          <ul class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="active"><a href="#tab-configuracao" aria-controls="tab-configuracao" role="tab" data-toggle="tab">Configuracao</a></li>
                            <li role="presentation"><a href="#tab-layouts" aria-controls="tab-layouts" role="tab" data-toggle="tab">Layouts</a></li>
                          </ul>

                          <!-- Tab panes -->
                          <div class="tab-content">
                            <div role="tabpanel" class="tab-pane active" id="tab-configuracao">
                                <textarea name="configuracao" id="configuracao" class="form-control input-block-level" rows="18">{{ form.configuracao.data or '' }}</textarea>
                            </div>
                            <div role="tabpanel" class="tab-pane" id="tab-layouts">

                                <div style="margin-top: 10px;" />

                                <div class="panel panel-default">
                                    <div style="text-align: right; margin-top: 10px; margin-right: 10px">
                                        <a href="{{ url_for('backoffice.plantas_layouts_create', planta_id=record.id) }}" class="push"><i class="fa fa-plus"></i> Novo Layout</a>
                                    </div>
                                    <table class="table table-striped table-hover">
                                        <thead>
                                        <tr>
                                            <th>Formato</th>
                                            <th>Orientação</th>
                                            <th>Configuração</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for layout in record.layouts %}
                                        <tr>
                                            <td>{{ layout.formato or '' }}</td>
                                            <td>{{ layout.orientacao or '' }}</td>
                                            <td></td>
                                            <td style="width: 50px; min-width: 40px">
                                                <a href="{{ url_for('backoffice.plantas_layouts_edit', id=layout.id) }}"><i class="fa fa-pencil"></i></a>
                                                <a href="#"  data-id="{{ layout.id }}" data-action="{{ url_for('backoffice.plantas_layouts_delete', id=layout.id) }}" class="btn-layout-delete delete-confirm" title="Eliminar"><i class="fa fa-trash"></i></a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                          </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-bottom: 20px">
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">Grupos de Plantas</div>
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Codigo</th>
                                <th>Título</th>
                                <th>Descrição</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for tipo in record.tipos_plantas %}
                            <tr>
                                <td>{{ tipo.codigo or '' }}</td>
                                <td>{{ tipo.titulo or '' }}</td>
                                <td>{{ tipo.descricao or '' }}</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">Mapas</div>
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Codigo</th>
                                <th>Título</th>
                                <th>Descrição</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for mapa in record.mapas %}
                            <tr>
                                <td>{{ mapa.codigo or '' }}</td>
                                <td>{{ mapa.titulo or '' }}</td>
                                <td>{{ mapa.descricao or '' }}</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="row" style="padding-top: 20px">

                <div class="col-md-12">
                    <!--
                    <div class="row">

                        <div class="col-md-9">
                            <label>Template:</label>
                            <div class="input-group">
                                @Html.TextBox("TemplateFile", Model.Template, new { @class = "form-control", disabled = "disabled" })
                                <span class="input-group-btn">
                                    <button class="btn" type="button" title="@T("Remover")" id="btnRemoveTemplateFile"><i class="fa fa-remove"></i></button>
                                </span>
                                <span class="input-group-btn">
                                    <button class="btn" type="button" title="@T("Ver")" id="btnViewTemplateFile" data-action="@Url.Action("ViewTemplate", "Plantas", new { file = "" })"><i class="fa fa-file"></i></button>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label style="display: block">&nbsp;</label>
                            <a href="#" id="btnAddTemplateFile" data-target="#divAddTemplateFile">Escolher Ficheiro</a>
                        </div>
                    </div>
                    <div class="row" id="divAddTemplateFile">
                        <div class="col-md-9 progress hide" style="margin-top: 10px">
                            <div class="bar"></div >
                            <div class="percent">0%</div >
                        </div>
                        <div class="col-md-10 status hidde">
                        </div>
                    </div>
                    -->
                    <div class="row">
                        <div class="col-md-12">
                            <label>Configuração:</label>
                            <textarea name="configuracao" id="configuracao" class="form-control input-block-level" rows="18">{{ form.configuracao.data or '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div style="margin-bottom: 50px">
            </div>

            <div class="row">
                <div class="col-md-12" style="text-align: right">
                    <button type="button" class="btn btn-default" onclick="location.href='{{ url_for('backoffice.plantas') }}'" >Voltar</button>
                    <button type="submit" class="btn btn-primary">Gravar</button>
                </div>
            </div>

        </fieldset>

        <div style="margin-bottom: 50px">
        </div>

    </form>
</div>
{% endblock %}

{% block post_script %}

<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        confirmModal: function (options) {
            var html = '<div class="modal fade" id="confirmContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div>' +
            '<div class="modal-body">#Body#</div><div class="modal-footer">' +
            '<a href="#" class="btn btn-default" id="confirmYesBtn">Sim</a>' +
            '<button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button></div></div><div>';

            var defaults = {
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o registo?',
                btnClass: 'btn-danger',
                callback: null
            };

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body);
            $(this).html(html);
            $('#confirmYesBtn', this).addClass(options.btnClass);
            $('#confirmContainer', this).modal('show');
            var context = $(this);
            $('#confirmYesBtn', this).click(function () {
                $("#confirmContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>

<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        informationModal: function (options) {
            var html = '<div class="modal fade" id="infoContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div><div class="modal-body">' +
            '<div class="#MessageClass#">#Body#</div></div><div class="modal-footer">' +
            '<a href="#" class="btn btn-primary" data-dismiss="modal" id="infoCloseButton">Fechar</a></div></div><div>';

            var defaults = {
                heading: 'Informação',
                body: '',
                messageClass: 'alert alert-info',
                callback: null
            };

            $('#infoCloseButton', this).unbind();
            $('#informationDiv').unbind();

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body).replace('#MessageClass#', options.messageClass);

            $(this).html(html);
            $("#infoContainer", this).modal('show');
            var context = $(this);
            $('#infoCloseButton', this).click(function () {
                $("#infoContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>


<script type="text/javascript">
    $(function () {

        var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('configuracao'), {
            mode: {name: "javascript", json: true},
            lineNumbers: true,
            matchBrackets: true,
            continueComments: "Enter",
            extraKeys: {"Ctrl-Q": "toggleComment"}
        });

        //Form submit
        $('form').submit(function (e) {
            var form = this;

            index = 0;
            $('#lroles option').each(function () {
                var input = $("<input>").attr("type", "hidden").attr("name", "RolesList-" + index).val($(this).attr("value"));
                $(form).append($(input));
                index = index + 1;
            });
        });

        $("#btnShowConfig").click(function () {
            var id = $("#configuracao").val();
            $.ajax({
                type: 'POST',
                url: $(this).attr("data-action"),
                //data: "id=" + id + "&__RequestVerificationToken=@Html.AntiForgeryTokenValueOrchard()",
                success: function (r) {
                    if (r.Success) {
                        var html = r.Message;
                        html = html.replace(/\n/g, "<br />").replace(/\r\n/g, "<br />").replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;'); ;

                        $("#contentDiv").contentModal({
                            heading: '@T("Configuração")',
                            body: '<div>' + html + '</div>',
                            callback: function () {
                            }
                        });
                    } else {
                        $("#informationDiv").informationModal({
                            heading: '@T("Informação")',
                            body: r.Message,
                            messageClass: 'alert alert-danger',
                            callback: function () {
                            }
                        });
                    }
                },
                error: function (r) {
                    $("#informationDiv").informationModal({
                        heading: 'Informação',
                        body: 'Ocorreu um erro',
                        messageClass: 'alert alert-danger',
                        callback: function () {
                        }
                    });
                }
            });

            return false;
        });

        //Button AddRole event
        $('#btnAddRole').click(function (e) {
            var value = $('#ddlRoles').val();
            var text = $('#ddlRoles option:selected').text();
            if ($("#lroles option[value='" + value + "']").length == 0) {
                $('#lroles').append($('<option>', {
                    value: value,
                    text: text
                }));
            } else {
                $("#btnAddRole").tooltip({ title: 'O perfil já foi adicionado'});
                $("#btnAddRole").tooltip('show');
            }
        }).mouseout(function() {
            $("#btnAddRole").tooltip('destroy');
        });
        $('#btnRemoveRole').click(function (e) {
            var targetId = $(this).attr('data-target');
            $(targetId + ' option:selected').remove();
        });
        $('#btnClearRoles').click(function (e) {
            var targetId = $(this).attr('data-target');
            $(targetId + ' option').remove();
        });

        $(".btn-layout-delete.delete-confirm").click(function () {
            var url = $(this).attr("data-action");
            var id = $(this).attr("data-id");
            $("#confirmDiv").confirmModal({
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o registo?',
                callback: function () {
                    $.ajax({
                        type: 'POST',
                        url: url,
                        data: "id=" + id,
                        success: function (r) {
                            if (r.Success) {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: 'O registo foi eliminado com sucesso.',
                                    messageClass: "alert alert-success",
                                    callback: function () {
                                        window.location.reload();
                                    }
                                });
                            } else {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: '<strong>Não foi possível eliminar o registo!</strong> ' + r.Message,
                                    messageClass: 'alert alert-danger',
                                    callback: null
                                });
                            }
                        },
                        error: function (r) {
                            $("#informationDiv").informationModal({
                                heading: 'Informação',
                                body: '<strong>Não foi possível eliminar o registo!</strong> ' + r.Message,
                                messageClass: 'alert alert-danger',
                                callback: function () {
                                    $("form").submit();
                                }
                            });
                        }
                    });
                }
            });
        });


    });
</script>
{% endblock %}


