{% extends "backoffice/_layout.html" %}
{% from "_custom_macros.html" import render_pagination_summary, render_pagination %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Mapas<i class="fa fa-long-arrow-right  fa-fw" aria-hidden="true"></i>Configurações</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>


<div id="confirmDiv" >
</div>
<div id="informationDiv" >
</div>


<div class="module-content">
    <div class="panel-group" id="searchCatalog">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a data-toggle="collapse" data-parent="#searchCatalog" href="#collapseOne">Pesquisa</a>
            </div>
            <!--<div id="collapseOne" class="panel-collapse collapse @((Model.showSearchArea) ? "in" : "")">-->
            <div id="collapseOne" class="panel-collapse collapse">
                <div class="panel-body">
                    <form action="" method="POST">
                      {{ form.csrf_token }}
                      <input type="hidden" name="page" id="page" value="{{ form.page.data or '' }}" />
                      <input type="hidden" name="orderField" id="orderField" value="{{ form.orderField.data or '' }}" />
                      <input type="hidden" name="sortOrder" id="sortOrder" value="{{ form.sortOrder.data or '' }}" />
                      <fieldset>
                          <div class="row">
                            <div class="col-md-1">
                                <label>Id:</label>
                                <input type="text" name="id" id="id" class="form-control input-block-level" value="{{ form.id.data or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label>Título:</label>
                                <input type="text" name="titulo" id="titulo" class="form-control input-block-level" value="{{ form.titulo.data or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label>Mapa:</label>
                                <input type="text" name="mapa" id="mapa" class="form-control input-block-level" value="{{ form.mapa.data or '' }}">
                            </div>
                            <div class="col-md-2">
                                <label style="display:block">&nbsp;</label>
                                <button type="submit" class="btn btn-primary" id="pesquisar" name="pesquisar" value="true">Pesquisar</button>
                            </div>
                          </div>
                      </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="panel-group" id="resultsCatalog">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a data-toggle="collapse" data-parent="#resultsCatalog" href="#collapseTwo">Resultados</a>
            </div>
            <!--<div id="collapseTwo" class="panel-collapse collapse @((Model.showResultsArea) ? "in" : "")">-->
            <div id="collapseTwo" class="panel-collapse collapse in">
                <div class="panel-body">
                    <div style="text-align: right; margin-right: 10px">
                        <a href="{{ url_for('backoffice.mapas_config_create') }}" class="push"><i class="fa fa-plus"></i> Nova Configuração</a>
                    </div>

                    {% if records %}
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <!--<th data-field="Id" class="columnheader @(Model.orderField == "Id" ? "sorting_" + Model.sortOrder : "sorting")">@T("Id")</th>
                                <th data-field="Titulo" class="columnheader @(Model.orderField == "Titulo" ? "sorting_" + Model.sortOrder : "sorting")">@T("Título")</th>-->
                                <th data-field="id" class="columnheader {%if form.orderField.data == 'id' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Id</th>
                                <th data-field="titulo" class="columnheader {%if form.orderField.data == 'titulo' %}sorting_{{ form.sortOrder.data }}{% else %}sorting{% endif %}">Título</th>
                                <th>Definição</th>
                                <th>Mapas</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.id }}</td>
                                <td>{{ record. titulo }}</td>
                                <td><a class="mapconfig" href="#" data-action="{{ url_for('backoffice.mapas_config_get', id=record.id) }}">Ver definição</a></td>
                                <td>
                                    {% for mapa in record.mapas %}
                                        <span class="badge" title="{{mapa.titulo}}">{{ mapa.codigo }}</span>
                                    {% endfor %}
                                </td>
                                <td style="width: 50px; min-width: 40px">
                                    <a href="{{ url_for('backoffice.mapas_config_edit', id=record.id) }}"><i class="fa fa-pencil"></i></a>
                                    <a href="#" data-id="{{ record.id }}" data-action="{{ url_for('backoffice.mapas_config_delete', id=record.id) }}" class="delete-confirm" title="Eliminar"><i class="fa fa-trash"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        {% if pagination %}
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="dataTables_info" id="dataTables-example_info" role="status" aria-live="polite" style="padding: 8px">
                                    {{ render_pagination_summary(pagination) }}
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="dataTables_paginate paging_simple_numbers" style="text-align: right">
                                    {{ render_pagination(pagination) }}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    {% else %}
                        <div style="padding: 5px">
                            <div class="alert alert-warning">
                                Não foram encontrados registos!
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block post_script %}
<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        confirmModal: function (options) {
            var html = '<div class="modal fade" id="confirmContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-dialog modal-lg" role="document">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div>' +
            '<div class="modal-body">#Body#</div><div class="modal-footer">' +
            '<a href="#" class="btn btn-default" id="confirmYesBtn">Sim</a>' +
            '<button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button></div></div></div><div>';

            var defaults = {
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o registo?',
                btnClass: 'btn-danger',
                callback: null
            };

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body);
            $(this).html(html);
            $('#confirmYesBtn', this).addClass(options.btnClass);
            $('#confirmContainer', this).modal('show');
            var context = $(this);
            $('#confirmYesBtn', this).click(function () {
                $("#confirmContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>

<script type="text/javascript">
(function ($) {
    $.fn.extend({
        //pass the options variable to the function
        informationModal: function (options) {
            var html = '<div class="modal fade" id="infoContainer" tabindex="-1" role="dialog" aria-hidden="true">' +
            '<div class="modal-dialog modal-lg" role="document">' +
            '<div class="modal-content">' +
            '<div class="modal-header"><a class="close" data-dismiss="modal">×</a>' +
            '<h3>#Heading#</h3></div><div class="modal-body">' +
            '<div class="#MessageClass#">#Body#</div></div><div class="modal-footer">' +
            '<a href="#" class="btn btn-primary" data-dismiss="modal" id="infoCloseButton">Fechar</a></div></div></div><div>';

            var defaults = {
                heading: 'Informação',
                body: '',
                messageClass: 'alert alert-info',
                callback: null
            };

            $('#infoCloseButton', this).unbind();
            $('#informationDiv').unbind();

            var options = $.extend(defaults, options);
            html = html.replace('#Heading#', options.heading).replace('#Body#', options.body).replace('#MessageClass#', options.messageClass);

            $(this).html(html);
            $("#infoContainer", this).modal('show');
            var context = $(this);
            $('#infoCloseButton', this).click(function () {
                $("#infoContainer", context).modal('hide');

                if (options.callback != null)
                    options.callback();
            });
        }
    });
})(jQuery);
</script>

<script type="text/javascript">
    $(function () {

        $(".columnheader").click(function () {
            $("#orderField").attr("value", $(this).attr("data-field"));

            if ($(this).hasClass("sorting_asc"))
                $("#sortOrder").attr("value", "desc");
            else
                $("#sortOrder").attr("value", "asc");

            $("#page", "form").val("1");

            $("form").submit();
        });

        $("a", ".paginate_button").click(function () {
            page = $(this).data("page");

            $("#page", "form").val(page);
            $("form").submit();
        });

        $(".mapconfig").click(function () {
            $.ajax({
                url: $(this).data('action'),
                method: 'get',
                dataType: 'json'
            }).then(function(res){
                return { result: res };
            }).fail(function(res){
                var err = res; //return { result: res};
            }).always(function(jqXHR, textStatus) {

                var opts = {
                        heading: 'Configuração',
                        body: '',
                        messageClass: "alert alert-text"
                    };

                if (jqXHR.result) {
                    if (jqXHR.result.Success) {
                        opts.body = jqXHR.result.Message;
                        opts.messageClass = 'info info-text';
                    } else {
                        opts.body = jqXHR.result.Message;
                    }
                } else {
                    opts.body = 'Ocorre um erro ao obter a configuração.';
                    opts.messageClass = 'info info-text';
                }

                $("#informationDiv").informationModal(opts);
            });
        });

        $(".delete-confirm").click(function () {
            var url = $(this).attr("data-action");
            var id = $(this).attr("data-id");
            $("#confirmDiv").confirmModal({
                heading: 'Eliminar registo',
                body: 'Deseja eliminar o registo?',
                callback: function () {
                    $.ajax({
                        type: 'POST',
                        url: url,
                        data: "id=" + id,
                        success: function (r) {
                            if (r.Success) {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: 'O registo foi eliminado com sucesso.',
                                    messageClass: "alert alert-success",
                                    callback: function () {
                                        $("form").submit();
                                    }
                                });
                            } else {
                                $("#informationDiv").informationModal({
                                    heading: 'Informação',
                                    body: '<strong>Não foi possível eliminar o registo!</strong> ' + r.Message,
                                    messageClass: 'alert alert-danger',
                                    callback: null
                                });
                            }
                        },
                        error: function (r) {
                            $("#informationDiv").informationModal({
                                heading: 'Informação',
                                body: '<strong>Não foi possível eliminar o registo!</strong> ' + r.Message,
                                messageClass: 'alert alert-danger',
                                callback: function () {
                                    $("form").submit();
                                }
                            });
                        }
                    });
                }
            });
        });

    });
</script>

{% endblock %}