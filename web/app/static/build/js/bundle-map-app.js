window.app||(window.app={});var app=window.app;app.LayersControl=function(e){this.defaultGroup="default",this.generateID=function(){return l()+l()+l()+l()+l()+l()+l()+l()};var t=e||{},a=document.createElement("div");a.className="layers-control";var o=document.createElement("div");o.className="toc-header";var r=$('<a href="#" class="hide-all-layers" />').appendTo(o);r.click([this],function(e){return e.preventDefault,e.data[0].hideAllLayers(),!1}),$('<i class="fa fa-low-vision" aria-hidden="true"></i>').appendTo(r),$("<span> Desligar todos os temas</span>").appendTo(r),a.appendChild(o);var n=document.createElement("div");n.className="toc-container",a.appendChild(n);var i=document.createElement("ul");function l(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}i.className="toc-group",n.appendChild(i),this.root=i,this.rootLayer=null,this.getLayerById=function(e,t){if(e.get("layer-id")==t)return e;if(e instanceof ol.layer.Group){var a=e.getLayers(),o=null;return a.forEach(function(e){if(e.get("layer-id")==t)return o=e;this_.getLayerById(e,t)}),o}},this_=this,this_.styleRestrictedScales=t.styleRestrictedScales||!1,this_.parentLayerVisible=t.parentLayerVisible||!1,this_.wms=t.wms,this_.panelInfoTitle=t.panelInfoTitle||"Informação de Tema",this_.panelInfoWindow=null,this_.openPanelInfo=function(e){var t=e.get("info"),a=t.link,o=t.title||null;return o&&(o=o.replace("{title}",e.get("title"))),$.jsPanel({id:this_.generateID(),position:{my:"center-top",at:"center-top",offsetX:0,offsetY:0},panelSize:{width:800,height:600},headerTitle:o||this_.panelInfoTitle||"Informação de Tema",contentOverflow:{horizontal:"hidden",vertical:"auto"},contentAjax:{url:a,autoload:!0,done:function(e,t,a,o){console.log("teste")}},callback:function(){console.log("teste")},onclosed:this_.panelInfoOnClosed,dragit:{containment:"window"},resizeit:{start:function(e,t){},stop:function(e,t){}}})},this_.panelInfoOnClosed=function(e){this_.panelInfoWindow=null,$(this).remove()},this_.refreshScalesRestriction=function(e){var t=this.getResolution(),a=this.getProjection().getUnits(),o=ol.proj.METERS_PER_UNIT[a],r=t*o*39.37*(25.4/.28);$("li[data-layer-id]",".layers-control").each(function(e){var a=$(this).data("layer-ol");if($(this).removeClass("scale-hidden"),a&&((a.getMinResolution()>t||a.getMaxResolution()<t)&&$(this).addClass("scale-hidden"),a.get("capability"))){var o=a.get("capability").minScale||1/0;((a.get("capability").maxScale||0)>r||o<r)&&$(this).addClass("scale-hidden")}if(a instanceof ol.layer.Group&&a.get("single")&&1==a.get("single")){for(var n,i,l=a.getLayersArray(),s=0;s<l.length;s++){var c=l[s];(null==n||c.getMinResolution()<=n)&&(n=c.getMinResolution()),(null==i||c.getMaxResolution()>=i)&&(i=c.getMaxResolution())}(n>t||i<t)&&$(this).addClass("scale-hidden")}})},this_.refreshLayersLegend=function(e){var t=this.getResolution(),a=this.getProjection().getUnits(),o=t*ol.proj.METERS_PER_UNIT[a]*39.37*(25.4/.28);$("div[data-min-scale], div[data-max-scale]",".layer-legend").each(function(e){var t=$(this).data("max-scale")||0,a=$(this).data("min-scale")||0;o>=t&&(0==a||o<=a)?$(this).show():$(this).hide()}),$("img.layer-wms-legend",".layer-legend").each(function(e){var t,a,r=$(this).attr("src");$(this).attr("src",(t="scale",a=o,r.replace(new RegExp("([?&]"+t+"(?=[=&#]|$)[^#&]*|(?=#|$))"),"&"+t+"="+encodeURIComponent(a)).replace(/^([^?&]+)&/,"$1?")))})},this_.setParentLayerVisible=function(e){if(e.get("parent-layer")){var t=e.get("parent-layer");t.set("visible",!0),this_.setParentLayerVisible(t)}},ol.control.Control.call(this,{element:a,target:t.target})},ol.inherits(app.LayersControl,ol.control.Control),app.LayersControl.prototype.setMap=function(e){ol.control.Control.prototype.setMap.call(this,e);for(var t=null,a=e.getLayers().getArray(),o=0,r=a.length;o<r;++o){if("toc-root-group"==(n=a[o]).get("group")){t=n;break}}if(t)for(o=(a=t.getLayers().getArray()).length-1,r=0;o>=r;--o){var n;(n=a[o])instanceof ol.layer.Group?n.get("single")&&1==n.get("single")?this.addLayerToList(n,this.root,0,t):this.addLayerGroupToList(n,this.root,0,t):this.addLayerToList(n,this.root,0,t)}this.rootLayer=t;var i=this.rootLayer.getLayers();i.on("add",function(e){var t=e.element;t instanceof ol.layer.Group?this.addLayerGroupToList(t,null,0):this.addLayerToList(t,null,0),this.styleRestrictedScales&&this.refreshScalesRestriction.apply(this.map_.getView(),null)},this),i.on("remove",function(e){var t=e.element;$('li[layer-id="'+t.get("layer-id")+'"]').remove()},this),e.getView().on("change:resolution",this_.refreshLayersLegend),this.styleRestrictedScales&&(e.getView().on("change:resolution",this_.refreshScalesRestriction),this.refreshScalesRestriction.apply(e.getView(),null))},app.LayersControl.prototype.addLayerToList=function(e,t,a,o,r){var n=this.generateID();e.set("layer-id",n),r&&e.set("parent-layer",r),r&&r.get("exclusive")&&1==r.get("exclusive")?e.set("exclusive",!0):e.set("exclusive",!1),e.on("change:visible",function(e){var t=this,a=this.get("visible"),o=$('li[data-layer-id="'+t.get("layer-id")+'"]'),r=$("span.icon.layer-visibility-icon",o);if(a){if(t.get("exclusive")){if(r.hasClass("exclusive-hidden-icon")&&r.removeClass("exclusive-hidden-icon"),r.hasClass("exclusive-visible-icon")||r.addClass("exclusive-visible-icon"),t.get("parent-layer"))t.get("parent-layer").getLayers().forEach(function(e){e.get("layer-id")!=t.get("layer-id")&&e.setVisible(!1)})}else r.hasClass("hidden-icon")&&r.removeClass("hidden-icon"),r.hasClass("visible-icon")||r.addClass("visible-icon");this_.parentLayerVisible&&this_.setParentLayerVisible(t)}else t.get("exclusive")?(r.hasClass("exclusive-visible-icon")&&r.removeClass("exclusive-visible-icon"),r.hasClass("exclusive-hidden-icon")||r.addClass("exclusive-hidden-icon")):(r.hasClass("visible-icon")&&r.removeClass("visible-icon"),r.hasClass("hidden-icon")||r.addClass("hidden-icon"))});var i=e.get("toc")||null,l=document.createElement("li");l.className="toc-group-item",i&&null!=i.visible&&!i.visible&&(l.className+=" toc-group-item-hidden"),null==o||o||(l.style.display="none"),$(l).data("layer-ol",e);var s=document.createAttribute("data-layer-id");s.value=n,l.setAttributeNode(s),(s=document.createAttribute("data-level")).value=a,l.setAttributeNode(s);var c=document.createElement("div");c.className="left-icon-block";for(var d=0;d<a;d++)$('<span class="indent" />').appendTo(c);var u="hidden-icon";r&&r.get("exclusive")&&1==r.get("exclusive")?(u="exclusive-hidden-icon",e.get("visible")&&(u="exclusive-visible-icon")):e.get("visible")&&(u="visible-icon"),i&&"visibility"in i&&!i.visibility?$('<span class="icon layer-visibility-icon" />').addClass(c).addClass("disabled-icon").appendTo(c):$('<span class="icon layer-visibility-icon" />').addClass(u).click([map,e],function(e){e.preventDefault();e.data[0];var t=e.data[1];t.get("visible")?t.set("visible",!1):t.set("visible",!0)}).appendTo(c),$(c).appendTo(l);var p=document.createElement("div");e.get("extent_layer")?(p.className="title-block extent",p.setAttribute("title","Localizar"),$(p).click([map,e],function(t){if(e.get("extent_layer")&&e.get("extent_layer").bounds){var a=Portal.Viewer.getPolygonFromExtent(e.get("extent_layer").bounds).transform(e.get("extent_layer").projection,map.getView().getProjection().getCode());map.getView().fit(a.getExtent(),map.getSize())}})):p.className="title-block",$("<span />").html(e.get("title")).appendTo(p),$(p).appendTo(l);var g=document.createElement("div");g.className="button-block";var f=!1;if(i&&"properties"in i&&!i.properties||(i&&"transparency"in i&&!i.transparency||(f=!0),i&&"remove"in i&&!i.remove||(f=!0)),f&&$('<span class="tool" title="Propriedades"><i class="fa fa-ellipsis-v" /></span>').click([map,e],function(e){var t=$(this).parent().nextAll("div.layer-properties");$("div.layers-control span.tool").not(this).removeClass("active"),$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active"),$("div.layer-extra").not(t).each(function(){$(this).hide()}),t.toggle()}).appendTo(g),e.get("info")&&$('<span class="tool" title="Informação"><i class="fas fa-info-circle" /></span>').click([map,e],function(t){var a=e.get("info"),o=a.link;a.mode&&"external"==a.mode?window.open(o,"_blank").focus():this_.panelInfoWindow?(this_.panelInfoWindow.close(),this_.panelInfoWindow=this_.openPanelInfo(e)):this_.panelInfoWindow=this_.openPanelInfo(e)}).appendTo(g),i&&"legend"in i&&!i.legend||$('<span class="tool" title="Legenda"><i class="fa fa-list" /></span>').click([map,e],function(e){var t=$(this).parent().nextAll("div.layer-legend");$("div.layers-control span.tool").not(this).removeClass("active"),$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active"),$("div.layer-extra").not(t).each(function(){$(this).hide()}),t.toggle()}).appendTo(g),$(g).appendTo(l),e.get("data")){var m=$('<div class="layer-extra-data" />');(w=$(e.get("data").html||"")).appendTo(m),m.appendTo(l)}if(f){var h=$('<div class="layer-extra layer-properties" />');if(!i||!("transparency"in i)||i.transparency){var v=$('<div class="layer-opacity-slider">')[0],y=100*e.getOpacity();noUiSlider.create(v,{start:[y],range:{min:[0],max:[100]}}),v.noUiSlider.on("slide",function(t){var a=this.get()/100;e.setOpacity(a)});var w=$('<div class="layer-opacity"><label>Transparência:</label></div>');$(v).appendTo(w),w.appendTo(h)}i&&"remove"in i&&!i.remove||$('<span class="tool" title="Remover do mapa">Remover</span>').click([map,e],function(e){var t=$(this).closest(".toc-group-item"),a=function(e,t,r){var n=e;t=t;if(n.get("layer-id")!=t){if(n instanceof ol.layer.Group){var i=n.getLayers();i.forEach(function(e){return e.get("layer-id")==t?void i.remove(e):void a(e,t,n)})}}else r?r.remove(n):o.removeLayer(n)},o=e.data[0],r=e.data[1].get("layer-id");o.getLayers().forEach(function(e){a(e,r,null)}),$(t).remove()}).appendTo(h),h.appendTo(l)}if(e.get("legend")&&e.get("legend").html)!function(e,t){var a=$('<div class="layer-extra layer-legend" />');a.html(e.get("legend").html||""),e.get("legend")&&e.get("legend").title&&a.prepend('<div class="layer-legend-title">'+e.get("legend").title+"</div>"),a.appendTo(t)}(e,l);else{var b=null;e.getSource&&(b=e.getSource()),b instanceof ol.source.TileWMS||b instanceof ol.source.ImageWMS?function(e,t){var a=e.getSource(),o=null,r=$('<div class="layer-extra layer-legend" />');if(e.get("capability")&&e.get("capability").styles)for(var n=0;n<e.get("capability").styles.length;n++)"default"==e.get("capability").styles[n].name.toLocaleLowerCase()&&e.get("capability").styles[n].legend&&e.get("capability").styles[n].legend.href&&(o=e.get("capability").styles[n].legend.href);o||(a.getUrl?o=a.getUrl():a.getUrls&&(o=a.getUrls()[0]),o&&(o.indexOf("?")<0&&(o+="?"),o=o+"SERVICE=WMS&REQUEST=GetLegendGraphic&LAYER="+a.getParams().LAYERS,o+="&FORMAT=image/png",a.getParams().SLD?o=o+"&SLD="+a.getParams().SLD:a.getParams().STYLES&&(o=o+"&STYLE="+a.getParams().STYLES),a.getParams().VERSION&&(o=o+"&VERSION="+a.getParams().VERSION))),o&&(this_.wms&&this_.wms.legendOptions?o=o+"&LEGEND_OPTIONS="+this_.wms.legendOptions:e.get("legend")&&e.get("legend").wms&&e.get("legend").wms.legendOptions&&(o=o+"&LEGEND_OPTIONS="+e.get("legend").wms.legendOptions),this_.wms&&this_.wms.rule?o=o+"&RULE="+this_.wms.rule:e.get("legend")&&e.get("legend").wms&&e.get("legend").wms.rule&&(o=o+"&RULE="+e.get("legend").wms.rule)),o&&("https:"===window.location.protocol&&"http"==$.url(o).attr("protocol")&&(o=OpenLayers.ProxyHost+function(e){var t=e.split("?");return encodeURIComponent(t[0]+"?"+t[1])}(o)),e.get("dynamicLegend")?r.html('<img class="layer-wms-legend" src="'+o+'" />'):r.html('<img src="'+o+'" />'));e.get("legend")&&e.get("legend").title&&r.prepend('<div class="layer-legend-title">'+e.get("legend").title+"</div>"),r.appendTo(t)}(e,l):(b instanceof ol.source.TileArcGISRest||b instanceof ol.source.ImageArcGISRest)&&function(e,t){var a=e.getSource(),o=null;a.getUrl?o=a.getUrl():a.getUrls&&(o=a.getUrls()[0]),$.ajax({type:"GET",dataType:"json",url:o+"/legend",data:{f:"json"},parametersData:{layer:e,item:t},beforeSend:function(){},success:function(e){var a=this.parametersData.layer,o=a.getSource(),r=null;if(o.getParams()){var n=o.getParams();for(var i in n)if(n.hasOwnProperty(i)&&"layers"==(i+"").toLowerCase()){n[i]&&""!=n[i]&&(r=(n[i].indexOf(":")>=0?n[i].split(":")[1]:n[i]).split(","));break}if(e.layers){var l="";if(r&&r.length>0){for(var s=0;s<e.layers.length;s++)for(var c=0;c<r.length;c++)if(r[c]==e.layers[s].layerId+""){l+="<div data-min-scale='"+(u=e.layers[s]).minScale+"' data-max-scale='"+u.maxScale+"'><div>"+u.layerName+"</div>",l+="<ul>";for(var d=0;d<u.legend.length;d++)l+="<li><img src='data:"+(p=u.legend[d]).contentType+";base64,"+p.imageData+"'><span>"+p.label+"</span></li>";l+="</ul></div>";break}}else for(s=0;s<e.layers.length;s++){var u;for(l+="<div data-min-scale='"+(u=e.layers[s]).minScale+"' data-max-scale='"+u.maxScale+"'><div>"+u.layerName+"</div>",l+="<ul>",d=0;d<u.legend.length;d++){var p;l+="<li><img src='data:"+(p=u.legend[d]).contentType+";base64,"+p.imageData+"'><span>"+p.label+"</span></li>"}l+="</ul></div>"}var g=$('<div class="layer-extra layer-legend" />');g.html(l),a.get("legend")&&a.get("legend").title&&g.prepend('<div class="layer-legend-title">'+a.get("legend").title+"</div>"),g.appendTo(t)}}},complete:function(){},error:function(e){}})}(e,l)}t?t.appendChild(l):this.root.firstChild?this.root.insertBefore(l,this.root.firstChild):this.root.appendChild(l)},app.LayersControl.prototype.addLayerGroupToList=function(e,t,a,o,r){var n=this.generateID();e.set("layer-id",n),r&&e.set("parent-layer",r),r&&r.get("exclusive")&&1==r.get("exclusive")?e.set("exclusive",!0):e.set("exclusive",!1),e.on("change:visible",function(e){var t=this,a=this.get("visible"),o=$('li[data-layer-id="'+t.get("layer-id")+'"]'),r=$("span.icon.layer-visibility-icon",o);if(a){if(t.get("exclusive")){if(r.hasClass("exclusive-hidden-icon")&&r.removeClass("exclusive-hidden-icon"),r.hasClass("exclusive-visible-icon")||r.addClass("exclusive-visible-icon"),t.get("parent-layer"))t.get("parent-layer").getLayers().forEach(function(e){e.get("layer-id")!=t.get("layer-id")&&e.setVisible(!1)})}else r.hasClass("hidden-icon")&&r.removeClass("hidden-icon"),r.hasClass("visible-icon")||r.addClass("visible-icon");this_.parentLayerVisible&&this_.setParentLayerVisible(t)}else t.get("exclusive")?(r.hasClass("exclusive-visible-icon")&&r.removeClass("exclusive-visible-icon"),r.hasClass("exclusive-hidden-icon")||r.addClass("exclusive-hidden-icon")):(r.hasClass("visible-icon")&&r.removeClass("visible-icon"),r.hasClass("hidden-icon")||r.addClass("hidden-icon"))});var i=e.get("toc")||null,l=document.createElement("ul");l.className="toc-group layer-group",null==o||o||(l.style.display="none");var s=document.createElement("li");s.className="toc-group-item layer-group",$(s).data("layer-ol",e);var c=document.createAttribute("data-layer-id");c.value=n,s.setAttributeNode(c),(c=document.createAttribute("data-level")).value=a,s.setAttributeNode(c);var d=document.createElement("div");d.className="left-icon-block";for(var u=0;u<a;u++)$('<span class="indent" />').appendTo(d);var p=!0,g="expanded-icon";null==e.get("expanded")||e.get("expanded")||(p=!1,g="expand-icon"),$('<span class="icon '+g+'" />').click([map,e],function(e){var t=$(this).closest("li"),a=(t.data("level"),!0);$(this).hasClass("expanded-icon")?(a=!1,$(this).removeClass("expanded-icon").addClass("expand-icon")):$(this).removeClass("expand-icon").addClass("expanded-icon");for(var o=t.parent().children(),r=1;r<o.length;r++)a?$(o[r]).show():$(o[r]).hide()}).appendTo(d);var f="hidden-icon";e.get("visible")&&(f="visible-icon"),$('<span class="icon layer-visibility-icon" />').addClass(f).click([map,e],function(e){e.preventDefault();e.data[0];var t=e.data[1];t.get("visible")?($(this).removeClass("visible-icon").addClass("hidden-icon"),t.set("visible",!1)):($(this).addClass("visible-icon").removeClass("hidden-icon"),t.set("visible",!0))}).appendTo(d),$(d).appendTo(s);var m=document.createElement("div");m.className="title-block",$("<span />").html(e.get("title")).appendTo(m),$(m).appendTo(s);var h=document.createElement("div");h.className="button-block";var v=!1;if(i&&"properties"in i&&i.properties&&i&&"transparency"in i&&i.transparency&&(v=!0),v&&$('<span class="tool" title="Propriedades"><i class="fa fa-ellipsis-v" /></span>').click([map,e],function(e){var t=$(this).parent().nextAll("div.layer-properties");$("div.layers-control span.tool").not(this).removeClass("active"),$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active"),$("div.layer-extra").not(t).each(function(){$(this).hide()}),t.toggle()}).appendTo(h),e.get("info")&&$('<span class="tool" title="Informação"><i class="fas fa-info-circle" /></span>').click([map,e],function(t){var a=e.get("info"),o=a.link;a.mode&&"external"==a.mode?window.open(o,"_blank").focus():this_.panelInfoWindow?(this_.panelInfoWindow.close(),this_.panelInfoWindow=this_.openPanelInfo(e)):this_.panelInfoWindow=this_.openPanelInfo(e)}).appendTo(h),$(h).appendTo(s),v){var y=$('<div class="layer-extra layer-properties" />');if(!i||!("transparency"in i)||i.transparency){var w=$('<div class="layer-opacity-slider">')[0],b=100*e.getOpacity();noUiSlider.create(w,{start:[b],range:{min:[0],max:[100]}}),w.noUiSlider.on("slide",function(t){var a=this.get()/100;e.setOpacity(a)});var _=$('<div class="layer-opacity"><label>Transparência:</label></div>');$(w).appendTo(_),_.appendTo(y)}y.appendTo(s)}if(e.get("data")){var C=$('<div class="layer-extra-data" />');(_=$(e.get("data").html||"")).appendTo(C),C.appendTo(s)}l.appendChild(s),t?t.appendChild(l):this.root.appendChild(l);var S=e.getLayers().getArray();for(u=S.length-1;u>=0;--u){var x=S[u];x instanceof ol.layer.Group?x.get("single")&&1==x.get("single")?this.addLayerToList(x,l,a+1,p,e):this.addLayerGroupToList(x,l,a+1,p,e):this.addLayerToList(x,l,a+1,p,e)}e.getLayers().on("add",function(e){var t=e.element,a=1;try{$(l).children("[data-level]:first").data("level")&&(a=parseInt($(l).children("[data-level]:first").data("level"))+1)}catch(e){}this.addLayerToList(t,l,a)},this),e.set("toc-group",!0)},app.LayersControl.prototype.hideAllLayers=function(){$(".icon.visible-icon",this.root).each(function(e,t){$(t).trigger("click")})},app.LayersControl.prototype.getRootLayer=function(){return this.rootLayer},app.LayersControl.prototype.refreshLayersControl=function(){return this.rootLayer},window.app||(window.app={});var app=window.app;app.BasemapsControl=function(e){this.generateID=function(){return r()+r()+r()+r()+r()+r()+r()+r()};var t=e||{};this.group=t.group||"basemap";var a=document.createElement("div");a.className="basemaps-control";var o=document.createElement("ul");function r(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}o.className="basemaps-list",this.container=o,a.appendChild(this.container),ol.control.Control.call(this,{element:a,target:t.target})},ol.inherits(app.BasemapsControl,ol.control.Control),app.BasemapsControl.prototype.setMap=function(e){ol.control.Control.prototype.setMap.call(this,e);for(var t=e.getLayers().getArray(),a=[],o=0,r=t.length;o<r;++o)layer=t[o],layer.get("group")==this.group&&a.push(layer);if(a.length>1)for(o=0,r=a.length;o<r;++o)this.addLayerToList(a[o]);else 1==a.length&&a[0]instanceof ol.layer.Group?this.addLayerGroupToList(a[0]):1==a.length&&this.addLayerToList(a[0])},app.BasemapsControl.prototype.addLayerToList=function(e){e.get("title");var t=document.createElement("li"),a=this.generateID(),o=document.createElement("div");o.className="thumbnail",e.get("visible")&&(o.classList?o.classList.add("active"):o.className+=" active");var r=document.createAttribute("data-layer-id");r.value=a,o.setAttributeNode(r);var n=this.container,i=this.group;$(o).click(function(){$(".thumbnail",n).not(this).each(function(){$(this).removeClass("active")}),$(this).toggleClass("active");for(var t=$(this).data("layer-id"),a=map.getLayers().getArray(),o=0,r=a.length;o<r;++o)if((e=a[o]).get("basemap-group"))for(var l=e.getLayers().getArray(),s=0,c=l.length;s<c;++s){l[s].get("layer-id")==t?l[s].set("visible",$(this).hasClass("active")):l[s].set("visible",!1)}else e.get("group")==i&&(e.get("layer-id")==t?a[o].set("visible",$(this).hasClass("active")):a[o].set("visible",!1))});var l=document.createElement("img");(r=document.createAttribute("src")).value=e.get("icon")||"",l.setAttributeNode(r),o.appendChild(l);var s=document.createElement("div");s.className="caption";var c=document.createElement("p"),d=document.createTextNode(e.get("title")||"");c.appendChild(d),s.appendChild(c),o.appendChild(s),t.appendChild(o),this.container.appendChild(t),e.set("layer-id",a)},app.BasemapsControl.prototype.addLayerGroupToList=function(e){for(var t=e.getLayers().getArray(),a=0,o=t.length;a<o;++a)this.addLayerToList(t[a]);e.set("basemap-group",!0)},window.app||(window.app={});var app=window.app;app.BasemapsMapControl=function(e){this.generateID=function(){return c()+c()+c()+c()+c()+c()+c()+c()};var t=e||{};this.group=t.group||"basemap",this.target=t.target;var a=document.createElement("div");a.className="basemaps-map-panel";var o=document.createElement("div");o.className="basemaps-active-layer";var r=document.createElement("img");att=document.createAttribute("src"),att.value="",r.setAttributeNode(att),o.appendChild(r);var n=document.createElement("div");n.className="caption";var i=document.createElement("p"),l=document.createTextNode("");i.appendChild(l),n.appendChild(i),o.appendChild(n),$(o).click(function(){var e=$(this).parent();$(".basemaps-layers-list",e).toggleClass("open")}),a.appendChild(o);var s=document.createElement("div");function c(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}s.className="basemaps-layers-list",this.container=s,a.appendChild(this.container),ol.control.Control.call(this,{element:a,target:t.target})},ol.inherits(app.BasemapsMapControl,ol.control.Control),app.BasemapsMapControl.prototype.setMap=function(e){ol.control.Control.prototype.setMap.call(this,e);for(var t=e.getLayers().getArray(),a=[],o=0,r=t.length;o<r;++o)layer=t[o],layer.get("group")==this.group&&a.push(layer);if(a.length>1)for(o=0,r=a.length;o<r;++o)this.addLayerToList(a[o]);else 1==a.length&&a[0]instanceof ol.layer.Group?this.addLayerGroupToList(a[0]):1==a.length&&this.addLayerToList(a[0])},app.BasemapsMapControl.prototype.addLayerToList=function(e){e.get("title");var t=document.createElement("div");t.className="basemaps-layer";var a=this.generateID();e.get("visible")&&(t.classList?t.classList.add("active"):t.className+=" active",$(".basemaps-active-layer img",".basemaps-map-control").attr("src",e.get("icon")||""),$(".basemaps-active-layer",r).attr(e.get("title")||""),$(".basemaps-active-layer .caption p",r).html(e.get("title")||""));var o=document.createAttribute("data-layer-id");o.value=a,t.setAttributeNode(o);var r=this.target,n=this.container,i=this.group;$(t).click(function(){$(".basemaps-layer",n).not(this).each(function(){$(this).removeClass("active")}),$(this).toggleClass("active");for(var t=$(this).data("layer-id"),a=map.getLayers().getArray(),o=0,l=a.length;o<l;++o)if((e=a[o]).get("basemap-group"))for(var s=e.getLayers().getArray(),c=0,d=s.length;c<d;++c){var u=s[c];u.get("layer-id")==t?(s[c].set("visible",$(this).hasClass("active")),$(this).hasClass("active")?($(".basemaps-active-layer img",r).attr("src",$("img",this).attr("src")),$(".basemaps-active-layer .caption p",r).html(u.get("title")||"")):($(".basemaps-active-layer img",r).attr("src","../static/images/basemaps/blank.jpg"),$(".basemaps-active-layer .caption p",r).html("Sem Base"))):s[c].set("visible",!1)}else e.get("group")==i&&(e.get("layer-id")==t?(a[o].set("visible",$(this).hasClass("active")),$(this).hasClass("active")?($(".basemaps-active-layer img",r).attr("src",$("img",this).attr("src")),$(".basemaps-active-layer",r).attr("title",e.get("title")||""),$(".basemaps-active-layer .caption p",r).html(e.get("title")||"")):($(".basemaps-active-layer img",r).attr("src","../static/images/basemaps/blank.jpg"),$(".basemaps-active-layer",r).attr("title","Sem Base"),$(".basemaps-active-layer .caption p",r).html("Sem Base"))):a[o].set("visible",!1));$(".basemaps-layers-list",r).toggleClass("open")});var l=document.createElement("img");(o=document.createAttribute("src")).value=e.get("icon")||"",l.setAttributeNode(o),t.appendChild(l);var s=document.createElement("div");s.className="caption";var c=document.createElement("p"),d=document.createTextNode(e.get("title")||"");c.appendChild(d),s.appendChild(c),t.appendChild(s),this.container.appendChild(t),e.set("layer-id",a)},app.BasemapsMapControl.prototype.addLayerGroupToList=function(e){for(var t=e.getLayers().getArray(),a=0,o=t.length;a<o;++a)this.addLayerToList(t[a]);e.set("basemap-group",!0)},window.app||(window.app={});var app=window.app;app.ZoomExtentControl=function(e){var t=e||{};this.extent_=t.extent;var a=document.createElement("a");a.href="#zoom-to",a.className="zoom-to";var o=this,r=function(e){o.handleZoomTo(e)};a.addEventListener("click",r,!1),a.addEventListener("touchstart",r,!1);var n=document.createElement("div");n.className="zoom-extent ol-unselectable",n.appendChild(a),ol.control.Control.call(this,{element:n,map:t.map,target:t.target})},ol.inherits(app.ZoomExtentControl,ol.control.Control),app.ZoomExtentControl.prototype.handleZoomTo=function(e){e.preventDefault();var t=this.getMap(),a=t.getView(),o=this.extent_?this.extent_:a.getProjection().getExtent(),r=t.getSize();a.fit(o,r)},app.ZoomExtentControl.prototype.setMap=function(e){ol.control.Control.prototype.setMap.call(this,e),e&&!this.extent_&&(this.extent_=e.getView().getProjection().getExtent())},window.app||(window.app={});var app=window.app;app.mapHistoryControl=function(e){var t=e||{},a=document.createElement("button"),o=t.buttonTipLabel||"Mapa anterior";a.innerHTML='<i class="fa fa-arrow-left" title="'+o+'"><i>',a.title=o;function r(){t.map_view_history.length>1&&t.map_view_history.pop();var e=t.map_view_history.length,a=t.map_view_history[e-1];a&&(store_map_state=!1,map.getView().setCenter(a.center),store_map_state=!1,map.getView().setZoom(a.zoom),store_map_state=!1,map.getView().setRotation(a.rotation),1==e&&(store_map_state=!0))}a.addEventListener("click",r,!1),a.addEventListener("touchstart",r,!1);var n=document.createElement("div");n.className=(t.className?t.className+" ":"")+"map-history-control-control  ol-control",n.appendChild(a),ol.control.Control.call(this,{element:n,target:t.target}),this.set("options",t),this.set("button",a)},ol.inherits(app.mapHistoryControl,ol.control.Control),window.app||(window.app={});var app=window.app;app.measureControl=function(e){var t,a,o,r=e||{},n=document.createElement("button"),i=r.buttonTipLabel_l||"Medir Distância";n.className="measure-length",n.innerHTML='<i class="fac-ruler-line" title="'+i+'"><i>',n.title=i;var l=document.createElement("button"),s=r.buttonTipLabel_a||"Medir Área";l.style.cssText="display: none",l.className="measure-area",l.innerHTML='<i class="fac-ruler-area" title="'+s+'"><i>',l.title=s;var c=this;c.projection=r.projection,c.containment=r.containment||null,c.panelWindow=null,c.panelonclosed=function(e){c.disableControl&&c.disableControl(),c.panelWindow=null,$(this).remove()};var d=function(e){var t=Math.round(1e3*e.getLength())/1e3;return(t>1e4?Math.round(t/1e3*1e3)/1e3+" km":Math.round(1e3*t)/1e3+" m").replace(".",",")},u=function(e){if(a){var t,o,r=a.getGeometry().clone().transform(c.map_.getView().getProjection(),c.projection);if(r instanceof ol.geom.Polygon){var n=r.getCoordinates();if(n.length>0&&n[0].length>1){var i=new ol.geom.LineString(n[0]);t=d(i)}o=((l=r.getArea())>1e4?Math.round(l/1e4*1e3)/1e3+" ha":Math.round(1e3*l)/1e3+" m<sup>2</sup>").replace(".",",")}else r instanceof ol.geom.LineString&&(t=d(r));$(".measure-info-area","#measureOutput").html(o||""),$(".measure-info-distance","#measureOutput").html(t||""),$(".measure-info-area",c.panelWindow.content).html(o||""),$(".measure-info-distance",c.panelWindow.content).html(t||"")}var l};function p(){for(var e=c.getMap().getControls().getArray(),a=0;a<e.length;a++)c!=e[a]&&e[a].activateControl&&e[a].activateControl();$(c.getMap().getViewport()).off("mousemove",u);var n,i=r.layer;i&&(n=i.getSource())&&o&&n.removeFeature(o),o=null,t&&c.getMap().removeInteraction(t),$(c.get("button")).removeClass("active"),c.set("active",!1)}function g(e){for(var n=c.getMap().getControls().getArray(),i=0;i<n.length;i++)c!=n[i]&&n[i].deactivateControl&&n[i].deactivateControl();if(c.panelWindow)c.panelWindow.normalize();else{function l(){return{my:"right-top",at:"right-top",offsetY:$("#map-navbar-container").position().top+$("#map-navbar-container").outerHeight()+8,offsetX:-55}}'<p class="pull-left">Comprimento: </p>','<p class="pull-right measure-info-distance">m</p>',"</div>",'<div class="measure-info" style="clear: both;border-bottom: 1px solid #e9e9e9; height: 2em; line-height: 2em; font-size: 12px; clear: both;">','<p class="pull-left">Área: </p>','<p class="pull-right measure-info-area">m²</p>',"</div>",c.panelWindow=$.jsPanel({id:"measure-panel",headerTitle:"Medição",contentSize:{width:"250",height:"auto"},position:l,dragit:{containment:"window"},contentOverflow:{horizontal:"hidden",vertical:"auto"},headerControls:{controls:"closeonly"},content:'<div class="measure-info" style="clear: both;border-bottom: 1px solid #e9e9e9; height: 2em; line-height: 2em; font-size: 12px; clear: both;"><p class="pull-left">Comprimento: </p><p class="pull-right measure-info-distance">m</p></div><div class="measure-info" style="clear: both;border-bottom: 1px solid #e9e9e9; height: 2em; line-height: 2em; font-size: 12px; clear: both;"><p class="pull-left">Área: </p><p class="pull-right measure-info-area">m²</p></div>',onclosed:c.panelonclosed,resizeit:!1,onwindowresize:function(e,t){t.reposition(l())}})}$(c.getMap().getViewport()).off("mousemove",u).on("mousemove",u);var s,d=r.layer;d&&(s=d.getSource())&&o&&s.removeFeature(o),o=null,c.getMap().removeInteraction(t);e="area"==e?"Polygon":"LineString";t=new ol.interaction.Draw({source:s,type:e}),c.getMap().addInteraction(t),t.on("drawstart",function(e){var t,n=r.layer;n&&(t=n.getSource())&&o&&t.removeFeature(o),a=e.feature},this),t.on("drawend",function(e){a=null,o=e.feature},this)}var f=function(e){for(var t=c.getMap().getControls().getArray(),a=0;a<t.length;a++)c!=t[a]&&t[a].disableControl&&t[a].disableControl();if($(c.get("button")).filter(".measure-length").hasClass("active"))p();else{$(c.get("button")).removeClass("active");$(c.get("button")).filter(".measure-length").addClass("active"),c.set("active",!0),g("length")}},m=function(e){for(var t=c.getMap().getControls().getArray(),a=0;a<t.length;a++)c!=t[a]&&t[a].disableControl&&t[a].disableControl();for(a=0;a<t.length;a++)c!=t[a]&&t[a].deactivateControl&&t[a].deactivateControl();if($(c.get("button")).filter(".measure-area").hasClass("active"))p();else{$(c.get("button")).removeClass("active");$(c.get("button")).filter(".measure-area").addClass("active"),c.set("active",!0),g("area")}};n.addEventListener("click",f,!1),n.addEventListener("touchstart",f,!1),l.addEventListener("click",m,!1),l.addEventListener("touchstart",m,!1);var h,v=document.createElement("div");v.className=(r.className?r.className+" ":"")+"measure-control ol-selectable ol-control",v.addEventListener("mouseover",function(e){$("button",this).show(),r.target&&h&&clearTimeout(h)},!0),v.addEventListener("mouseout",function(e){var t=this;r.target&&(h=setTimeout(function(){$("button",t).hide(),$("button.active",t).length>0?$("button.active",t).show():$("button:first",t).show()},200))},!1),v.appendChild(n),v.appendChild(l),ol.control.Control.call(this,{element:v,target:r.target});var y=[n,l];this.set("options",r),this.set("button",y),this.set("handleMouseMove",u),this.set("removeMeasureInteraction",p),this.set("active",!1)},ol.inherits(app.measureControl,ol.control.Control),app.measureControl.prototype.setMap=function(e){ol.control.Control.prototype.setMap.call(this,e),e&&(this.projection=this.projection||e.getView().getProjection().getCode())},app.measureControl.prototype.disableControl=function(e){for(var t=this.getMap().getControls().getArray(),a=0;a<t.length;a++)this!=t[a]&&t[a].activateControl&&t[a].activateControl();for(a=0;a<$(this.get("button")).length;a++)$(this.get("button")).removeClass("active");this.get("removeMeasureInteraction")(),this.set("active",!1),this.get("options").onDisableControl&&this.get("options").onDisableControl(e)},app.MousePositionControl=function(e){var t=e||{};(l=document.createElement("DIV")).className=void 0!==t.className?t.className:"ol-mouse-position";var a='<div class="input-group">';a+='<div class="form-control">',a+='<div class="map-coordsys-mouse-position"></div>',a+="</div>",a=(a=(a+='<div class="input-group-btn dropup">')+'<input type="hidden" class="map-coordsys-selected" value="'+t.projection+' " />')+'<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="map-coordsys-text">'+t.projection+'</span> <span class="caret"></span></button>',a+='<ul class="dropdown-menu dropdown-menu-right map-coordsys-list">',a+="</ul>",a+="</div>",a+="</div>",$(t.target).html(a);for(var o=0;o<t.projections.length;++o){var r=t.projections[o];if(!("visible"in r)||r.visible){a='<li><a href="#" data-code="'+r.code+'">'+(r.title||r.code)+"</a></li>";$(".map-coordsys-list",t.target).append(a)}}var n=this;$("a",".map-coordsys-list").click(function(e){var t=$(this).data("code");$(".map-coordsys-selected").val(t),$(".map-coordsys-control .map-coordsys-text").html(t),n.setProjection(ol.proj.get(t))});var i=$(".map-coordsys-mouse-position",t.target)[0],l=document.createElement("DIV"),s=t.render?t.render:ol.control.MousePosition.render;ol.control.Control.call(this,{element:l,render:s,target:i}),ol.events.listen(this,ol.Object.getChangeEventType(app.MousePositionControl.MousePositionProperty.PROJECTION),this.handleProjectionChanged_,this),t.coordinateFormat&&this.setCoordinateFormat(t.coordinateFormat),t.projection&&this.setProjection(ol.proj.get(t.projection)),this.undefinedHTML_=void 0!==t.undefinedHTML?t.undefinedHTML:"",this.renderedHTML_=l.innerHTML,this.mapProjection_=null,this.transform_=null,this.lastMouseMovePixel_=null},ol.inherits(app.MousePositionControl,ol.control.Control),app.MousePositionControl.render=function(e){var t=e.frameState;t?this.mapProjection_!=t.viewState.projection&&(this.mapProjection_=t.viewState.projection,this.transform_=null):this.mapProjection_=null,this.updateHTML_(this.lastMouseMovePixel_)},app.MousePositionControl.prototype.handleProjectionChanged_=function(){this.transform_=null},app.MousePositionControl.prototype.getCoordinateFormat=function(){return this.get(app.MousePositionControl.MousePositionProperty.COORDINATE_FORMAT)},app.MousePositionControl.prototype.getProjection=function(){return this.get(app.MousePositionControl.MousePositionProperty.PROJECTION)},app.MousePositionControl.prototype.handleMouseMove=function(e){var t=this.getMap();this.lastMouseMovePixel_=t.getEventPixel(e),this.updateHTML_(this.lastMouseMovePixel_)},app.MousePositionControl.prototype.handleMouseOut=function(e){var t=this.getMap(),a=t.getCoordinateFromPixel([e.x,e.y]),o=null;if(a){var r,n=this.getProjection();n?r=ol.proj.getTransform(t.getView().getProjection(),n):transform_=ol.proj.identityTransform,r(a,a);var i=this.getCoordinateFormat();o=i?i(a):a.toString()}o?(this.element.innerHTML=o,this.renderedHTML_=o):this.updateHTML_(o),this.lastMouseMovePixel_=null},app.MousePositionControl.prototype.setMap=function(e){if(ol.control.Control.prototype.setMap.call(this,e),e){var t=e.getViewport();this.listenerKeys.push(ol.events.listen(t,ol.events.EventType.MOUSEMOVE,this.handleMouseMove,this),ol.events.listen(t,ol.events.EventType.MOUSEOUT,this.handleMouseOut,this))}},app.MousePositionControl.prototype.setCoordinateFormat=function(e){this.set(app.MousePositionControl.MousePositionProperty.COORDINATE_FORMAT,e)},app.MousePositionControl.prototype.setProjection=function(e){this.set(app.MousePositionControl.MousePositionProperty.PROJECTION,e)},app.MousePositionControl.prototype.updateHTML_=function(e){var t=this.undefinedHTML_;if(e&&this.mapProjection_){if(!this.transform_){var a=this.getProjection();this.transform_=a?ol.proj.getTransformFromProjections(this.mapProjection_,a):ol.proj.identityTransform}var o=this.getMap().getCoordinateFromPixel(e);if(o){this.transform_(o,o);var r=this.getCoordinateFormat();t=r?r(o):o.toString()}}this.renderedHTML_&&t==this.renderedHTML_||(this.element.innerHTML=t,this.renderedHTML_=t)},app.MousePositionControl.MousePositionProperty={PROJECTION:"projection",COORDINATE_FORMAT:"coordinateFormat"},window.app||(window.app={});var app=window.app;app.coordinatesControl=function(e){var t=e||{},a=document.createElement("button");a.innerHTML='<i class="fa fa-crosshairs" title="'+(t.coordinatesTipLabel||"Obter Coordenadas")+'"><i>';var o=this,r=function(e){for(var a=o.getMap(),r=a.getInteractions().getArray(),n=!1,i=0;i<r.length;i++)if(a.getInteractions().getArray()[i]instanceof ol.interaction.Draw){n=!0;break}if(!n){e.coordinate;$(".menu-button.coordinates").trigger("open"),t.onMapClick&&t.onMapClick(e)}},n=function(e){for(var t=o.getMap().getControls().getArray(),a=0;a<t.length;a++)o!=t[a]&&t[a].disableControl&&t[a].disableControl();var n=o.get("active");if(n)o.disableControl();else{for(a=0;a<t.length;a++)o!=t[a]&&t[a].deactivateControl&&t[a].deactivateControl();n=!0,map.on("singleclick",r),$(this).addClass("active"),o.set("active",n)}};a.addEventListener("click",n,!1),a.addEventListener("touchstart",n,!1);var i=document.createElement("div");i.className=(t.className?t.className+" ":"")+"coordinates-control ol-selectable ol-control",i.appendChild(a),ol.control.Control.call(this,{element:i,target:t.target}),this.set("options",t),this.set("button",a),this.set("handleMapClick",r),this.set("removeCoordinatesInteraction",function(){var e,a=t.layer;a&&(e=a.getSource())&&o.feature&&e.removeFeature(o.feature),o.feature=null,$(o.get("button")).removeClass("active"),o.set("active",!1)}),this.set("active",!1)},ol.inherits(app.coordinatesControl,ol.control.Control),app.coordinatesControl.prototype.disableControl=function(e){for(var t=this.getMap().getControls().getArray(),a=0;a<t.length;a++)this!=t[a]&&t[a].activateControl&&t[a].activateControl();$(this.get("button")).removeClass("active"),this.getMap().un("singleclick",this.get("handleMapClick")),this.get("removeCoordinatesInteraction")(),this.set("active",!1),this.get("options").onDisableControl&&this.get("options").onDisableControl(e)},app.coordinatesControl.prototype.setFeature=function(e){this.feature=e},window.app||(window.app={});var app=window.app,INCHES_PER_UNIT={m:39.37,degrees:4374754},DOTS_PER_INCH=72;app.NumericScaleControl=function(e){var t=e||{},a=$('<div class="numericscale-control ol-control"><input class="form-control input input-xs" type="text" value="" /></div>');ol.control.Control.call(this,{element:a[0],target:t.target}),this.set("options",t),this.set("active",!1)},ol.inherits(app.NumericScaleControl,ol.control.Control),app.NumericScaleControl.prototype._getScaleForResolution=function(e,t){var a=INCHES_PER_UNIT[t]*DOTS_PER_INCH*e;return Math.round(a)},app.NumericScaleControl.prototype._getResolutionForScale=function(e,t){return parseFloat(e)/(INCHES_PER_UNIT[t]*DOTS_PER_INCH)},app.NumericScaleControl.prototype.setMap=function(e){ol.control.Control.prototype.setMap.call(this,e);var t=this,a=function(a){if(t.get("active")){var o=e.getView().getResolution(),r="1:"+t._getScaleForResolution(o,"m");$(t.element).find("input").val(r)}},o=function(a){if(13===a.keyCode){var o=parseInt($(this).val().split(":").pop(),10);if(!isNaN(o)){var r=t._getResolutionForScale(o,"m");e.getView().setResolution(r)}}},r=function(e){$(this).select()};e?(e.on("moveend",a),$(t.element).find("input").bind("keyup",o),$(t.element).find("input").bind("click",r)):(e.un("moveend",a),$(t.element).find("input").unbind("keyup",o),$(t.element).find("input").unbind("click",r))},window.app||(window.app={});var app=window.app;app.featureInfoControl=function(e){var t=e||{};this.generateID=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()},t.infoFormat=t.infoFormat||"application/json";var a=document.createElement("button");a.innerHTML='<i class="fa fa-info-circle title="Informação"><i>',a.title="Informação";var o=this;o.containment=t.containment||null,o.rootLayer=t.rootLayer||null,o.queryLayers=t.queryLayers||null,o.layer=t.layer||null,o.features=[],o.config=t.config||null,this.showLoading=t.showLoading||null,this.hideLoading=t.hideLoading||null,this.showDirectory=t.showDirectory||null,this.executeAction=t.executeAction||null,this.showEditor=t.showEditor||null,this.addWMSLayer=t.addWMSLayer||null,o.panelWindow=null;var r={};o.panelonclosed=function(e){o.disableControl&&o.disableControl(),o.layer&&o.layer.getSource().clear(),o.features&&(o.features=[]),o.panelWindow=null,$(this).remove()};var n=function(e){var t=e.split("?");return encodeURIComponent(t[0]+"?"+t[1])};var i=function(e){var a=o.getMap(),i=a.getInteractions().getArray(),l=!1;r={};for(var s=0;s<i.length;s++)if(a.getInteractions().getArray()[s]instanceof ol.interaction.Draw){l=!0;break}if(!l){e.coordinate;var c=[];o.layer&&o.layer.getSource().clear(),o.features&&(o.features=[]),c=o.rootLayer?o.rootLayer.getLayers().getArray():a.getLayers().getArray();var d=[],u=function(e){if(e.get("visible"))if(e instanceof ol.layer.Group)e.getLayers().forEach(function(e){u(e)});else if(e.getSource){var t=e.getSource();(t instanceof ol.source.TileWMS||t instanceof ol.source.ImageWMS)&&e.get("queryable")&&d.push(e)}};if(c.forEach(function(e){u(e)}),o.queryLayers&&o.queryLayers.length>0)for(var p=0;p<o.queryLayers.length;p++){var g=o.queryLayers[p],f=g.getSource();(f instanceof ol.source.TileWMS||f instanceof ol.source.ImageWMS)&&d.push(g)}if(!(d&&d.length>0)){return"<p>Não existem temas a inquirir</p>","</div>",o.panelWindow.content.empty().append('<div class="msg msg-alert"><p>Não existem temas a inquirir</p></div>'),!1}o.panelWindow.content.empty(),o.showLoading&&o.showLoading("#"+o.panelWindow.attr("id")+" .jsPanel-content");$.Deferred();var m=[];for(s=d.length-1;s>=0;s--){var h=d[s],v=h.getSource(),y=h.get("infoFormat");if(!y&&h.get("capability")&&h.get("capability").infoFormats){for(var w=0;w<h.get("capability").infoFormats.length;w++)if(h.get("capability").infoFormats[w].toLowerCase().indexOf("json")>0){y=h.get("capability").infoFormats[w];break}if(!y)for(w=0;w<h.get("capability").infoFormats.length;w++)if(h.get("capability").infoFormats[w].toLowerCase().indexOf("gml")>0){y=h.get("capability").infoFormats[w];break}if(!y)for(w=0;w<h.get("capability").infoFormats.length;w++)if(h.get("capability").infoFormats[w].toLowerCase().indexOf("html")>0){y=h.get("capability").infoFormats[w];break}if(!y)for(w=0;w<h.get("capability").infoFormats.length;w++)if(h.get("capability").infoFormats[w].toLowerCase().indexOf("plain")>0){y=h.get("capability").infoFormats[w];break}}y||(y=t.infoFormat),h.set("infoFormat",y);var b,_=h.get("featureCount")||t.featureCount||10,C=v.getGetFeatureInfoUrl(e.coordinate,a.getView().getResolution(),a.getView().getProjection(),{INFO_FORMAT:y,FEATURE_COUNT:_}),S={url:t.proxy+"?url="+n(C),method:"get",parametersData:{layer:h,format:y}};"application/json"!=y&&"application/geojson"!=y||(S.dataType="json"),(b=$.ajax(S).then(function(e){return{result:e,request:this}}).fail(function(e){return{result:e}}))&&m.push(b)}var x=function(e,t){var a=t.features;if(!a||0==a.length)return[];var r=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(t)}).getFeatures();if(t.crs&&t.crs.properties&&ol.proj.get(t.crs.properties.name))for(var n=ol.proj.get(t.crs.properties.name),i=ol.proj.getTransform(n,o.getMap().getView().getProjection()),l=0;l<r.length;l++){r[l].getGeometry().applyTransform(i)}else if(t.crs&&t.crs.properties){var s=t.crs.properties.name.split(":"),c=s[s.length-1];for(l=0;l<r.length;l++){r[l].set("proj_code",c)}}return r},P=function(e,t,a){var n=[],i=null,l=!1;e&&(i=e.get("template"));var s=e.getProperties(),c=e.get("title")||"Sem título";void 0===r[s["layer-id"]]&&(r[s["layer-id"]]={title:c,results:[]});var d='<div class="layer-title"><span class="icon expanded-icon" /><span>'+c+"</span></div>";if(d+="<div>","text/html"==a||"text/plain"==a?(d+=t,l=!0):"application/json"==a?n=x(0,t):"application/geojson"==a?n=x(0,t):"application/vnd.ogc.gml"!=a&&"application/vnd.ogc.gml/3.1.1"!=y||(n=function(e,t){var a=(new ol.format.WMSGetFeatureInfo).readFeatures(t);if(!a||0==a.length)return[];if(ol.proj.get(e.get("projection"))){for(var r=ol.proj.get(e.get("projection")),n=ol.proj.getTransform(r,o.getMap().getView().getProjection()),i=0;i<a.length;i++)a[i].getGeometry().applyTransform(n);return a}if(e.get("projection")){var l=e.get("projection").split(":"),s=l[l.length-1];for(i=0;i<a.length;i++)a[i].set("proj_code",s);return a}return a}(e,t)),n&&n.length>0)for(var u=0;u<n.length;u++){var p=n[u],g=p.properties||p.getProperties();p.set("feature_id",o.generateID());var f='<table class="table table-striped table-bordered table-condensed">',m=null;for(var h in g){if((C=g[h])instanceof ol.geom.Geometry){m=h;break}}if(m&&(p.get("proj_code")&&p.get("proj_code").length>0?f+='<tr><td colspan="2"><a href="#" data-feature-id="'+p.get("feature_id")+'" title="Sistema de coordenadas não suportado"><i class="fa fa-exclamation-circle" aria-hidden="true"></i> </td></tr>':f+='<tr><td colspan="2"><a href="#" class="zoom-feature" data-feature-id="'+p.get("feature_id")+'"><i class="fa fa-search-plus" aria-hidden="true"></i> Ver</td></tr>'),i&&i.fields&&i.fields.length>0)for(var v=i.fields,w=0;w<v.length;w++){var $=v[w].value;null!=v[w].field&&v[w].field in g&&($=g[v[w].field]);var b=$;if("hyperlink"==v[w].type){var _=null,C=$;if(null!=v[w].field){if(_=String.format(v[w].url,$),v[w].field instanceof Array){_=v[w].url;for(var S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(_=_.replace("{"+S+"}",g[v[w].field[S]]))}}else _=v[w].url;if(null!=v[w].value&&(C=v[w].value,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(C=C.replace("{"+S+"}",g[v[w].field[S]]));b='<a href="'+_+'" target="_blank">'+C+"</a>"}else if("html"==v[w].type)if(null!=v[w].field)if(v[w].field instanceof Array){b=v[w].value;for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(b=b.replace("{"+S+"}",g[v[w].field[S]]))}else b=String.format(v[w].value,$);else b=v[w].value;else if("directory"==v[w].type){_=null,C=$;var P=null,k=!0;if(null!=v[w].field){if(_=String.format(v[w].url,$),v[w].field instanceof Array){_=v[w].url;for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(_=_.replace("{"+S+"}",g[v[w].field[S]]))}}else _=v[w].url;if(null!=v[w].value&&(C=v[w].value,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(C=C.replace("{"+S+"}",g[v[w].field[S]]));if(v[w].window&&v[w].window.title&&(P=v[w].window.title,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(P=P.replace("{"+S+"}",g[v[w].field[S]]));null!=v[w].recursive&&(k=v[w].recursive),b='<a href="#" class="feature-info-link-dir" data-action="'+_+'" data-title="'+P+'" data-filter="'+v[w].filter+'" data-recursive='+k+">"+C+"</a>"}else if("wms_layer"==v[w].type){_=null,C=$,e="";var L="",T=v[w].target;if(null!=v[w].field){if(_=String.format(v[w].url,$),v[w].field instanceof Array){_=v[w].url;for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(_=_.replace("{"+S+"}",g[v[w].field[S]]))}}else _=v[w].url;if(null!=v[w].value&&(C=v[w].value,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(C=C.replace("{"+S+"}",g[v[w].field[S]]));if(null!=v[w].value&&(e=v[w].parameters.layer,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(e=e.replace("{"+S+"}",g[v[w].field[S]]));if(null!=v[w].value&&(L=v[w].parameters.title,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(L=L.replace("{"+S+"}",g[v[w].field[S]]));b='<a href="#" class="feature-info-wms-layer" data-url="'+_+'" data-layer-name="'+e+'" data-layer-title="'+L+(T?'" data-target-layer="'+T:"")+'">'+C+"</a>"}else if("action"==v[w].type){var M=null;C=$;if(null!=v[w].field){if(M=String.format(v[w].action,$),v[w].field instanceof Array){M=v[w].action;for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(M=M.replace("{"+S+"}",g[v[w].field[S]]))}}else M=v[w].action;if(null!=v[w].value&&(C=v[w].value,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(C=C.replace("{"+S+"}",g[v[w].field[S]]));b='<a href="#" class="feature-info-link-action" data-layer-title="'+e.get("title")+'" data-action="'+M+'">'+C+"</a>"}else if("editor"==v[w].type){_=null,C=$;if(null!=v[w].field){if(_=String.format(v[w].url,$),v[w].field instanceof Array){_=v[w].url;for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(_=_.replace("{"+S+"}",g[v[w].field[S]]))}}else _=v[w].url;if(null!=v[w].value&&(C=v[w].value,v[w].field instanceof Array))for(S=0;S<v[w].field.length;S++)v[w].field[S]in g&&(C=C.replace("{"+S+"}",g[v[w].field[S]]));b='<a href="#" class="feature-info-link-editor" data-layer-title="'+e.get("title")+'" data-action="'+_+'">'+C+"</a>"}l=!0,0===b&&(b=String(b)),f+="<tr><td>"+v[w].title+"</td><td>"+(b||"")+"</td></tr>",r[s["layer-id"]].results.push([v[w].title,b||""])}else for(var h in g){($=g[h])instanceof ol.geom.Geometry||(f+="<tr><td>"+h+"</td><td>"+($||"")+"</td></tr>",r[s["layer-id"]].results.push([h,$||""])),l=!0}f+="</table>",!0===l&&(d+=f)}return l||(d+="<div>SEM DADOS</div>"),d+="</div>",n&&n.length>0&&(o.features=n.concat([].concat(o.features))),d},k=function(e,t){var a='<div class="layer-title"><span class="icon expanded-icon" /><span>'+(e.get("title")||"Sem título")+"</span></div>";return a+="<div>Erro ao inquirir serviço</div>"};(function(e){for(var t=$.Deferred(),a=[],o=e.length,r=0;r<e.length;r++)e[r].then(function(e){a.push({status:"success",result:e.result,request:e.request,format:e.request.parametersData.format})}).fail(function(e){a.push({status:"error",result:e,request:this,format:this.parametersData.format})}).always(function(e){--o||t.resolve(a)});return t.promise()})(m).then(function(e){for(var t="",a=0;a<e.length;a++){var n=e[a],i=n.request.parametersData.layer;"success"==n.status?t+=P(i,n.result,n.format):"error"==n.status&&(t+=k(i,n.result))}t='<a class="btn btn-primary btn-xs feature-info-export">Exportar Resultados</a><br />'+t,o.panelWindow.content.empty().append(t);var l=o;$(".jsPanel-content .feature-info-export",o.panelWindow).click(function(e){const t=[];var a="data:text/csv;charset=utf-8,";for(var o in r)for(var n=0;n<r[o].results.length;n++){var i=""+r[o].results[n][0],l=""+r[o].results[n][1];t.push([r[o].title,i,$.trim(l.replace(/\,/g,""))])}for(n=0;n<t.length;n++){a+=t[n].join(",")+"\r\n"}var s=encodeURI(a),c=document.createElement("a");c.setAttribute("href",s),c.setAttribute("download","my_data.csv"),document.body.appendChild(c),c.click(),document.body.removeChild(c)}),$(".jsPanel-content a[data-feature-id]",o.panelWindow).click(function(e){if(l.layer){var t=$(this).data("feature-id");l.layer.getSource().clear();for(var a=0;a<l.features.length;a++){var o=l.features[a];if(o.get("feature_id")==t){if(o.get("proj_code")&&o.get("proj_code").length>0);else{l.layer.getSource().addFeature(o);o.getGeometry().getExtent();l.map_.getView().fit(o.getGeometry(),l.map_.getSize(),{minResolution:.2})}break}}}return!1}),o.hideLoading&&o.hideLoading("#"+o.panelWindow.attr("id")+" .jsPanel-content")})}},l=function(e){for(var t=o.getMap().getControls().getArray(),a=0;a<t.length;a++)o!=t[a]&&t[a].disableControl&&t[a].disableControl();var r=o.get("active");if(r)o.disableControl();else{for(a=0;a<t.length;a++)o!=t[a]&&t[a].deactivateControl&&t[a].deactivateControl();r=!0,map.on("singleclick",i),$(this).addClass("active"),o.set("active",r),function(){if(o.panelWindow)o.panelWindow.normalize();else{var e=function(){return{my:"right-top",at:"right-top",offsetY:$("#map-navbar-container").position().top+$("#map-navbar-container").outerHeight()+8,offsetX:-55}};o.panelWindow=$.jsPanel({id:"feature-info-panel",headerTitle:"Informação",panelSize:{width:(t=o.config,a=275,t&&t.width&&(a=t.width.endsWith("%")?function(){return $(window).width()*parseInt(t.width)/100}:t.width),a),height:function(e){var t=275;return e&&e.height&&(t=e.height.endsWith("%")?function(){return $(window).height()*parseInt(e.height)/100}:e.height),t}(o.config)},position:e,dragit:{containment:"window"},contentOverflow:{horizontal:"hidden",vertical:"auto"},headerControls:{controls:"closeonly"},content:'<div class="msg"><p>Clique no mapa para obter informação sobre os elementos</p></div>',onclosed:o.panelonclosed,onwindowresize:function(t,a){a.reposition(e())}}),o.panelWindow.on("click",".layer-title",function(){$("span.icon",this).hasClass("expanded-icon")?($("span.icon",this).removeClass("expanded-icon").addClass("expand-icon"),$(this).next("div").hide("fast")):($("span.icon",this).removeClass("expand-icon").addClass("expanded-icon"),$(this).next("div").show("fast"))})}var t,a}()}};a.addEventListener("click",l,!1),a.addEventListener("touchstart",l,!1);var s=document.createElement("div");s.className=(t.className?t.className+" ":"")+"feature-info-control ol-selectable ol-control",s.appendChild(a),$(document).on("click",".feature-info-link-dir",function(e){if(e.preventDefault(),o.showDirectory){var t=[this];o.showDirectory.apply(o,t)}}),$(document).on("click",".feature-info-link-action",function(e){if(e.preventDefault(),o.showEditor){var t=[$(this).data("action")];o.executeAction.apply(o,t)}}),$(document).on("click",".feature-info-link-editor",function(e){if(e.preventDefault(),o.executeAction){var t=[this];o.showEditor.apply(o,t)}}),$(document).on("click",".feature-info-wms-layer",function(e){if(e.preventDefault(),o.addWMSLayer){var t=[this];o.addWMSLayer.apply(o,t)}}),ol.control.Control.call(this,{element:s,target:t.target}),this.set("options",t),this.set("button",a),this.set("handleMapClick",i),this.set("removeFeatureInfoInteraction",function(){$(o.get("button")).removeClass("active"),o.set("active",!1)}),this.set("active",!1)},ol.inherits(app.featureInfoControl,ol.control.Control),app.featureInfoControl.prototype.setMap=function(e){if(ol.control.Control.prototype.setMap.call(this,e),!this.layer){var t=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),name:"viewer-feature-info-layer",group:"vector"});e.addLayer(t),this.layer=t}},app.featureInfoControl.prototype.disableControl=function(e){for(var t=this.getMap().getControls().getArray(),a=0;a<t.length;a++)this!=t[a]&&t[a].activateControl&&t[a].activateControl();$(this.get("button")).removeClass("active"),this.getMap().un("singleclick",this.get("handleMapClick")),this.get("removeFeatureInfoInteraction")(),this.set("active",!1),this.get("options").onDisableControl&&this.get("options").onDisableControl(e)},window.app||(window.app={});var app=window.app;app.featureSelectControl=function(e){var t=e||{};this.generateID=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()},this.getLayer=function(e,t){var o=e,r=(t=t,null);if(o.get("layer-id")==t)r=o;else if(o instanceof ol.layer.Group)for(var n=o.getLayers().getArray(),i=0;i<n.length;i++){var l=n[i];if(r=l.get("layer-id")==t?l:a.getLayer(l,t,o))break}return r};var a=this;a.containment=t.containment||null,a.panelWindow=null,a.panelonclosed=function(e){a.disableControl&&a.disableControl(),a.get("select-control")&&(a.get("select-control").getFeatures().forEach(function(e,t,a){e.setStyle(null)}),a.get("select-control").getFeatures().clear()),a.panelWindow=null,$(this).remove()},a.rootLayer=t.rootLayer||null;var o=document.createElement("div");ol.control.Control.call(this,{element:o,target:t.target});var r=null;t.styles&&t.styles.selection&&(r=t.styles.selection);var n=new ol.interaction.Select({condition:ol.events.condition.pointerMove,filter:function(e,t){return!!t&&!!(t.get("selectable")&&null==t.get("highlight")||1==t.get("highlight"))},multi:!1,style:r});map.addInteraction(n);var i=new ol.interaction.Select({condition:ol.events.condition.click,filter:function(e,t){return!!t&&!!t.get("selectable")&&(e.set("layer-id",t.get("layer-id")),!0)},multi:t.multi,style:r});map.addInteraction(i),i.on("select",function(e){a.get("hover-select-control")&&a.get("hover-select-control").getFeatures()&&a.get("hover-select-control").getFeatures().clear();for(var o=0;o<e.deselected.length;o++){e.deselected[o].setStyle(null)}var r=function(e){function t(){return{my:"right-top",at:"right-top",offsetY:$("#map-navbar-container").position().top+$("#map-navbar-container").outerHeight()+8,offsetX:-55}}a.panelWindow=$.jsPanel({id:"feature-select-panel",headerTitle:"Informação",panelSize:{width:function(){return $(window).width()/5},height:275},position:t,dragit:{containment:"window"},contentOverflow:{horizontal:"hidden",vertical:"auto"},headerControls:{controls:"closeonly"},content:e,onclosed:a.panelonclosed,onwindowresize:function(e,a){a.reposition(t())}}),a.panelWindow.on("click",".layer-title",function(){$("span.icon",this).hasClass("expanded-icon")?($("span.icon",this).removeClass("expanded-icon").addClass("expand-icon"),$(this).next("div").hide("fast")):($("span.icon",this).removeClass("expand-icon").addClass("expanded-icon"),$(this).next("div").show("fast"))})};if(e.target.getFeatures()&&0==e.target.getFeatures().getLength()){var n='<div class="msg msg-alert">';return n+="<p>Não foram seleccionados elementos</p>",n+="</div>",void(a.panelWindow?(a.panelWindow.content.empty().append(n),a.panelWindow.normalize()):r(n))}n="";var i=e.target.getFeatures().getArray();for(o=0;o<i.length;o++){var l=i[o];l.set("feature_id",a.generateID());var s=null;a.getMap().getLayers().forEach(function(e){var t=a.getLayer(e,l.get("layer-id"));t&&(s=t)});var c=l.getProperties(),d=null,u=null;s&&(d=s.get("template"),u=s.get("layer-id"));var p='<table class="table table-striped table-bordered table-condensed">',g=null;for(var f in c){if((L=c[f])instanceof ol.geom.Geometry){g=f;break}}if(c.features&&c.features instanceof Array)for(var m=c.features,h=new ol.format.WKT,v=0;v<m.length;v++){var y=m[v],w=y.getProperties();if(g){var b=y.getGeometry(),_=h.writeGeometry(b);p+='<tr><td colspan="2">',p+='<a href="#" class="zoom-feature" data-layer-id="'+u+'" data-feature-id="'+y.getId()+'" data-feature-geom="'+_+'">',p+='<i class="fa fa-search-plus" aria-hidden="true"></i> Ver</td></tr>'}if(d&&d.fields&&d.fields.length>0)for(var C=d.fields,S=0;S<C.length;S++){var x=C[S].value;if(null!=C[S].field)for(var f in w)if(f==C[S].field){x=w[f];break}var P=x;if("hyperlink"==C[S].type){var k=null,L=x;k=null!=C[S].field?String.format(C[S].url,x):C[S].url,null!=C[S].value&&(L=C[S].value),P='<a href="'+k+'" target="_blank">'+L+"</a>"}hasContent=!0,p+="<tr><td>"+C[S].title+"</td><td>"+(P||"")+"</td></tr>"}else for(var f in w){(x=w[f])instanceof ol.geom.Geometry||(p+="<tr><td>"+f+"</td><td>"+(x||"")+"</td></tr>"),hasContent=!0}}else if(g&&(l.get("proj_code")&&l.get("proj_code").length>0?p+='<tr><td colspan="2"><a href="#" data-feature-select-id="'+l.get("feature_id")+'" title="Sistema de coordenadas não suportado"><i class="fa fa-exclamation-circle" aria-hidden="true"></i> </td></tr>':p+='<tr><td colspan="2"><a href="#" class="zoom-feature" data-feature-select-id="'+l.get("feature_id")+'"><i class="fa fa-search-plus" aria-hidden="true"></i> Ver</td></tr>'),d&&d.fields&&d.fields.length>0)for(C=d.fields,S=0;S<C.length;S++){x=C[S].value;null!=C[S].field&&C[S].field in c&&(x=c[C[S].field]);P=x;if("hyperlink"==C[S].type){k=null,L=x;if(null!=C[S].field){if(k=String.format(C[S].url,x),C[S].field instanceof Array){k=C[S].url;for(var T=0;T<C[S].field.length;T++)C[S].field[T]in c&&(k=k.replace("{"+T+"}",c[C[S].field[T]]))}}else k=C[S].url;if(null!=C[S].value&&(L=C[S].value,C[S].field instanceof Array))for(T=0;T<C[S].field.length;T++)C[S].field[T]in c&&(L=L.replace("{"+T+"}",c[C[S].field[T]]));P='<a href="'+k+'" target="_blank">'+L+"</a>"}else if("html"==C[S].type)if(null!=C[S].field)if(C[S].field instanceof Array){P=C[S].value;for(T=0;T<C[S].field.length;T++)C[S].field[T]in c&&(P=P.replace("{"+T+"}",c[C[S].field[T]]))}else P=String.format(C[S].value,x);else P=C[S].value;hasContent=!0,p+="<tr><td>"+C[S].title+"</td><td>"+(P||"")+"</td></tr>"}else for(var f in c){(x=c[f])instanceof ol.geom.Geometry||(p+="<tr><td>"+f+"</td><td>"+(x||"")+"</td></tr>"),hasContent=!0}p+="</table>",!0===hasContent&&(n+=p)}a.panelWindow?(a.panelWindow.content.empty().append(n),a.panelWindow.normalize()):r(n),$(".jsPanel-content a.zoom-feature",a.panelWindow).bind("click",{context:a},function(e){var a=$(this).data("feature-select-id"),o=e.data.context,r=o.get("select-control").getFeatures().getArray(),n=null;if(a)for(var i=0;i<r.length;i++){var l=r[i];l.setStyle(null),l.get("feature_id")&&l.get("feature_id")==a&&(n=l)}else{var s=$(this).data("layer-id"),c=(a=$(this).data("feature-id"),e.data.context),d=null;c.getMap().getLayers().forEach(function(e){var t=c.getLayer(e,s);t&&(d=t)}),d&&(n=d.getSource().getSource().getFeatureById(a),o.get("select-control").getFeatures().clear(),o.get("select-control").getFeatures().push(n))}if(n&&n.getGeometry()){var u=n.getGeometry(),p=null;t.styles.active&&(p=t.styles.active instanceof Array?t.styles.active:t.styles.active[u.getType()]?t.styles.active[u.getType()]:t.styles.active),p&&n.setStyle(p),o.getMap().getView().fit(u,o.getMap().getSize(),{minResolution:.2})}})}),i.setActive(!0),this.set("select-control",i),this.set("hover-select-control",n),this.set("options",t),this.set("button",[]),this.set("removeFeatureSelectInteraction",function(){a.set("active",!1)}),this.set("featureSelectInteraction",function(e){}),this.set("active",!0)},ol.inherits(app.featureSelectControl,ol.control.Control),app.featureSelectControl.prototype.disableControl=function(e){for(var t=0;t<$(this.get("button")).length;t++)$(this.get("button")).removeClass("active");this.get("removeFeatureSelectInteraction")(),this.set("active",!1),this.get("options").onDisableControl&&this.get("options").onDisableControl(e)},app.featureSelectControl.prototype.activateControl=function(e){this.get("select-control").setActive(!0),this.get("hover-select-control").setActive(!0)},app.featureSelectControl.prototype.deactivateControl=function(e){var t;(t=this.get("select-control")).setActive(!1),(t=this.get("hover-select-control")).getFeatures().clear(),t.setActive(!1)},window.app||(window.app={});var app=window.app;app.googleStreetViewControl=function(e){var t=e||{};this.generateID=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()};var a=this;a.layer=t.layer,a.iconStyle=t.iconStyle||new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:"../static/images/icons/location-icon.svg"})}),a.panelTitle=t.panelTitle||"Google Street View",a.panelWindow=null,a.panelonclosed=function(e){if(a.disableControl&&a.disableControl(),a.feature){var t,o=a.layer;o&&(t=o.getSource())&&a.feature&&t.removeFeature(a.feature),a.feature=null}a.panelWindow=null,$(this).remove()};var o=document.createElement("button"),r=t.buttonTipLabel||"Ver local no Google Street View";o.innerHTML='<i class="fa fa-street-view" title="'+r+'"><i>',o.title=r;var n=function(e){for(var t=a.getMap(),o=t.getInteractions().getArray(),r=!1,n=0;n<o.length;n++)if(t.getInteractions().getArray()[n]instanceof ol.interaction.Draw){r=!0;break}if(!r){var i,l=ol.proj.transform(e.coordinate,t.getView().getProjection().getCode(),"EPSG:4326"),s=a.layer;if(s&&(i=s.getSource())&&a.feature)try{i.removeFeature(a.feature)}catch(e){}a.feature=new ol.Feature({geometry:new ol.geom.Point(e.coordinate)}),a.feature.setStyle(a.iconStyle),s.getSource().addFeature(a.feature),a.panelWindow?(a.panelWindow.normalize(),a.panorama.setPosition(new google.maps.LatLng(l[1],l[0]))):a.panelWindow=$.jsPanel({id:a.generateID(),position:{my:"left-top",at:"left-top",offsetX:15,offsetY:15},contentSize:{width:500,height:350},headerTitle:a.panelTitle,content:"",callback:function(){var e={position:new google.maps.LatLng(l[1],l[0]),pov:{heading:34,pitch:10}},t=$("div.jsPanel-content",this)[0],o=new google.maps.StreetViewPanorama(t,e);o.addListener("position_changed",function(){var e=a.feature;if(e){var t=a.getMap(),r=o.getPosition(),n=ol.proj.transform([r.lng(),r.lat()],"EPSG:4326",t.getView().getProjection().getCode());e.set("geometry",new ol.geom.Point(n))}}),a.panorama=o},onclosed:a.panelonclosed,onmaximized:function(){var e=a.panorama;google.maps.event.trigger(e,"resize")},dragit:{containment:"window"},resizeit:{start:function(e,t){},stop:function(e,t){var o=a.panorama;google.maps.event.trigger(o,"resize")}}})}},i=function(e){for(var t=a.getMap().getControls().getArray(),o=0;o<t.length;o++)a!=t[o]&&t[o].disableControl&&t[o].disableControl();var r=a.get("active");if(r)a.disableControl();else{for(o=0;o<t.length;o++)a!=t[o]&&t[o].deactivateControl&&t[o].deactivateControl();r=!0,map.on("singleclick",n),$(this).addClass("active"),a.set("active",r)}};o.addEventListener("click",i,!1),o.addEventListener("touchstart",i,!1);var l=document.createElement("div");l.className=(t.className?t.className+" ":"")+"google-streetview-control ol-selectable ol-control",l.appendChild(o),ol.control.Control.call(this,{element:l,target:t.target}),this.set("options",t),this.set("button",o),this.set("handleMapClick",n),this.set("removeGoogleStreetViewInteraction",function(){$(a.get("button")).removeClass("active"),a.set("active",!1)}),this.set("active",!1)},ol.inherits(app.googleStreetViewControl,ol.control.Control),app.googleStreetViewControl.prototype.disableControl=function(e){for(var t=this.getMap().getControls().getArray(),a=0;a<t.length;a++)this!=t[a]&&t[a].activateControl&&t[a].activateControl();$(this.get("button")).removeClass("active"),this.getMap().un("singleclick",this.get("handleMapClick")),this.get("removeGoogleStreetViewInteraction")(),this.set("active",!1),this.get("options").onDisableControl&&this.get("options").onDisableControl(e)},app.googleStreetViewControl.prototype.setFeature=function(e){this.feature=e},window.app||(window.app={});var app=window.app;app.drawtoolsControl=function(e){var t=e||{},a=document.createElement("button");a.innerHTML='<i class="fa fa-edit" title="'+(t.drawtoolsTipLabel||"Ferramentas de Desenho")+'"><i>';var o=function(e){Portal.Viewer.ShowPanel("drawtools")},r=document.createElement("div");r.className=(t.className?t.className+" ":"")+"drawtools-control ol-selectable ol-control",r.appendChild(a),ol.control.Control.call(this,{element:r,target:t.target}),a.addEventListener("click",o,!1),a.addEventListener("touchstart",o,!1),this.set("options",t),this.set("button",a),this.set("handleClick",o),this.set("removeDrawToolsInteraction",function(){}),this.set("active",!1)},ol.inherits(app.drawtoolsControl,ol.control.Control),app.drawtoolsControl.prototype.disableControl=function(e){},app.drawtoolsControl.prototype.setViewer=function(e){this.viewer=e},window.app||(window.app={});var app=window.app;app.genericDrawControl=function(e){var t=e||{},a=document.createElement("div");ol.control.Control.call(this,{element:a,target:t.target}),this.set("options",t)},ol.inherits(app.genericDrawControl,ol.control.Control),app.genericDrawControl.prototype.disableControl=function(e){for(var t=this.getMap().getControls().getArray(),a=0;a<t.length;a++)this!=t[a]&&t[a].activateControl&&t[a].activateControl();if(this.get("currentDrawInteraction")){var o=this.getMap(),r=this.get("currentDrawInteraction");o.removeInteraction(r)}this.get("options").onDisableControl&&this.get("options").onDisableControl(e)},app.genericDrawControl.prototype.enableControl=function(e,t){var a=this.getMap();if(this.get("currentDrawInteraction")){var o=this.get("currentDrawInteraction");a.removeInteraction(o)}for(var r=a.getControls().getArray(),n=0;n<r.length;n++)this!=r[n]&&r[n].disableControl&&r[n].disableControl();for(n=0;n<r.length;n++)this!=r[n]&&r[n].deactivateControl&&r[n].deactivateControl();a.removeInteraction(t),this.getMap().addInteraction(t),this.set("currentDrawInteraction",t),this.get("options").onEnableControl&&this.get("options").onEnableControl(e,t)};var Portal=Portal||{Init:function(){}},map,mapProxy,owsLayers;function OWS(e){var t="",a="",o=null,r={},n=null,i=null;e&&(t=e.rootElementId||"",a=e.parentId||"",o=e.map||null,n=e.layers||null);var l=null,s=null,c=function(){return"_"+Math.random().toString(36).substr(2,9)},d="Ver metadados do serviço",u="Indique o Url do serviço",p="Ocorreu um erro ao aceder ao serviço",g="Ocorreu um erro ao processar o ficheiro",f=function(e){var t=e.split("?");return encodeURIComponent(t[0]+"?"+t[1])},m=function(e,t){var a,o=[];for(var r in e)e.hasOwnProperty(r)&&o.push(r);for(;a=o.pop();)if(a.toLowerCase()===t.toLowerCase())return!0;return!1},h=function(e){var t=[[parseFloat(e[0]),parseFloat(e[3])],[parseFloat(e[2]),parseFloat(e[3])],[parseFloat(e[2]),parseFloat(e[1])],[parseFloat(e[0]),parseFloat(e[1])],[parseFloat(e[0]),parseFloat(e[3])]];return new ol.geom.Polygon(new Array(t))},v=function(e,o){var r={},n=(e=purl(e||$("#owsUrl",a).val())).param();m(n,"service")||(r.SERVICE="WMS"),m(n,"version")||(r.VERSION=o||"1.3.0"),m(n,"request")||(r.REQUEST="GetCapabilities");var i=OpenLayers.Request.GET({url:e.attr("source"),params:r,success:function(e){t&&Portal.Viewer.HideLoading(t);var r=e.responseXML;r&&r.documentElement||(r=e.responseText);var n=function(e,t){var a=null,o=new OpenLayers.Format.WMSCapabilities({version:t,profile:"INSPIRE",allowFallback:!0});try{a=o.read(e)}catch(e){}return a},i=null;if(null==(i=n(r,o))&&"1.3.0"==o&&(i=n(r,"1.1.1")),i&&i.capability&&i.capability.layers){if(i.capability.inspire&&i.capability.inspire.metadataUrl){var l='<div class="top-margin-10"><a class="pull-right" target="_blank" href="'+i.capability.inspire.metadataUrl.url+'">'+d+"</a></div>";$("#div-ows-service",a).empty().html(l)}for(var s=i.capability.layers,c=0;c<s.length;c++){var u=s[c];null!=u.nestedLayers&&0!=u.nestedLayers.length||$("#table-ows-results tbody",a).append(b(i.version,i.capability,s[c]))}$("#div-ows-results",a).show()}else $("#div-ows-error .msg-error",t||a).html(p),$("#div-ows-error",t||a).show(),$("#div-ows-results",a).hide()},failure:function(e){$("#div-ows-error .msg-error",t||a).html(p),$("#div-ows-error",t||a).show(),t&&Portal.Viewer.HideLoading(t)}});t&&Portal.Viewer.ShowLoading(t,!0,i)},y=function(e,o){var r={},n=(e=purl(e||$("#owsUrl",a).val())).param();m(n,"service")||(r.SERVICE="WMTS"),m(n,"version")||(r.VERSION=o||"1.0.0"),m(n,"request")||(r.REQUEST="GetCapabilities");var i=new OpenLayers.Format.WMTSCapabilities({yx:{"urn:ogc:def:crs:EPSG::900913":!0}}),l=OpenLayers.Request.GET({url:e.attr("source"),params:r,success:function(r){var n=r.responseXML;n&&n.documentElement||(n=r.responseText);var l=i.read(n);if(l.contents&&l.contents.layers){for(var s=l.contents.layers,c=0;c<s.length;c++)$("#table-ows-results tbody",a).append(_(e.attr("source"),o||"1.0.0",s[c]));$("#div-ows-results",a).show()}else $("#div-ows-error .msg-error",t||a).html(p),$("#div-ows-error",t||a).show(),$("#div-ows-results",a).hide();Portal.Viewer.HideLoading("div.sidebar")},failure:function(e){$("#div-ows-error .msg-error",t||a).html(p),$("#div-ows-error",t||a).show(),Portal.Viewer.HideLoading("div.sidebar")}});Portal.Viewer.ShowLoading("div.sidebar",!0,l)},w=function(e,o){var r={},n=(e=purl(e||$("#owsUrl",a).val())).param();m(n,"service")||(r.SERVICE="WFS"),m(n,"version")||(r.VERSION=o||"2.0.0"),m(n,"request")||(r.REQUEST="GetCapabilities");var i=OpenLayers.Request.GET({url:e.attr("source"),params:r,success:function(e){var r=e.responseXML;r&&r.documentElement||(r=e.responseText);var n=function(e,t){var a=null,o=new OpenLayers.Format.WFSCapabilities({version:t,profile:"INSPIRE",allowFallback:!0});try{a=o.read(e)}catch(e){}return a},i=null;if(null==(i=n(r,o))&&"2.0.0"==o&&(i=n(r,"1.1.0")),i&&i.featureTypeList&&i.featureTypeList.featureTypes){if(i.inspire&&i.inspire.metadataUrl){var l='<div class="top-margin-10"><a class="pull-right" target="_blank" href="'+i.inspire.metadataUrl.url+'">'+d+"</a></div>";$("#div-ows-service",a).empty().html(l)}for(var s=i.featureTypeList.featureTypes,c=0;c<s.length;c++){s[c];$("#table-ows-results tbody",a).append(C(i.version,i,s[c]))}$("#div-ows-results",a).show()}else $("#div-ows-error .msg-error",t||a).html(p),$("#div-ows-error",t||a).show(),$("#div-ows-results",a).hide();Portal.Viewer.HideLoading("div.sidebar")},failure:function(e){$("#div-ows-error .msg-error",t||a).html(p),$("#div-ows-error",t||a).show(),$("#div-ows-results",a).hide(),Portal.Viewer.HideLoading("div.sidebar")}});Portal.Viewer.ShowLoading("div.sidebar",!0,i)};function b(e,t,a){var o="<tr><td>",n="",i=!1,l="",s="",d="",u="";if(a.name&&""!=a.name){var p=t.request.getmap.get.href;if($.each(a.srs,function(e,t){if("EPSG:3857"==e||e==Portal.Viewer.getMapProjectionCode())return i=!0,l=e,!1}),i||$.each(a.srs,function(e,t){if("EPSG:900913"==e||"EPSG:3785"==e||"ESRI:102113"==e||"ESRI:102100"==e||"EPSG:102113"==e||"EPSG:102100"==e)return i=!0,l=e,!1}),i||$.each(a.srs,function(e,t){if("EPSG:4326"==e||"CRS:84"==e)return i=!0,l=e,!1}),a.queryable||!1,a.styles&&a.styles.length>0&&(s=a.styles[0].name)&&"inspire_common:default"==s.toLowerCase()&&(s="default"),a.minScale&&(d=a.minScale),a.maxScale&&(u=a.maxScale),i){var g=c();r[g]=a,n+='<span class="btn btn-primary btn-sm add-layer pull-right" data-service-type="wms" data-service-version="'+e+'" data-url="'+p+'" data-layer-id="'+g+'" data-layer-name="'+a.name+'" data-layer-title="'+a.title+'" data-layer-crs="'+l+'" data-layer-queryable="'+(a.queryable||!1)+'" data-layer-style="'+s+'" data-layer-min-scale="'+d+'" data-layer-max-scale="'+u+'">Adicionar</span>'}else n+='<div class="alert alert-danger" style="position: inherit; left: 0px;right: 0px;">Sistema de Coordenadas não suportado</div>'}var f="";return a.llbbox&&a.llbbox.length>0&&(f=a.llbbox.join(",")),o+='<a class="a-record" title="'+a.title+'" href="#" data-extent-bbox="'+f+'">'+a.title+"</a>",o+='<div class="abstract muted">'+(a.abstract||"")+"</div>",o+="",o+=n,o+="</td></tr>"}function _(e,t,a){var o="<tr><td>",r="";a.identifier&&""!=a.identifier&&(r+='<span class="btn btn-primary add-layer pull-right" data-service-type="wmts" data-service-version="'+t+'" data-url="'+e+'" data-layer-name="'+a.identifier+'" data-layer-title="'+a.title+'">Adicionar</span>');for(var n='<select id="tileMatrixSets">',i=0;i<a.tileMatrixSetLinks.length;i++){var l=a.tileMatrixSetLinks[i].tileMatrixSet;n=n+'<option value="'+l+'">'+l+"</option>"}return n+="</select>",o+='<a class="a-record" title="'+a.title+'" href="#">'+a.title+"</a>",o+="<p>"+(a.abstract||"")+"</p>",o+=n,o+="",o+=r,o+="</td></tr>"}function C(e,t,a){var o="<tr><td>",r="";if(a.name&&""!=a.name){var n=t.operationsMetadata.GetFeature.dcp.http.get[0].url,i=a.srs;r+='<span class="btn btn-primary btn-sm add-layer pull-right" data-service-type="wfs" data-service-version="'+e+'" data-url="'+n+'" data-layer-name="'+a.name+'" data-layer-title="'+a.title+'" data-layer-crs="'+i+'" data-layer-queryable="true">Adicionar</span>'}var l="";return a.bounds&&a.bounds.left&&(l=a.bounds.left+","+a.bounds.bottom+","+a.bounds.right+","+a.bounds.top),o+='<a class="a-record" title="'+a.title+'" href="#" data-extent-bbox="'+l+'">'+a.title+"</a>",o+='<p class="muted">'+(a.abstract||"")+"</p>",o+="",o+=r,o+="</td></tr>"}var S=function(e,t,a,r,n,i,l,s,c,d,u,p,g,m,h,v,y,w,b){var _,C=o||t,S=(ol.proj.get(l),{});S.LAYERS=a,u&&""!=u?S.SLD=u:S.STYLES=d||"",S.VERSION=c;var x=e;return e.match("\\?$")&&(x=e.slice(0,-1)),s?(S.TILED=!0,_=new ol.layer.Tile({source:new ol.source.TileWMS({url:x,projection:l,params:S,tileLoadFunction:function(e,t){"https:"===window.location.protocol&&"http"==$.url(t).attr("protocol")?e.getImage().src=OpenLayers.ProxyHost+f(t):e.getImage().src=t}}),name:g||"",title:i,group:p||"",extent_layer:v,queryable:m||!1})):_=new ol.layer.Image({source:new ol.source.ImageWMS({url:x,projection:l,params:S,imageLoadFunction:function(e,t){"https:"===window.location.protocol&&"http"==$.url(t).attr("protocol")?e.getImage().src=OpenLayers.ProxyHost+f(t):e.getImage().src=t}}),name:g||"",title:i,group:p||"",extent_layer:v,queryable:m||!1}),(null==h||h)&&C.addLayer(_),_},x=function(e,t,a,r,n,i,l,s){for(var c=o||t,d=ol.proj.get("EPSG:3857"),u=d.getExtent(),p=ol.extent.getWidth(u)/256,g=new Array(14),f=new Array(14),m=0;m<14;++m)g[m]=p/Math.pow(2,m),f[m]=m;var h=new ol.Attribution({html:'Tiles &copy; <a href="http://services.arcgisonline.com/arcgis/rest/services/Demographics/USA_Population_Density/MapServer/">ArcGIS</a>'}),v=new ol.layer.Tile({opacity:.7,extent:u,source:new ol.source.WMTS({attributions:[h],url:e,layer:a,matrixSet:r,format:n,projection:d,tileGrid:new ol.tilegrid.WMTS({origin:ol.extent.getTopLeft(u),resolutions:g,matrixIds:f}),style:"default",title:l})});c.addLayer(v)},P=function(e,t,a,r,n,i,l,s,c,d,u,p){var g=o.getView().getProjection().getCode(),m=e;e.match("\\?$")&&(m=e.slice(0,-1));var h=m+"?service=WFS&request=GetFeature&version="+n+"&typename="+a+"&outputFormat=application/JSON&srsname="+g;return s&&(h=h+"&maxFeatures="+s),new ol.layer.Vector({source:new ol.source.Vector({url:OpenLayers.ProxyHost+f(h),format:new ol.format.GeoJSON}),name:l||"",title:r,group:i||"",extent_layer:p,selectable:c||!1,highlight:d||!1})},k=function(e,t,a,r,n,i,l,s,c){var d=o||t,u=c,p=$("#fileCRS").val();p&&(e.crs={type:"name",properties:{name:p}});var g=new ol.source.Vector({features:new ol.format.GeoJSON({defaultDataProjection:p||"EPSG:4326"}).readFeatures(e,{dataProjection:p||"EPSG:4326",featureProjection:d.getView().getProjection()})});return u||(u={bounds:g.getExtent(),projection:d.getView().getProjection().getCode()}),new ol.layer.Vector({source:g,name:n||"",title:a,group:r||"",extent_layer:u,selectable:i||!1,highlight:l||!1})},L=function(e,t,a,r,n,i,l,s,c){var d=o||r,u=c,p=new ol.source.ImageStatic({url:e,crossOrigin:"",projection:ol.proj.get(t),imageExtent:a});return u||(u={bounds:ol.proj.transformExtent(a,t,d.getView().getProjection().getCode()),projection:d.getView().getProjection().getCode()}),new ol.layer.Image({source:p,name:l||"",title:n,group:i||"",extent_layer:u})};function T(){l=null,$("#formFiles",a).val(""),$("#fileTitle",a).val(""),$(".add-vectorfile-processing",a).hide(),$("#vectorfile-error",a).html(""),$(".add-vectorfile-error",a).hide(),$("#vectorfile-metadata",a).html(""),$(".add-vectorfile-step2",a).hide()}function M(){s=null,$("#formImages",a).val(""),$("#imageTitle",a).val(""),$("#imageMinX",a).val(""),$("#imageMinY",a).val(""),$("#imageMaxX",a).val(""),$("#imageMaxY",a).val(""),$(".add-imagefile-processing",a).hide(),$("#imagefile-error",a).html(""),$(".add-imagefile-error",a).hide(),$("#imagefile-metadata",a).html(""),$(".add-imagefile-step2",a).hide()}return $("#serviceType",a).change(function(e){var t=$(this).val();$("#serviceVersion option",a).hide().removeAttr("selected"),$('#serviceVersion option[data-tipo="'+t+'"]',a).show(),$('#serviceVersion option[data-tipo="'+t+'"]:first',a).attr("selected","selected")}).trigger("change"),$("#serviceList",a).on("click","li",function(e){if($("a",this).data("url")){var o=$("a",this).data("url");if($("#owsUrl",a).val(o),$("a",this).data("version")){var r=$("a",this).data("version");$("#serviceVersion",a).val(r)}else $("#serviceVersion",a).val("1.3.0");if($("a",this).data("ignore-service-url")){var n=$("a",this).data("ignore-service-url");$("#ignorarUrlServico",a).prop("checked",n)}else $("#ignorarUrlServico",a).prop("checked",!1);if($("a",this).data("tiled")){var i=$("a",this).data("tiled");$("#tiled",a).prop("checked",i)}else $("#tiled",a).prop("checked",!0);$("#table-ows-results tbody",a).empty(),$("#div-ows-results",a).hide(),$("#div-ows-error",t||a).hide()}}),$("#btnOWS",a).on("click",function(e){var o=$("#serviceType",a).val(),r=$("#serviceVersion",a).val();$("#table-ows-results tbody",a).empty(),$("#div-ows-results",a).hide(),$("#div-ows-error",t||a).hide(),""==$("#owsUrl",a).val()?($("#div-ows-error .msg-error",a).html(u),$("#div-ows-error",t||a).show()):"wfs"==o.toLowerCase()?w(null,r):"wmts"==o.toLowerCase()?y(null,r):v(null,r)}),$("#btnFilterLayers",a).click(function(e){var t=$("#txtLayersFilter",a).val();t&&""!=t?($("#table-ows-results tr",a).hide(),$("#table-ows-results tr a:icontains('"+t+"')",a).closest("tr").show()):$("tr","#table-ows-results",a).show()}),$("#btnClearFilter",a).click(function(){$("#txtLayersFilter",a).val(""),$("#table-ows-results tr",a).show()}),$("#table-ows-results",a).on("click",".a-record",function(e){var t=$(this).data("extent-bbox");if(t&&""!=t){var a=t.split(","),r=h(a).transform("EPSG:4326",o.getView().getProjection().getCode());o.getView().fit(r.getExtent(),o.getSize())}}).on("mouseenter",".a-record",function(e){var t=Portal.Viewer.getTemporaryLayer();if(null!=$(this).attr("data-extent-bbox")&&""!=$(this).attr("data-extent-bbox")){Portal.Viewer.getMapProjectionCode();var a=Portal.Viewer.getPolygonFromExtent($(this).attr("data-extent-bbox"),",").transform("EPSG:4326",Portal.Viewer.getMapProjectionCode()),o=new ol.Feature({geometry:a,fid:$(this).attr("fid"),modulo:"metadados"});t.getSource().addFeature(o),i=o}else i=null}).on("mouseleave",".a-record",function(e){i&&Portal.Viewer.getTemporaryLayer().getSource().removeFeature(i)}),$("#table-ows-results",a).on("click",".add-layer",function(e){var t=$(this).attr("data-layer-id"),i=$(this).attr("data-url"),l=$(this).attr("data-service-version"),s=$(this).attr("data-layer-name"),c=$(this).attr("data-layer-title"),d=$(this).attr("data-layer-crs"),u=$(this).attr("data-layer-queryable")||!1,p=$(this).attr("data-layer-style");p=$(this).parent().find("select.layer-style").val()||"";$(this).attr("data-layer-min-scale"),$(this).attr("data-layer-max-scale");var g=$(this).attr("data-service-type"),f=$("#tiled",a).is(":checked");$("#ignorarUrlServico",a).is(":checked")&&(i=$("#owsUrl",a).val());var m=null;if($("a.a-record",$(this).parent())&&$("a.a-record",$(this).parent()).length>0){var v=$("a.a-record",$(this).parent())[0],y=$(v).data("extent-bbox");y&&""!=y&&(m={bounds:y.split(","),projection:"EPSG:4326"})}if("wms"==g){var w=S(i,o,s,0,0,c,d,f,l,p,null,null,null,u,!1,m);if(w&&(w.set("queryable",u),w.set("capability",r[t]),n?n.push(w):o.addLayer(w),m)){var b=h(m.bounds).transform(m.projection,o.getView().getProjection().getCode());o.getView().fit(b.getExtent(),o.getSize())}}else if("wmts"==g){var _=$("option:selected",$(this).prev("select")).val()||"EPSG:900913";x(i,o,s,_,"image/png",0,c)}else if("wfs"==g){var C=P(i,0,s,c,l,null,null,null,null,null,0,m);if(C&&(C.set("selectable",u),C.set("highlight",!1),C.set("capability",r[t]),n?n.push(C):o.addLayer(C),m)){b=h(m.bounds).transform(m.projection,o.getView().getProjection().getCode());o.getView().fit(b.getExtent(),o.getSize())}}}),$("#fileFormat",a).on("change",function(e){T(),$("#formFiles",a).get(0).reset(),$("#features-file-import",a).attr("accept",$(this).val())}),$(".btn-import",a).on("click",function(e){$("#formFiles",a).get(0).reset(),$("#features-file-import",a).attr("accept",$("#fileFormat",a).val()),$("#features-file-import",a).trigger("click")}),$("#features-file-import",a).on("change",function(e){if(this.files.length>0){T(),$(".add-vectorfile-processing",a).show();var t=new FormData;t.append("files[]",this.files[0]),$.ajax({url:$("#formFiles",a).attr("action"),type:"POST",data:t,processData:!1,contentType:!1,success:function(e){if(!0===e.Success){l=e.Data,$("#formFiles",a).val(""),$("#fileTitle",a).val(e.Data.metadata.filename),$(".add-vectorfile-processing",a).hide(),$(".add-vectorfile-step2",a).show();var t='<ul style="list-style-type: none; padding-left: 5px;">';t+="<li><strong>Ficheiro:</strong> "+e.Data.metadata.filename+"</li>",t+="<li><strong>Driver:</strong> "+e.Data.metadata.driver+"</li>",t+="<li><strong>Registos:</strong> "+(e.Data.data.features?e.Data.data.features.length:"")+"</li>",t+="<li><strong>Extensão:</strong> "+(e.Data.metadata.extent?e.Data.metadata.extent.map(function(e){return Math.round(e)}).join(", "):"")+"</li>",t+="</ul>",$("#vectorfile-metadata",a).html(t)}else $(".add-vectorfile-processing",a).hide(),$(".add-vectorfile-error",a).show(),$("#vectorfile-error",a).html(e.Message||g)},error:function(e){$(".add-vectorfile-processing",a).hide(),$(".add-vectorfile-error",a).show(),$("#vectorfile-error",a).html(g)}})}}),$("#btn_add_vector_file",a).on("click",function(e){if(l&&l.data){var t=$("#fileTitle",a).val()||l.metadata.filename,r=k(l.data,o,t,null,l.metadata.filename,!0,!0,0,null);n?n.push(r):o.addLayer(r),o.getView().fit(r.getSource().getExtent(),o.getSize())}}),$("#btn_cancel_vector_file",a).on("click",function(e){$("#formFiles",a).get(0).reset(),T()}),$("#imageFormat",a).on("change",function(e){}),$(".btn-import-image",a).on("click",function(e){$("#formImages",a).get(0).reset(),$("#image-file-import",a).attr("accept",$("#imageFormat",a).val()),$("#image-file-import",a).trigger("click")}),$("#image-file-import",a).on("change",function(e){if(this.files.length>0){M(),$(".add-imagefile-processing",a).show();for(var t=new FormData,o=0;o<this.files.length;o++)t.append("files[]",this.files[o]);$.ajax({url:$("#formImages",a).attr("action"),type:"POST",data:t,processData:!1,contentType:!1,success:function(e){if(!0===e.Success){s=e.Data,$("#formImages",a).val(""),$("#imageMinX",a).val(s.metadata.minx),$("#imageMinY",a).val(s.metadata.miny),$("#imageMaxX",a).val(s.metadata.maxx),$("#imageMaxY",a).val(s.metadata.maxy),$("#imageTitle",a).val(e.Data.metadata.filename),$(".add-imagefile-processing",a).hide(),$(".add-imagefile-step2",a).show();var t='<ul style="list-style-type: none; padding-left: 5px;">';t+="<li><strong>Ficheiro:</strong> "+e.Data.metadata.filename+"</li>",t+="<li><strong>Dimensão (pixels):</strong> "+e.Data.metadata.width+" x "+e.Data.metadata.height+"</li>",t+="</ul>",$("#imagefile-metadata",a).html(t)}else $(".add-imagefile-processing",a).hide(),$(".add-imagefile-error",a).show(),$("#imagefile-error",a).html(e.Message||g)},error:function(e){$(".add-imagefile-processing",a).hide(),$(".add-imagefile-error",a).show(),$("#imagefile-error",a).html(g)}})}}),$("#btn_add_image_file",a).on("click",function(e){if(s&&s.metadata){var t=s.metadata.url,r=$("#imageTitle",a).val()||s.metadata.filename,i=$("#imageCRS").val(),l=$("#imageMinX",a).val()||s.metadata.minx,c=$("#imageMinY",a).val()||s.metadata.miny,d=$("#imageMaxX",a).val()||s.metadata.maxx,u=$("#imageMaxY",a).val()||s.metadata.maxy,p=L(t,i,[parseFloat(l),parseFloat(c),parseFloat(d),parseFloat(u)],o,r,null,s.metadata.filename,0,null);n?n.push(p):o.addLayer(p),p.get("extent_layer")&&o.getView().fit(p.get("extent_layer").bounds,o.getSize())}}),$("#btn_cancel_image_file",a).on("click",function(e){$("#formImages",a).get(0).reset(),M()}),{setMap:function(e){o=e},getCapabilities:function(e,o,r){$("#table-ows-results tbody",a).empty(),$("#div-ows-results",a).hide(),$("#div-ows-error",t||a).hide(),_layer={},"wfs"==r.toLowerCase()?w(e,o):"wmts"==r.toLowerCase()?y(e,o):v(e,o)},addWMSLayer:S,addWMTSLayer:x,addWFSLayer:P,addVectorFeaturesLayer:k,addImageStaticLayer:L}}Portal.Viewer=function(){var _config=null,_map=null,_temporaryLayer=null,_rootLayer=null,_buildSelectionStyles=function(){var e=[255,255,255,1],t=[0,255,0,1];return[new ol.style.Style({fill:new ol.style.Fill({color:[255,255,255,.5]})}),new ol.style.Style({stroke:new ol.style.Stroke({color:e,width:5})}),new ol.style.Style({stroke:new ol.style.Stroke({color:t,width:3})}),new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:t}),stroke:new ol.style.Stroke({color:e,width:1.5})}),zIndex:1/0})]},_buildActiveStyles=function(){var e=[255,255,255,1],t=[255,0,0,1],a={};return a[ol.geom.GeometryType.POLYGON]=[new ol.style.Style({fill:new ol.style.Fill({color:[255,255,255,.5]})}),new ol.style.Style({stroke:new ol.style.Stroke({color:[0,153,255,1],width:3})})],a[ol.geom.GeometryType.MULTI_POLYGON]=a[ol.geom.GeometryType.POLYGON],a[ol.geom.GeometryType.LINE_STRING]=[new ol.style.Style({stroke:new ol.style.Stroke({color:e,width:5})}),new ol.style.Style({stroke:new ol.style.Stroke({color:t,width:3})})],a[ol.geom.GeometryType.MULTI_LINE_STRING]=a[ol.geom.GeometryType.LINE_STRING],a[ol.geom.GeometryType.POINT]=[new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:t}),stroke:new ol.style.Stroke({color:e,width:1.5})}),zIndex:1/0})],a[ol.geom.GeometryType.MULTI_POINT]=a[ol.geom.GeometryType.POINT],a[ol.geom.GeometryType.GEOMETRY_COLLECTION]=a[ol.geom.GeometryType.POLYGON].concat(a[ol.geom.GeometryType.POINT]),a},_selectionStyles=_buildSelectionStyles(),_activeStyles=_buildActiveStyles(),_init=function(){},_load=function(e,t){_loadProjections((_config=e).map.projections);for(var a=(new Array).concat(_config.map.baseLayers),o=function(e){e.getLayers().getArray().reverse(),e.getLayers().forEach(function(){this instanceof ol.layer.Group&&o(this.getLayers())})},r=_config.map.tocLayers.reverse(),n=0,i=r.length;n<i;++n)r[n]instanceof ol.layer.Group&&o(r[n]);var l=function(e){if(e instanceof Array)for(var t=0,a=e.length;t<a;++t){var o=e[t];!o.get("roles")||0==o.get("roles").length||$(roles).filter(o.get("roles")||[]).length>0?o instanceof ol.layer.Group&&l(o.getLayers()):e.splice(t,1)}else e.forEach(function(e){!e.get("roles")||0==e.get("roles").length||$(roles).filter(e.get("roles")||[]).length>0?e instanceof ol.layer.Group&&l(e.getLayers()):this.remove(e)},e)};l(r);var s=new ol.layer.Group({layers:(new Array).concat(r),group:"toc-root-group"});a=(a=a.concat([s])).concat(_config.map.overlayLayers);var c={projection:ol.proj.get(_config.map.projection)};_config.map.maxZoom&&(c.maxZoom=_config.map.maxZoom),_config.map.minZoom&&(c.minZoom=_config.map.minZoom),_config.map.zoomFactor&&(c.zoomFactor=_config.map.zoomFactor),_config.map.maxResolution&&(c.maxResolution=_config.map.maxResolution),_config.map.minResolution&&(c.minResolution=_config.map.minResolution),_config.map.restrictedExtent&&_config.map.restrictedExtent.bounds&&(c.extent=ol.proj.transformExtent(_config.map.restrictedExtent.bounds,_config.map.restrictedExtent.projection||ol.proj.get(_config.map.projection),ol.proj.get(_config.map.projection))),_config.map.center&&(_config.map.center.x&&_config.map.center.y&&(c.center=ol.proj.transform([_config.map.center.x,_config.map.center.y],_config.map.center.projection||_config.map.displayProjection||_config.map.projection,_config.map.projection)),_config.map.center.zoom&&(c.zoom=_config.map.center.zoom));new ol.control.Attribution({collapsible:!1});var d=new ol.Map({controls:ol.control.defaults({zoom:!1,attribution:!1,rotate:!1}),target:t,layers:a,overlays:[],view:new ol.View(c)});return _setMap(d),_rootLayer=s,_setLayersResolutionFromMaxMinScale(),_map},_setLayersResolutionFromMaxMinScale=function(){var e=[];for(_loadAllLayersAsArray(_rootLayer,e),j=0;j<e.length;j++){if(e[j].get("minScale")){var t=_getResolutionFromScale(e[j].get("minScale"));e[j].setMaxResolution(t)}if(e[j].get("maxScale")){t=_getResolutionFromScale(e[j].get("maxScale"));e[j].setMinResolution(t)}}},_getResolutionFromScale=function(e){var t=_map.getView().getProjection().getUnits();return e/(39.37*ol.proj.METERS_PER_UNIT[t]*(25.4/.28))},_getScaleFromResolution=function(e){var t=_map.getView().getProjection().getUnits();return e*ol.proj.METERS_PER_UNIT[t]*39.37*(25.4/.28)},_loadProjections=function(e){for(var t=0;t<e.length;++t){var a=e[t];if(!ol.proj.get(a.code)&&a.definition){proj4.defs(a.code,a.definition);var o=ol.proj.get(a.code);a.extent&&o.setExtent(a.extent),a.worldExtent&&o.setWorldExtent(a.worldExtent);var r=new ol.proj.Projection({code:a.code,extent:a.extent||null,worldExtent:a.worldExtent||null,units:a.units||"m"});ol.proj.addProjection(r)}var n=a.code.split(":")[1];proj4.defs("http://www.opengis.net/gml/srs/epsg.xml#"+n,a.definition);var i=new ol.proj.Projection({code:"http://www.opengis.net/gml/srs/epsg.xml#"+n,extent:a.extent,units:a.units||"m"});ol.proj.addProjection(i);ol.proj.get("http://www.opengis.net/gml/srs/epsg.xml#"+n);proj4.defs("urn:ogc:def:crs:EPSG::"+n,a.definition);i=new ol.proj.Projection({code:"urn:ogc:def:crs:EPSG::"+n,extent:a.extent,units:a.units||"m"});ol.proj.addProjection(i);ol.proj.get("urn:ogc:def:crs:EPSG::"+n)}},_loadAllLayersAsArray=function(e,t){if(e instanceof Array)for(var a=0;a<e.length;a++)_loadAllLayersAsArray(e[a],t);else if(e instanceof ol.layer.Group){t.push(e);var o=e.getLayers().getArray();for(a=0;a<o.length;a++)o[a]instanceof ol.layer.Group?_loadAllLayersAsArray(o[a],t):t.push(o[a])}else t.push(e)},_showLoading=function(e,t,a){var o={message:'<div class="loading-indicator"><div class="progress progress-striped active"><div class="progress-bar progress-bar-info" style="width: 100%"></div></div></div>',overlayCSS:{backgroundColor:"#000",opacity:.1,cursor:"wait"},css:{border:"0px solid #aaa",width:"50%",backgroundColor:""},onOverlayClick:$.unblockUI};e?(t&&(o.onOverlayClick=function(t){a&&a.abort(),$(e).unblock()}),$(e).block(o)):(t&&(o.onOverlayClick=function(e){a&&a.abort(),$.unblockUI()}),o.message='<div class="loading-indicator"><div class="progress progress-striped active"><div class="progress-bar progress-bar-info" style="width: 100%"></div></div></div>',o.css.width="10%",o.css["margin-left"]="100px",$.blockUI(o))},_hideLoading=function(e){e?$(e).unblock():$.unblockUI()},_setMap=function(e){for(var t=null,a=(_map=e).getLayers().getArray(),o=0;o<a.length;o++)if("drawtools-layer"==a[o].get("name")){t=a[o];break}null==t&&(t=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),name:"drawtools-layer",group:"vector"})),_map.addLayer(t),_drawtoolsLayer=t,t=null;for(o=0;o<a.length;o++)if("temporary-layer"==a[o].get("name")){t=a[o];break}null==t&&(t=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),name:"temporary-layer",group:"vector"})),_map.addLayer(t),_temporaryLayer=t},_getMap=function(){return _map},_getMapProjectionCode=function(){return _map.getView().getProjection().getCode()},_getMapSRID=function(){return _getMapProjectionCode().split(":")[1]},_getMapCurrentScale=function(){var e=_map.getView(),t=e.getResolution(),a=e.getProjection().getUnits();return t*(e.getProjection().getMetersPerUnit()||ol.proj.METERS_PER_UNIT[a])*39.37*(25.4/.28)},_getTemporaryLayer=function(){return _temporaryLayer},_getDrawtoolsLayer=function(){return _drawtoolsLayer},_getFeaturesTemporaryLayer=function(e,t){for(var a=[],o=_temporaryLayer.getSource().getFeatures(),r=0;r<o.length;r++){var n=o[r];e&&n.get("modulo")!=e||t&&n.get("gid")!=t||a.push(n)}return a},_getPolygonFromExtent=function(e,t){var a=null;a="string"==typeof e?e.split(t||" "):e;var o=[[parseFloat(a[0]),parseFloat(a[3])],[parseFloat(a[2]),parseFloat(a[3])],[parseFloat(a[2]),parseFloat(a[1])],[parseFloat(a[0]),parseFloat(a[1])],[parseFloat(a[0]),parseFloat(a[3])]];return new ol.geom.Polygon(new Array(o))},_getTransformedGeometry=function(e,t){var a=new ol.format.WKT,o=e.split(";")[0].split("=")[1],r=e.split(";")[1];return a.readGeometry(r).transform("EPSG:"+o,t)},_getWKTFromGeometry=function(e){return(new ol.format.WKT).writeGeometry(e)},_getSelectionStyles=function(){return _selectionStyles},_getActiveStyles=function(){return _activeStyles},_getConfig=function(){return _config},_getId=function(){return _config.id},_showDirectory=function(element){var url=$(element).data("action"),title=$(element).data("title")||"Documentos",filter=$(element).data("filter"),recursive=$(element).data("recursive"),width=eval($(element).data("width")),height=eval($(element).data("height"));$.jsPanel({id:this.generateID,contentAjax:{url:url,data:{mapId:Portal.Viewer.getMapId()||null,filter:filter,recursive:recursive},done:function(e,t,a,o){this.content.empty().append(e.Message)},fail:function(e){this.setTheme("danger").headerTitle('<i class="fa fa-exclamation-triangle"></i> Request failed').content.empty().append(e.responseText)},always:function(e,t,a,o){}},headerTitle:title,panelSize:{width:width||function(){return $(window).width()/5},height:height||275},dragit:{containment:"window"},contentOverflow:{horizontal:"hidden",vertical:"auto"},headerControls:{controls:"closeonly"},content:'<div class="msg"><p>Aguarde...</p></div>',onclosed:function(e,t){},onwindowresize:function(e,t){}})},_showPanel=function(e){if(e&&!$(".menu-bar-widget."+e).hasClass("open")){var t=$(".menu-button."+e);t.length>0&&t.trigger("click")}},_showEditor=function(element,modal,oncontentload,onpanelclosed){var url=$(element).data("action"),title=$(element).data("layer-title")||"",width=eval($(element).data("width")),height=eval($(element).data("height"));$.jsPanel({id:this.generateID,paneltype:modal?"modal":"",theme:"bootstrap-primary",show:"animated fadeInDownBig",content:'<div style="padding: 20%"><div class="loading-indicator"><div class="progress progress-striped active"><div class="progress-bar progress-bar-info" style="width: 100%"></div></div></div></div>',oncontentload:oncontentload||null,contentAjax:{url:url,data:{mapId:Portal.Viewer.getMapId()||null},done:function(e,t,a,o){var r=[{item:"<button type='button'></button>",event:jsPanel.evtStart,btnclass:"btn btn-danger btn-sm",btntext:" Fechar",callback:function(e){e.stopPropagation(),e.data.close()}}];"write"==e.Data.mode&&r.unshift({item:"<button type='button'></button>",event:jsPanel.evtStart,btnclass:"btn btn-primary btn-sm",btntext:" Gravar",callback:function(e){e.stopPropagation(),$(".form-main",e.data).submit()}}),this.content.empty().append(e.Message),this.toolbarAdd("footer",r),$(this).on("submit",".form-main",{panel:o},function(e){e.preventDefault;var t=e.data.panel,a=$(this).attr("action"),o=$(this).serialize();return $.ajax({type:"POST",url:a,traditional:!0,data:o,params:{panel:t},beforeSend:function(){Portal.Viewer.ShowLoading($(".jsPanel-content",this.params.panel))},success:function(e){this.params.panel.content.empty().append(e.Message)},complete:function(){Portal.Viewer.HideLoading($(".jsPanel-content",this.params.panel))},error:function(e){}}),!1}),$(this).on("click",".open-external-link",{panel:o},function(e){e.preventDefault();var t=$("input",$(e.target).parent().parent()).val();return t&&window.open(t),!1}),o.option.oncontentload&&o.option.oncontentload(o)},fail:function(e){},always:function(e,t,a,o){}},headerTitle:title,panelSize:{width:width||function(){return $(window).width()/4},height:height||function(){return $(window).height()/2}},dragit:{containment:"window"},contentOverflow:{horizontal:"hidden",vertical:"auto"},onclosed:onpanelclosed||null})},_getRootLayer=function(){return _rootLayer},_getGeometryArea=function(e){var t;switch(e.getType()){case"MultiPolygon":t=e.getPolygons().reduce(function(e,t){return e+t.getArea()},0);break;case"Polygon":t=e.getArea();break;default:t=0}return t},_showLayer=function(e,t,a){var o=e;t=t;o.get("id")!=t?o instanceof ol.layer.Group&&o.getLayers().forEach(function(e){return e.get("id")==t?void e.set("visible",!0):void Portal.Viewer.showLayer(e,t,o)}):a?a.set("visible",!0):o.set("visible",!0)},_getLayerById=function(e,t){if(e.get("id")==t)return e;if(e instanceof ol.layer.Group){for(var a=e.getLayers().getArray(),o=null,r=0;r<a.length;r++){if(a[r].get("id")==t){o=a[r];break}if(o=_getLayerById(a[r],t))break}return o}},_getLayerByLayerId=function(e,t){if(e.get("layer-id")==t)return e;if(e instanceof ol.layer.Group){for(var a=e.getLayers().getArray(),o=null,r=0;r<a.length;r++){if(a[r].get("layer-id")==t){o=a[r];break}if(o=_getLayerById(a[r],t))break}return o}},_getFeature=function(e,t){var a=_getConfig().map.proxy+"?url="+e.url,o=(new ol.format.WFS).writeGetFeature({srsName:"EPSG:"+_getMapSRID(),featureNS:e.featureNS,featurePrefix:e.featurePrefix,featureTypes:e.featureTypes,outputFormat:e.outputFormat||"application/json",filter:ol.format.ogc.filter.equalTo(e.fieldFilter,e.valueFilter)}),r=null;$.ajax({type:"POST",contentType:"text/xml",dataType:"text",url:a,data:(new XMLSerializer).serializeToString(o),dataParams:{map:_map},success:function(e){var t=JSON.parse(e);r=(new ol.format.GeoJSON).readFeatures(t)},error:function(e){},complete:function(e){t(r)}})};return{Init:_init,Load:_load,ShowLoading:_showLoading,HideLoading:_hideLoading,ShowPanel:_showPanel,ShowDirectory:_showDirectory,ShowEditor:_showEditor,setMap:_setMap,getMap:_getMap,getMapProjectionCode:_getMapProjectionCode,getMapSRID:_getMapSRID,getMapCurrentScale:_getMapCurrentScale,getTemporaryLayer:_getTemporaryLayer,getDrawtoolsLayer:_getDrawtoolsLayer,getFeaturesTemporaryLayer:_getFeaturesTemporaryLayer,getPolygonFromExtent:_getPolygonFromExtent,getTransformedGeometry:_getTransformedGeometry,getWKTFromGeometry:_getWKTFromGeometry,getSelectionStyles:_getSelectionStyles,getActiveStyles:_getActiveStyles,getConfig:_getConfig,getMapId:_getId,getRootLayer:_getRootLayer,getLayerById:_getLayerById,getLayerByLayerId:_getLayerByLayerId,getGeometryArea:_getGeometryArea,showLayer:_showLayer,getFeature:_getFeature,getResolutionFromScale:_getResolutionFromScale,getScaleFromResolution:_getScaleFromResolution}}(),Portal.Viewer.Coordenadas=function(){var e,t,a,o=function(o,r){var n=$("#code",o).val(),i=$("#code option:selected",o).data("srid"),l=$("#code option:selected",o).data("unidades"),s=$("#x",o).val(),c=$("#y",o).val();if("d"==l){var d=$("[name=opt-unidades]:checked",o).val();if("dd"==d)s=parseFloat($("#lon-dd",o).val()),"W"==$("#lon-dd-sign",o).val()&&(s*=-1),c=parseFloat($("#lat-dd",o).val()),"S"==$("#lat-dd-sign",o).val()&&(c*=-1);else if("dms"==d){s=Portal.Viewer.Coordenadas.ConvertDMS2DD($("#lon-dms-sign",o).val()+" "+$("#lon-dms",o).val()),c=Portal.Viewer.Coordenadas.ConvertDMS2DD($("#lat-dms-sign",o).val()+" "+$("#lat-dms",o).val())}}else if("dm"==l){s=Portal.Viewer.Coordenadas.ConvertDM2DD($("#lon-dm-sign",o).val()+" "+$("#lon-dm",o).val()),c=Portal.Viewer.Coordenadas.ConvertDM2DD($("#lat-dm-sign",o).val()+" "+$("#lat-dm",o).val())}var u={code:n,srid:i,x:s,y:c,mapSrid:Portal.Viewer.getMapSRID()};Portal.Viewer.ShowLoading($(e).closest(".menu-bar-body")[0]),$.ajax({type:"POST",url:o.attr("action"),traditional:!0,data:$.param(u),success:function(o){if($("#resultsCoordenadas").html(""),o.Success){$("#resultsCoordenadas").html(o.Message);var n,i=[o.Data.x,o.Data.y],l=Portal.Viewer.getMap(),s=Portal.Viewer.getTemporaryLayer();if(s&&(n=s.getSource())&&a)try{n.removeFeature(a)}catch(e){}a=new ol.Feature({geometry:new ol.geom.Point(i)}),s.getSource().addFeature(a),t.setFeature(a),r&&(l.getView().setZoom(15),l.getView().setCenter(i))}Portal.Viewer.HideLoading($(e).closest(".menu-bar-body")[0])},error:function(t){$("#searchCoordenadas").next(".results-area").html(""),Portal.Viewer.HideLoading($(e).closest(".menu-bar-body")[0])}})};return{Init:function(){},Load:function(t){e="#"+t;var a=function(e){var t=e||window.event,a=t.keyCode||t.which;return 8==a||46==a||9==a||17==a||91==a||18==a||116==a||89==a||67==a||88==a||35==a||36==a||16==a||86==a||190==a||a>=37&&a<=40||a>=48&&a<=57||a>=96&&a<=105||(t.preventDefault&&t.preventDefault(),void(t.returnValue=!1))},r=function(e){var t=e||window.event,a=t.keyCode||t.which;return 8==a||46==a||9==a||17==a||91==a||18==a||116==a||89==a||67==a||88==a||35==a||36==a||16==a||86==a||189==a||173==a||109==a||190==a||a>=37&&a<=40||a>=48&&a<=57||a>=96&&a<=105||(console.log("Not allowed key pressed "+a),t.preventDefault&&t.preventDefault(),void(t.returnValue=!1))};$("#x",e).keydown(r),$("#y",e).keydown(r),$("#lon-dd",e).keydown(a),$("#lat-dd",e).keydown(a),$("#code",e).change(function(t){var a=$("option:selected",this),o=$(a).data("unidades")||"m";$(".coords",e).removeClass("hidden").addClass("hidden"),$(".coords.coords-"+o,e).removeClass("hidden")}),$(".opt-unidades",e).change(function(e){var t=$(this).closest("form");if($("div[data-unidades]",t).hide(),$('div[data-unidades="'+$(this).val()+'"]',t).show(),"dms"==$(this).val()){var a=0+$("#lon-dd",t).val(),o=0+$("#lat-dd",t).val(),r=Portal.Viewer.Coordenadas.ConvertDD2DMS(parseFloat(a),!0),n=Portal.Viewer.Coordenadas.ConvertDD2DMS(parseFloat(o),!1);r&&n?($("#lon-dms",t).val(r),$("#lon-dms-sign",t).val($("#lon-dd-sign",t).val()),$("#lat-dms",t).val(n),$("#lat-dms-sign",t).val($("#lat-dd-sign",t).val())):($("#lon-dms",t).val(""),$("#lat-dms",t).val(""))}else{var i=$("#lon-dms-sign",t).val()+" "+$("#lon-dms",t).val(),l=$("#lat-dms-sign",t).val()+" "+$("#lat-dms",t).val();r=Portal.Viewer.Coordenadas.ConvertDMS2DD(i),n=Portal.Viewer.Coordenadas.ConvertDMS2DD(l),r&&n?($("#lon-dd",t).val(Math.round(1e7*Math.abs(r))/1e7),r<0?$("#lon-dd-sign",t).val("W"):$("#lon-dd-sign",t).val("E"),$("#lat-dd",t).val(Math.round(1e7*Math.abs(n))/1e7),n<0?$("#lat-dd-sign",t).val("S"):$("#lat-dd-sign",t).val("N")):($("#lon-dd",t).val(""),$("#lat-dd",t).val(""))}}),$(e).submit(function(e){e.preventDefault(),o($(this),!0)})},SetControl:function(e){t=e},Transform:function(t,a){var r=(Math.round(1e3*t)/1e3).toString().replace(".",".").replace(",","."),n=(Math.round(1e3*a)/1e3).toString().replace(".",".").replace(",",".");$("#code",e).val(Portal.Viewer.getMapProjectionCode()).trigger("change"),$("#x",e).val(r),$("#y",e).val(n),o($(e),!1)},ConvertDD2DMS:function(e,t){var a=Math.floor(e),o=60*(e-a),r=Math.floor(o),n=60*(o-r),i=parseFloat(Math.round(100*n)/100).toFixed(2);return t?("000"+a).slice(-3)+"º "+("00"+r).slice(-2)+"' "+("0000"+i).slice(-5)+"''":("00"+a).slice(-2)+"º "+("00"+r).slice(-2)+"' "+("0000"+i).slice(-5)+"''"},ConvertDMS2DD:function(e){var t=null,a=e.replace("º","").replace("''","").replace("'","").split(" ");return a[1]=parseInt(a[1]),a[2]=parseInt(a[2]),a[3]=parseFloat(a[3]),t=a[1]+a[2]/60+a[3]/3600,"W"!=a[0]&&"S"!=a[0]||(t*=-1),t},ConvertDM2DD:function(e){var t=null,a=e.replace("º","").replace("'","").split(" ");return a[1]=parseInt(a[1]),a[2]=parseFloat(a[2]),t=a[1]+a[2]/60,"W"!=a[0]&&"S"!=a[0]||(t*=-1),t},Disable:function(){var e,t=Portal.Viewer.getTemporaryLayer();t&&(e=t.getSource())&&a&&e.removeFeature(a),a=null}}}(),Portal||(Portal={}),Portal.Viewer||(Portal.Viewer={}),Portal.Viewer.PDM=function(){var e,t,a,o,r={},n={srid:3763,geomEWKT:"",format:""},i=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#1b465a",width:5}),image:new ol.style.Circle({fill:new ol.style.Fill({color:"#ff0000"}),stroke:new ol.style.Stroke({color:"#1b465a",width:5}),radius:6})});return{Init:function(){},Load:function(l){$(l).on("click","#btnShowAnalisePDM",function(e){$(".pdm-steps",l).hide(),$("#pdm-step-1",l).show()}),$(l).on("click",".doc-group-header",function(e){e.preventDefault(),$(this).parent().next("div").toggle()}),$(l).on("click",".step-back",function(e){e.preventDefault(),o&&o.disableControl();var r=$(this).data("step");a&&Portal.Viewer.getTemporaryLayer().getSource().removeFeature(a),a=null,t.getSource().clear&&t.getSource().clear(),$("#pdm-results").empty().html(""),$("#validation",l).empty().html(""),$(".pdm-steps",l).hide(),$(r,l).show()}),function(e){var t=Portal.Viewer.getMap(),n=Portal.Viewer.getTemporaryLayer().getSource(),l=function(e){var t=Portal.Viewer.getTemporaryLayer();t&&t.getSource().clear()},s=function(e){e.feature.set("modulo","pdm"),e.feature.setStyle(i),a=e.feature},c=new ol.interaction.Draw({source:n,type:"Point"});c.on("drawstart",l),c.on("drawend",s),r.ctrlPDMCreatePoint=c,(c=new ol.interaction.Draw({source:n,type:"LineString"})).on("drawstart",l),c.on("drawend",s),r.ctrlPDMCreateLine=c,(c=new ol.interaction.Draw({source:n,type:"Polygon"})).on("drawstart",l),c.on("drawend",s),r.ctrlPDMCreatePolygon=c,o=new app.genericDrawControl({layer:Portal.Viewer.getTemporaryLayer(),onEnableControl:function(e,t){},onDisableControl:function(t){$(".btn-group[data-group='btn-geometry'] a",e).removeClass("active")}}),t.addControl(o)}(l),$(l).on("click",'.btn-group[data-group="btn-geometry"] button',function(e){var t=!$(this).hasClass("active");if($(".btn-group[data-group='btn-geometry'] button",l).removeClass("active"),t){$(this).addClass("active");var n=$(this).attr("data-button-id");if("ctrlPDMModifyGeometry"==n){var s=new ol.interaction.Modify({features:new ol.Collection(Portal.Viewer.getTemporaryLayer().getSource().getFeatures()),deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}});o.enableControl(e,s)}else if("ctrlPDMSelectGeometry"==n){var c=new ol.interaction.Select({condition:ol.events.condition.click});o.enableControl(e,c),c.on("select",function(e){var t=Portal.Viewer.getTemporaryLayer();if(t){for(var o=t.getSource(),r=o.getFeatures(),n=r.length-1;n>=0;n--){var i=r[n];i.get("modulo")==this.modulo&&o.removeFeature(i)}if(e.target.getFeatures()&&e.target.getFeatures().getLength()>0)for(var l=e.target.getFeatures().getArray(),s=0;s<l.length;s++){var c=l[s],d=new ol.Feature;d.setStyle(this.style),d.set("modulo",this.modulo),c.getGeometry()instanceof ol.geom.MultiPoint?d.setGeometry(c.getGeometry().clone().getPoint(0)):c.getGeometry()instanceof ol.geom.MultiLineString?d.setGeometry(c.getGeometry().clone().getLineString(0)):c.getGeometry()instanceof ol.geom.MultiPolygon?d.setGeometry(c.getGeometry().clone().getPolygon(0)):d.setGeometry(c.getGeometry().clone()),o.addFeature(d),a=d,e.target.getFeatures().clear();break}}},{style:i,modulo:"pdm"})}else o.enableControl(e,r[n])}else o.disableControl(e)}),$(l).on("click",'.btn-group button[id="btnPDMZoomGeometry"]',function(t){a&&e.getView().fit(ol.extent.buffer(a.getGeometry().getExtent(),200),e.getSize())}),$(l).on("click","#btnPDMClearGeometry",function(e){a&&Portal.Viewer.getTemporaryLayer().getSource().removeFeature(a),a=null}),$(l).on("click","#btnAnalisar",function(e){if(e.preventDefault(),o&&o.disableControl(),!a)return $("#validation",l).empty().html("<div class='alert alert-danger'>É obrigatório indicar no mapa o local de confrontação com o PDM</div>").show(),!1;t.getSource().clear&&t.getSource().clear(),$("#pdm-results").empty().html(""),$("#validation",l).empty().html("");var r=$(this).attr("data-action"),i=3763;$("#srid",l).length>0&&(i=$("#srid",l).val());var s=new ol.format.WKT,c=null;a&&(c=s.writeGeometry(a.getGeometry()),c="SRID="+Portal.Viewer.getMapSRID()+";"+c),n={srid:i,geomEWKT:c},$.ajax({type:"POST",url:r,traditional:!0,data:{srid:i,geomEWKT:c,mapId:$("#map_id").val()},beforeSend:function(){Portal.Viewer.ShowLoading(".menu-bar.pdm .menu-bar-body")},success:function(e){e.Success?($("#pdm-results").html(e.Message),$(".btnExportIntersectPDM",l).each(function(){var e=$(this).data("action"),t=$(this).data("format"),a=$.extend({format:t},n),o=$.param(a);$(this).attr("href",e+"?"+o)})):null!=e.Data&&e.Data.info&&$("#validation",l).empty().html(e.Message)},complete:function(){Portal.Viewer.HideLoading(".menu-bar.pdm .menu-bar-body")},error:function(e){}})}),$(l).on("click",".tree-toggler.nav-header",function(e){$(this).next().toggle()}),$(l).on("click",".results-pdm-geom",function(e){t.getSource().clear(),$(".results-pdm-geom",l).each(function(){if(this.checked&&null!=$(this).attr("data-geom")&&""!=$(this).attr("data-geom")){var e=$(this).data("geom"),a={recordId:$(this).data("record-id")};if(null!=e&&e.length>0){var o=Portal.Viewer.getTransformedGeometry(e,Portal.Viewer.getMapProjectionCode());a.geometry=o}var r=new ol.Feature(a);t.getSource().addFeature(r)}})}),$(l).on("click","#chkLocal",function(e){var t=Portal.Viewer.getTemporaryLayer();this.checked?a&&t.getSource().addFeature(a):a&&t.getSource().removeFeature(a)})},setMap:function(a){for(var o=null,r=(e=a).getLayers().getArray(),n=0;n<r.length;n++)if("viewer-pdm-layer"==r[n].get("name")){o=r[n];break}null==o&&(o=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),name:"viewer-pdm-layer",group:"vector"})),e.addLayer(o),t=o}}}(),Portal||(Portal={}),Portal.Viewer||(Portal.Viewer={}),Portal.Viewer.Print=function(){var e,t,a,o={},r=!1,n=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#1b465a",width:5}),image:new ol.style.Circle({fill:new ol.style.Fill({color:"#ff0000"}),stroke:new ol.style.Stroke({color:"#1b465a",width:5}),radius:6})}),i=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgba(200, 200, 200, 0.8)",width:5,lineDash:[4,8]})}),name:"paperbox-layer",group:"print"}),s=function(e){$("#validation",e).empty().html("").hide();var t=!0,a="<div class='alert alert-danger'>";if($("[data-required-geom]",e).length>0){var o=Portal.Viewer.getTemporaryLayer().getSource().getFeatures(),r=$.grep(o,function(e){return!(!e.get("modulo")||"print"!=e.get("modulo"))});r&&0!=r.length||(t=!1,a=a+"<div>"+$("[data-required-geom]",e).data("required-msg")+"</div>")}if($("#userscale",e).hasClass("active")){var n=parseInt($("#escalaDenom",e).val());(!n||n<500||n>5e5)&&(t=!1,a+="<div>O valor da escala definida não é correcto</div>")}return $("[data-required]",e).length>0&&$.each($("[data-required]",e),function(e,o){""==$(o).val()&&(t=!1,a=a+"<div>"+$(o).data("required-msg")+"</div>")}),t||(a+="</div>",$("#validation",e).empty().html(a).show()),t};return{Init:function(){},Load:function(c){!function(e){var r=Portal.Viewer.getMap(),i=Portal.Viewer.getTemporaryLayer().getSource(),l=function(e){var t=Portal.Viewer.getTemporaryLayer(),a=Portal.Viewer.Print.getMultiGeom();if(t){var o=t.getSource();if(!a)for(var r=o.getFeatures(),n=r.length-1;n>=0;n--){var i=r[n];"print"==i.get("modulo")&&o.removeFeature(i)}}},s=function(e){e.feature.set("modulo","print"),e.feature.setStyle(n),t=e.feature},c=new ol.interaction.Draw({source:i,type:"Point"});c.on("drawstart",l),c.on("drawend",s),o.ctrlPrintCreatePoint=c,(c=new ol.interaction.Draw({source:i,type:"LineString"})).on("drawstart",l),c.on("drawend",s),o.ctrlPrintCreateLine=c,(c=new ol.interaction.Draw({source:i,type:"Polygon"})).on("drawstart",l),c.on("drawend",s),o.ctrlPrintCreatePolygon=c,a=new app.genericDrawControl({layer:Portal.Viewer.getTemporaryLayer(),onEnableControl:function(e,t){},onDisableControl:function(t){$(".btn-group[data-group='btn-geometry'] button",e).removeClass("active")}}),r.addControl(a)}(c=c),$(c).on("click",".btn-group[data-group='btn-geometry'] button",function(e){var t=!$(this).hasClass("active");if($(".btn-group[data-group='btn-geometry'] button",c).removeClass("active"),t){$(this).addClass("active");var r=$(this).attr("data-button-id");if("1"==$(this).closest("div.btn-toolbar.geometry-buttons").data("multi-geom")?Portal.Viewer.Print.setMultiGeom(!0):Portal.Viewer.Print.setMultiGeom(!1),"ctrlPrintModifyGeometry"==r){var i=[];Portal.Viewer.getTemporaryLayer().getSource().getFeatures().forEach(function(e){"print"==e.get("modulo")&&i.push(e)});var l=new ol.interaction.Modify({features:new ol.Collection(i),deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}});a.enableControl(e,l)}else if("ctrlPrintSelectGeometry"==r){var s=new ol.interaction.Select({condition:ol.events.condition.click});a.enableControl(e,s),s.on("select",function(e){var t=Portal.Viewer.getTemporaryLayer();if(t){var a=t.getSource(),o=a.getFeatures();if(!Portal.Viewer.Print.getMultiGeom())for(var r=o.length-1;r>=0;r--){var n=o[r];n.get("modulo")==this.modulo&&a.removeFeature(n)}if(e.target.getFeatures()&&e.target.getFeatures().getLength()>0)for(var i=e.target.getFeatures().getArray(),l=0;l<i.length;l++){var s=i[l],c=new ol.Feature;c.setStyle(this.style),c.set("modulo",this.modulo),c.setGeometry(s.getGeometry().clone()),a.addFeature(c),Portal.Viewer.Print.setFeature(c),e.target.getFeatures().clear();break}}},{style:n,modulo:"print"})}else a.enableControl(e,o[r])}else a.disableControl(e)}),$(c).on("click",".btn-group button[id='btnPrintZoomGeometry']",function(a){var o=null;if(r)for(var n=Portal.Viewer.getTemporaryLayer().getSource().getFeatures(),i=0;i<n.length;i++){var l=n[i];"print"==l.get("modulo")&&(o=o?ol.extent.extend(o,l.getGeometry().getExtent()):l.getGeometry().getExtent())}else t&&(o=t.getGeometry().getExtent());o&&e.getView().fit(ol.extent.buffer(o,200),e.getSize())}),$(c).on("click","#btnPrintClearGeometry",function(){if(r)for(var e,a=(e=Portal.Viewer.getTemporaryLayer().getSource()).getFeatures(),o=a.length-1;o>=0;o--){var n=a[o];"print"==n.get("modulo")&&e.removeFeature(n)}else t&&(e=Portal.Viewer.getTemporaryLayer().getSource()).removeFeature(t);t=null}),$(c).on("click","#btnPrintGrupo",{parentId:c},function(e){var t=$(this).data("action"),o=$(this).data("id"),r=null,n=e.data.parentId;if(a&&a.disableControl(),!s(n))return!1;var i=Portal.Viewer.getTemporaryLayer().getSource().getFeatures(),l=$.grep(i,function(e){return!(!e.get("modulo")||"print"!=e.get("modulo"))});if(l&&l.length>0)for(r=[],j=0;j<l.length;j++)r.push(Portal.Viewer.getWKTFromGeometry(l[j].getGeometry()));var c=$("#layout",n).val();$.ajax({type:"POST",url:t,data:{id:o,layout:c,geom_filter:r,geom_srid:Portal.Viewer.getMapSRID(),mapa_id:$("#map_id").val()},beforeSend:function(){Portal.Viewer.ShowLoading(".menu-bar-widget.print .menu-bar-body")},success:function(e){e.Success?($("#print-step-2",n).empty().html(e.Message),$(".print-steps",n).hide(),$("#print-step-2",n).show()):null!=e.Data&&e.Data.info&&$("#validation",n).empty().html(e.Message)},complete:function(){Portal.Viewer.HideLoading(".menu-bar-widget.print .menu-bar-body")},error:function(e){}})}),$(".planta-row-title a",c).click({parentId:c},function(e){e.preventDefault();var t=e.data.parentId,a=$(this).data("action"),o=$(this).data("mapa-id"),r=$(this).data("id");if(""==r)return $(".print-steps",t).hide(),$("#print-step-0",t).show(),!1;$.ajax({type:"POST",url:a,traditional:!0,data:{mapa_id:o,id:r},beforeSend:function(){Portal.Viewer.ShowLoading(".menu-bar-widget.print .menu-bar-body")},success:function(e){e.Success?($("#print-step-1",t).empty().html(e.Message),$(".print-steps",t).hide(),$("#print-step-1",t).show()):null!=e.Data&&e.Data.info&&$("#validation",t).empty().html(e.Message)},complete:function(){Portal.Viewer.HideLoading(".menu-bar-widget.print .menu-bar-body")},error:function(e){}})}),$(c).on("click",".step-back",{parentId:c},function(e){e.preventDefault(),a&&a.disableControl();var t=e.data.parentId,o=$(this).data("step"),r=$(this).data("step-clear-back"),n=$(this).closest(".print-steps");$(".print-steps",t).hide(),$(o,t).show(),r&&n.length>0&&(n.find("*").off(),n.empty().html(""))}),$(c).on("click",".select-all",{parentId:c,map:e,feature:t},function(e){return e.preventDefault(),$(".print-list span.icon",c).removeClass("unchecked-icon").addClass("checked-icon"),!1}),$(c).on("click",".unselect-all",{parentId:c,map:e,feature:t},function(e){return e.preventDefault(),$(".print-list span.icon",c).removeClass("checked-icon").addClass("unchecked-icon"),!1}),$(c).on("click",".print-list span.icon",{parentId:c,map:e,feature:t},function(e){$(this).hasClass("checked-icon")?$(this).removeClass("checked-icon").addClass("unchecked-icon"):$(this).removeClass("unchecked-icon").addClass("checked-icon")}),$(c).on("click",".print-single",{parentId:c,map:e,feature:t},function(t){if(t.preventDefault(),a&&a.disableControl(),!s(c))return!1;var o=[],r={id:$(this).data("id"),name:$(this).data("titulo"),codigo:$(this).data("codigo"),tipo_id:$(this).data("tipo-id"),grupo_id:$(this).data("grupo-id"),layout:$("#layout",t.data.parentId).val(),srid:$(this).data("srid"),url:$(this).data("url")};o.push(r);var n=$(this).data("action"),i={prints:o},l=$(this).data("step"),u=$(this).data("target");$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",url:n,data:JSON.stringify(i),dataParams:{step:l,target:u},beforeSend:function(){Portal.Viewer.ShowLoading(".menu-bar-widget.print .menu-bar-body")},success:function(t){if(t.Success){$(this.dataParams.target,c).empty().html(t.Message),$(this.dataParams.target+" .step-back",c).data("step",this.dataParams.step),$(this.dataParams.step,c).hide(),$(this.dataParams.target,c).show();var a=t.Data.prints,o=($.Deferred(),[]),r={};if(r.mapa_id=$("#map_id").val(),r.nif=$("#nif",c).val(),r.nome=$("#nome",c).val(),r.morada=$("#morada",c).val(),r.codpostal=$("#codpostal",c).val(),r.local=$("#local",c).val(),r.titulo=$("#titulo",c).val(),r.escala=Math.round((T=d.getView().getResolution(),M=d.getView().getProjection().getUnits(),T*ol.proj.METERS_PER_UNIT[M]*39.37*(25.4/.28))),r.finalidade_emissao=$("#finalidadeEmissao",c).val(),r.guia_pagamento=$("#guiaPagamento",c).val(),$("#userscale",c).hasClass("active")&&(r.userScale=$("#escalaDenom",c).val()),$("#predefscale",c).hasClass("active")){var n=$("#escalaPredef",c).val();n&&(n=n.split(":")[1].trim()),r.userScale=n}var i=[],l={};$(".widget_layout").each(function(e,t){l.codigo=$(this).attr("id"),l.type=$(this).attr("type"),"checkbox"==$(this).attr("type")&&(l.value=$(this).is(":checked")),i.push(l)}),r.widget_layout_list=JSON.stringify(i);for(var s=d.getView().calculateExtent(d.getSize()),u=Portal.Viewer.getPolygonFromExtent(s.join(" ")),p=[],g=Portal.Viewer.getTemporaryLayer().getSource().getFeatures(),f=0;f<g.length;f++){var m=g[f];"print"==m.get("modulo")&&p.push(m)}var h=function(t){for(var a=[],o=function(e,t){e.getView();var a=e.getView().getProjection().getUnits();return t*ol.proj.METERS_PER_UNIT[a]*39.37*(25.4/.28)},r=function(t,a){if(t.getVisible())if(t instanceof ol.layer.Group)for(var n=t.getLayers().getArray(),i=0;i<n.length;i++)r(n[i],a);else{var l=t.getSource();if(l instanceof ol.source.TileWMS||l instanceof ol.source.ImageWMS){l.getUrl?url=l.getUrl():url=l.getUrls()[0];var s={},c=l.getParams();for(key in c)s[key]=c[key];var d={url:url,params:s,opacity:t.getOpacity(),minScale:0,maxScale:0};t.getMaxResolution&&t.getMaxResolution()>0&&(d.minScale=o(e,t.getMaxResolution())),t.getMinResolution&&t.getMinResolution()>0&&(d.maxScale=o(e,t.getMinResolution())),a.push(d)}}},n=e.getLayers().getArray(),i=0;i<n.length;i++)r(n[i],a);return a}(),v=[];for(f=0;f<h.length;f++){var y=h[f];v.push("wms;"+y.url+";"+y.params.LAYERS+";"+y.opacity+";"+y.minScale+";"+y.maxScale+";"+(y.params.CQL_FILTER||"")+";"+(y.params.STYLES||y.params.STYLE||""))}for(f=0;f<a.length;f++){var w=a[f];if(r.plantaId=w.id,r.tipoId=w.tipo_id,r.grupoId=w.grupo_id,r.layout=w.layout,r.srid=w.srid,r.layers=v,""!=(r.srid||"")){var b="EPSG="+Portal.Viewer.getMapSRID()+";"+Portal.Viewer.getWKTFromGeometry(u),_=Portal.Viewer.getTransformedGeometry(b,"EPSG:"+r.srid);r.extentWKT=Portal.Viewer.getWKTFromGeometry(_)}else r.extentWKT=Portal.Viewer.getWKTFromGeometry(u);if(p&&p.length>0){for(var C=[],S=0;S<p.length;S++){var x=p[S].getGeometry();if(""!=(r.srid||"")){var P="EPSG="+Portal.Viewer.getMapSRID()+";"+Portal.Viewer.getWKTFromGeometry(x);x=Portal.Viewer.getTransformedGeometry(P,"EPSG:"+r.srid)}C.push(Portal.Viewer.getWKTFromGeometry(x))}r.geomWKT=C}Portal.Viewer.DrawTools&&(r.features=Portal.Viewer.DrawTools.getFeaturesAsGeoJSON("EPSG:"+r.srid));var k,L={url:w.url,method:"post",data:r,dataParams:this.dataParams,dataType:"json",plantaId:w.id};(k=$.ajax(L).then(function(e){return{result:e,request:this}}).fail(function(e){return{result:e}}))&&o.push(k)}(function(e,t){for(var a=$.Deferred(),o=[],r=e.length,n=0;n<e.length;n++)e[n].then(function(e){var t=e.result.Data||{};o.push({status:"success",result:"resultado success",data:t,dataParams:e.request.dataParams});var a=$("div[data-id="+t.planta_id+"] i",e.request.dataParams.target);a.length>0&&a.attr("class","fa fa-check");var r=$("div[data-id="+t.planta_id+"]",e.request.dataParams.target);if(r.length>0){var n='<a href="'+t.url+'" data-file="'+t.filename+'" target="_blank" class="open-print-file" title="Abrir planta">';n+=' abrir <span class="fa fa-external-link-alt" aria-hidden="true"></span>',n+="</a>",r.append(n)}}).fail(function(e,t,a){o.push({status:"error",result:"resultado fail",data:null,dataParams:this.dataParams});var r=$("div[data-id="+this.plantaId+"] i",this.dataParams.target);r.length>0&&r.attr("class","fa fa-exclamation-triangle")}).always(function(e){--r||a.resolve(o,t)});return a.promise()})(o,this.dataParams).then(function(e,t){for(var a=!1,o=0;o<e.length;o++)"success"==!e[o].status&&(a=!0);a?$(t.target+" .alert",c).removeClass("alert-info").addClass("alert-error").html("Não foi possível gerar a planta"):$(t.target+" .alert",c).removeClass("alert-info").addClass("alert-success").html("Planta gerada. Clique em abrir para descarregar a planta.")})}else null!=t.Data&&t.Data.info;var T,M},complete:function(){Portal.Viewer.HideLoading(".menu-bar-widget.print .menu-bar-body")},error:function(e){}})}),$(c).on("click",".print-batch",{parentId:c,map:e,feature:t},function(e){e.preventDefault();for(var t=$("#batch-print-list span[data-id].checked-icon",e.data.parentId),a=[],o=$("#layout",e.data.parentId).val()||"",r=0;r<t.length;r++){var n={id:$(t[r]).data("id"),name:$(t[r]).data("name"),codigo:$(t[r]).data("codigo"),tipo_id:$(t[r]).data("tipo-id"),grupo_id:$(t[r]).data("grupo-id"),srid:$(t[r]).data("srid"),layout:o,url:$(t[r]).data("action")};a.push(n)}if(0==a.length)return!1;var i="true"==($(this).data("agruparPlantas")||"").toLowerCase(),l=$(this).data("action"),s={agruparPlantas:i,prints:a},u=$(this).data("step"),p=$(this).data("target");$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",url:l,data:JSON.stringify(s),dataParams:{step:u,target:p},beforeSend:function(){Portal.Viewer.ShowLoading(".menu-bar-widget.print .menu-bar-body")},success:function(e){if(e.Success){$(this.dataParams.target,c).empty().html(e.Message),$(this.dataParams.target+" .step-back",c).data("step",this.dataParams.step),$(this.dataParams.step,c).hide(),$(this.dataParams.target,c).show();var t=e.Data.prints,a=($.Deferred(),[]),o={};o.mapa_id=$("#map_id").val(),o.nif=$("#nif",c).val(),o.nome=$("#nome",c).val(),o.morada=$("#morada",c).val(),o.codpostal=$("#codpostal",c).val(),o.local=$("#local",c).val(),o.titulo=$("#titulo",c).val(),o.escala=Math.round((x=d.getView().getResolution(),P=d.getView().getProjection().getUnits(),x*ol.proj.METERS_PER_UNIT[P]*39.37*(25.4/.28))),o.finalidade_emissao=$("#finalidadeEmissao",c).val(),o.guia_pagamento=$("#guiaPagamento",c).val(),$("#userscale",c).hasClass("active")&&(o.userScale=$("#escalaDenom",c).val());var r=[],n={};if($(".widget_layout").each(function(e,t){n.codigo=$(this).attr("id"),n.type=$(this).attr("type"),"checkbox"==$(this).attr("type")&&(n.value=$(this).is(":checked")),r.push(n)}),o.widget_layout_list=JSON.stringify(r),$("#predefscale",c).hasClass("active")){var i=$("#escalaPredef",c).val();i&&(i=i.split(":")[1].trim()),o.userScale=i}for(var l=d.getView().calculateExtent(d.getSize()),s=Portal.Viewer.getPolygonFromExtent(l.join(" ")),u=[],p=Portal.Viewer.getTemporaryLayer().getSource().getFeatures(),g=0;g<p.length;g++){var f=p[g];"print"==f.get("modulo")&&u.push(f)}for(g=0;g<t.length;g++){var m=t[g];if(o.plantaId=m.id,o.tipoId=m.tipo_id,o.grupoId=m.grupo_id,o.srid=m.srid,o.layout=m.layout,""!=(o.srid||"")){var h="EPSG="+Portal.Viewer.getMapSRID()+";"+Portal.Viewer.getWKTFromGeometry(s),v=Portal.Viewer.getTransformedGeometry(h,"EPSG:"+o.srid);o.extentWKT=Portal.Viewer.getWKTFromGeometry(v)}else o.extentWKT=Portal.Viewer.getWKTFromGeometry(s);if(u&&u.length>0){for(var y=[],w=0;w<u.length;w++){var b=u[w].getGeometry();if(""!=(o.srid||"")){var _="EPSG="+Portal.Viewer.getMapSRID()+";"+Portal.Viewer.getWKTFromGeometry(b);b=Portal.Viewer.getTransformedGeometry(_,"EPSG:"+o.srid)}y.push(Portal.Viewer.getWKTFromGeometry(b))}o.geomWKT=y}var C,S={url:m.url,method:"post",data:o,dataParams:this.dataParams,dataType:"json",plantaId:m.id};(C=$.ajax(S).then(function(e){return{result:e,request:this}}).fail(function(e){return{result:e}}))&&a.push(C)}(function(e,t){for(var a=$.Deferred(),o=[],r=e.length,n=0;n<e.length;n++)e[n].then(function(e){var t=e.result.Data||{};o.push({status:"success",result:"resultado success",data:t,dataParams:e.request.dataParams});var a=$("div[data-id="+t.planta_id+"] i",e.request.dataParams.target);a.length>0&&a.attr("class","fa fa-check");var r=$("div[data-id="+t.planta_id+"]",e.request.dataParams.target);if(r.length>0)if(r.data("download")){var n='<a href="'+t.url+'" data-file="'+t.filename+'" target="_blank" class="open-print-file" title="Abrir planta">';n+=' abrir <span class="fa fa-external-link-alt" aria-hidden="true"></span>',n+="</a>",r.append(n)}else n='<a href="'+t.url+'" data-file="'+t.filename+'" target="_blank" class="open-print-file hidden" />',r.append(n)}).fail(function(e,t,a){o.push({status:"error",result:"resultado fail",data:null,dataParams:this.dataParams});var r=$("div[data-id="+this.plantaId+"] i",this.dataParams.target);r.length>0&&r.attr("class","fa fa-exclamation-triangle")}).always(function(e){--r||a.resolve(o,t)});return a.promise()})(a,this.dataParams).then(function(e,t){for(var a=!1,o=!1,r=[],n=0;n<e.length;n++){var i=e[n];"success"==i.status?(o=!0,r.push(i.data.filename)):a=!0}a&&!o&&$(t.target+" .alert",c).removeClass("alert-info").addClass("alert-error").html("Não foi possível gerar as plantas"),a&&o?$(t.target+" .alert",c).removeClass("alert-info").addClass("alert-warning").html("Não foi possível gerar todas as plantas. Pode descarregar as plantas disponíveis."):$(t.target+" .alert",c).removeClass("alert-info").addClass("alert-success").html("Plantas geradas. Pode descarregar as plantas pretendidas."),r.length>1&&$(t.target+" .download-all",c).removeClass("hidden")})}else null!=e.Data&&e.Data.info;var x,P},complete:function(){Portal.Viewer.HideLoading(".menu-bar-widget.print .menu-bar-body")},error:function(e){}})}),$(c).on("click",".print-download-all",{parentId:c,map:e,feature:t},function(e){var t=$(this).data("action"),a=$(this).data("download")||!1,o=[];$("a.open-print-file",c).each(function(){o.push($(this).data("file"))});var r={mapId:$("#map_id").val(),files:o};$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",url:t,data:JSON.stringify(r),beforeSend:function(){Portal.Viewer.ShowLoading(".menu-bar-widget.print .menu-bar-body")},success:function(e){if(e.Success)if(a)window.open(e.Data.url,"Download");else{$(".download-all",c).empty().html(),$(".download-all",c).remove();var t='<div style="padding: 15px; margin-bottom: 10px;"><a href="'+e.Data.url+'" target="_blank" class="open-print-file" title="Abrir PDF com todas as plantas">';t+=' Abrir PDF com todas as plantas <span class="fa fa-external-link-alt" aria-hidden="true"></span>',t+="</a></div>",$("#print-step-3").append(t)}},complete:function(){Portal.Viewer.HideLoading(".menu-bar-widget.print .menu-bar-body")},error:function(e){}})}),$(".menu-bar-widget.print").bind("onRemoveClassOpen",function(){!$(this).hasClass("open")&&a&&a.disableControl()}),$(c).on("click","#btnShowPrintPaperBox",function(e){p()}),$(c).on("change","#predefscale",function(e){p()}),$(c).on("change","#layout",function(e){p()}),$(c).on("input","#escalaDenom",function(e){p()}),$(c).on("click","#mapscale",function(e){p()}),$(c).on("shown.bs.tab",function(e){p()}),$(c).on("input","#ckbox_view_paper",function(e){p()}),$(c).on("click","#btnVoltar",function(e){i.getSource().clear()});var d=Portal.Viewer.getMap();d.on("moveend",function(e){$("#ckbox_view_paper",c).prop("checked")&&0!=$("#ckbox_view_paper",c).prop("checked")&&(!$("#mapscale",c).hasClass("active")&&t||setTimeout(function(){p()},100))});var u=Portal.Viewer.getTemporaryLayer();u.getSource().on("addfeature",function(e){setTimeout(function(){p()},100)}),u.getSource().on("removefeature",function(e){setTimeout(function(){p()},100)}),u.getSource().on("changefeature",function(e){setTimeout(function(){p()},100)});var p=function(){if(i.getSource().clear(),0!=$("#ckbox_view_paper",c).prop("checked")){if($("#userscale",c).hasClass("active"))s=$("#escalaDenom",c).val();else if($("#predefscale",c).hasClass("active")){var a=$("#escalaPredef",c).val();a&&(a=a.split(":")[1].trim()),s=a}else var o=e.getView().getResolution(),n=e.getView().getProjection().getUnits(),s=o*ol.proj.METERS_PER_UNIT[n]*39.37*(25.4/.28);var u=$("#layout",c).val();if(null==u)return null;if(u.split("|")[0],u.split("|")[1],r||t){var p=null;if(r)for(var g=Portal.Viewer.getTemporaryLayer().getSource().getFeatures(),f=0;f<g.length;f++){var m=g[f];"print"==m.get("modulo")&&(p=p?ol.extent.extend(p,m.getGeometry().getExtent()):m.getGeometry().getExtent())}else t&&(p=t.getGeometry().getExtent());if(p)var h=p[0]+(p[2]-p[0])/2,v=p[1]+(p[3]-p[1])/2;else h=d.getView().getCenter()[0],v=d.getView().getCenter()[1]}else h=d.getView().getCenter()[0],v=d.getView().getCenter()[1];if("meter"==(n="meter"))var y=39.37;else{if("degree"!=n)return console.log("Units not supported... are you on the moon ?"),null;y=4374754}var w=JSON.parse($("#ckbox_view_paper",c).attr("layout_map_sizes_for_preview").replace(/'/g,'"'));for(l in w)w[l].format==u&&(img_w=w[l].w,img_h=w[l].h);var b=1/(1/s*y*22),_=img_w*b/2,C=img_h*b/2,S=h-_,x=v-C,P=h+_,k=v+C,L=[[[S,x],[S,k],[P,k],[P,x],[S,x]]],T=new ol.geom.Polygon(L),M=new ol.Feature(T);i.getSource().addFeature(M)}}},setMap:function(t){for(var a=null,o=(e=t).getLayers().getArray(),r=0;r<o.length;r++)if("viewer-print-layer"==o[r].get("name")){a=o[r];break}null==a&&(a=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),name:"viewer-print-layer",group:"vector"})),e.addLayer(a),a,e.addLayer(i)},setFeature:function(e){t=e},setMultiGeom:function(e){r=e},getMultiGeom:function(){return r}}}(),Portal||(Portal={}),Portal.Viewer||(Portal.Viewer={}),Portal.Viewer.Catalog=function(){var e,t,a=function(){var e={format:"DD/MM/YYYY",keepOpen:!1,showClose:!0,showClear:!0,locale:"pt"};$(".date").datetimepicker(e),$(".dateclearbutton").on("click",function(e){$(this).closest(".date").data("DateTimePicker").date(null)}),$(".tipoPesqCat").click(function(){$(".pesqCatAvancada").toggle(),$(this).text($(".pesqCatAvancada").is(":visible")?"Pesquisa Simples":"Pesquisa Avançada"),$("#PesquisaAvancada").val($(".pesqCatAvancada").is(":visible"))}),$("#Temas").multiselect({buttonWidth:"100%",maxHeight:200,includeSelectAllOption:!0,enableClickableOptGroups:!0,selectAllText:"Todos",allSelectedText:"Todos",nonSelectedText:"Escolha um ou mais temas",nSelectedText:" Temas"})},o=function(){$("#resultsCatalogo a[fid]").each(function(a){if(null!=$(this).attr("data-extent-bbox")&&""!=$(this).attr("data-extent-bbox")){Portal.Viewer.getMapProjectionCode();var o=Portal.Viewer.getPolygonFromExtent($(this).attr("data-extent-bbox")).transform("EPSG:4326",Portal.Viewer.getMapProjectionCode()),r=new ol.Feature({geometry:o,fid:$(this).attr("fid"),modulo:"metadados"});$(this).hover(function(){t.getSource().addFeature(r)},function(){t.getSource().removeFeature(r)}),$(this).click(function(){if(null!=r&&null!=r.getGeometry()){var t=r.getGeometry().getExtent();e.getView().fit(t,e.getSize())}})}})},r=function(e){e?Portal.Viewer.ShowLoading(".menu-bar-widget.catalog .menu-bar-body"):Portal.Viewer.HideLoading(".menu-bar-widget.catalog .menu-bar-body")};return{Init:function(){},Load:function(t,n){$("#searchCatalogo").on("show",function(e){$(this).next(".results-area").empty()}),$("#catalogo").change(function(){r(!0),$("#searchCatalogo").next(".results-area").empty().html("");var e=$(this).data("url")+"?id="+$(this).val();$.ajax({type:"POST",url:e,traditional:!0,data:{id:$(this).val()},success:function(e){$("#catalogoFields").empty(),e.Success&&($("#catalogoFields").html(e.Message),a())},error:function(e){$("#catalogoFields").html("").destroy()},complete:function(e){r(!1)}})}),$("#formCatalogo").submit(function(t){t.preventDefault(),Portal.Viewer.getMapProjectionCode();var a=e.getView().calculateExtent(e.getSize()),n=ol.proj.transformExtent(a,e.getView().getProjection(),ol.proj.get("EPSG:4326")).join(",");owsCatalog.setMap(map),$("#formCatalogo #MapExtent").val(n),r(!0),$.ajax({type:"POST",url:$(this).attr("action"),traditional:!0,data:$(this).serialize(),success:function(e){if($("#resultsCatalogo").html(""),e.Success)$("#searchAreaCatalogo").collapse("hide"),$("#searchCatalogo").next(".results-area").html(e.Message).show(),o();else{var t="<div class='alert alert-danger'>"+e.Message+"</div>";$("#searchCatalogo").next(".results-area").html(t).show()}},error:function(e){$("#searchCatalogo").next(".results-area").html("<div class='alert alert-danger'>Ocorreu um erro ao pesquisar o catálogo</div>")},complete:function(e){r(!1)}})}),$(".btn-clear-form","#formCatalogo").click(function(e){e.preventDefault(),$(this).closest("form").trigger("reset"),$(this).closest("form").children(".results-area").html("")}),$(".nav-catalog-layers-panel",".catalog").click(function(e){$("#formCatalogo",".catalog").show(),$(".nav-catalog-layers-panel",".catalog").hide(),$("#addLayersCatalog",".catalog").hide()}),$("#resultsCatalogo").on("click","a[data-page]",function(e){r(!0),$.ajax({type:"POST",url:$("#formCatalogo").attr("action"),traditional:!0,data:$("#formCatalogo").serialize()+"&page="+$(this).attr("data-page"),success:function(e){$("#resultsCatalogo").html(""),e.Success?($("#resultsCatalogo").html(e.Message).show(),o()):("0"==$("#Id").prop("value")&&$("#Id").prop("value",e.Id),$("#windowModal").modal("hide"),$("#informationDiv").informationModal({heading:"Informação",body:"Ocorreu um erro ao pesquisar o catálogo.",messageClass:"alert alert-error",callback:function(){}}))},error:function(e){$("#resultsCatalogo").html("")},complete:function(e){r(!1)}})}),$("#resultsCatalogo").on("click","a[data-wms-link]",function(e){var t=$(this).data("wms-link");$("#formCatalogo",".catalog").hide(),$("#addLayersCatalog",".catalog").show(),$(".nav-catalog-layers-panel",".catalog").show(),owsCatalog.getCapabilities(t.trim(),null,"wms")}),owsCatalog=new OWS({rootElementId:".menu-bar-widget.catalog",parentId:".menu-bar-widget.catalog #addLayersCatalog",layers:n}),a()},setMap:function(a){e=a,t=Portal.Viewer.getTemporaryLayer()}}}(),Portal||(Portal={}),Portal.Viewer||(Portal.Viewer={}),Portal.Viewer.Search=function(){var _modulo="search",_map,_layer,_address_roads=[],_address_locators=null,_records_data={},_feature=null,_feature_over=null,_init=function(){},_load=function(parentId){$(".menu-button-link",parentId).click(function(e){var target=$(this).data("target"),action=$(this).data("action"),data={map_id:$("#map_id").val()||null,widget_id:$(this).data("widget-id")||null};action?(_showLoading(!0),$.ajax({type:"POST",url:action,data:data,traditional:!0,success:function(r){$(".search-steps",parentId).hide(),$(target+" .form-area",parentId).html(r.Message),$(target,parentId).show(),r.Data&&r.Data.script&&eval(r.Data.script)},error:function(e){_showLoading(!1)},complete:function(e){_showLoading(!1)}})):($(".search-steps",parentId).hide(),$(target,parentId).show())}),$(".step-back",parentId).click(function(e){for(var t=$(this).data("step"),a=(s=_layer.getSource()).getFeatures(),o=a.length-1;o>=0;o--){var r=a[o];r.get("modulo")==_modulo&&s.removeFeature(r)}var n=$("input[name='WidgetConfig']",$(this).closest("div.search-steps")).val();if(n){var i=JSON.parse(n.replace(/\'/g,'"'));if(i&&i.filter_layer&&i.filter_layer.name){var l=findLayerBy(Portal.Viewer.getRootLayer(),"id",i.filter_layer.name);if(l){var s,c=(s=l.getSource()).getParams();delete c.CQL_FILTER,s.updateParams(c)}}}$(".search-steps",parentId).hide(),$(t,parentId).show()}),$(parentId).on("click",".btn-clear-form",_form_clear),$(parentId).on("submit",".form-search",_form_submit),$(parentId+" .results-area.search-widget").on("click","a[data-page]",function(e){_showLoading(!0);var t=$(this).closest(".results-area"),a=$("form",$(this).closest(".results-area").parent());$.ajax({type:"POST",url:$(a).attr("action"),traditional:!0,data:$(a).serialize()+"&page="+$(this).attr("data-page"),extraData:{targetElement:t},success:function(e){var t=this.extraData.targetElement;if($(t).html(""),e.Success){$(".panel-collapse",$(t).parent()).collapse("hide"),$(t).html(e.Message).show();var a=$(t).data("search-code");_records_data[a]=e.Data}else{var o="<div class='alert alert-danger'>"+e.Message+"</div>";$(t).html(o).show()}},error:function(e){var t=this.extraData.targetElement;$(t).html("<div class='alert alert-danger'>Ocorreu um erro ao executar a pesquisa.</div>").show()},complete:function(e){_showLoading(!1)}})}),$(parentId).on("click","a[data-record-id]",_click_record),$(parentId).on("mouseenter","a[data-record-id]",_mouseenter_record),$(parentId).on("mouseleave","a[data-record-id]",_mouseleave_record),$(parentId).on("click","a[data-child-record-id]",_click_child_record),$(parentId).on("mouseenter","a[data-child-record-id]",_mouseenter_child_record),$(parentId).on("mouseleave","a[data-child-record-id]",_mouseleave_record),$(parentId).on("change","select[data-select-action]",_change_select),$(parentId).on("click","a.link-dir[data-action]",function(e){e.preventDefault();var t=[this],a={generateID:function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()}};Portal.Viewer.ShowDirectory.apply(a,t)}),$("#formSearchAddress",parentId).submit(function(e){e.preventDefault();Portal.Viewer.getMapProjectionCode();var t=_map.getView().calculateExtent(_map.getSize());t=ol.geom.Polygon.fromExtent(ol.proj.transformExtent(t,_map.getView().getProjection(),ol.proj.get("EPSG:4326")));var a=Portal.Viewer.getWKTFromGeometry(t);$("#MapExtent",this).val(a),_showLoading(!0),$.ajax({type:"POST",url:$(this).attr("action"),traditional:!0,data:$(this).serialize(),success:function(e){if($("#resultsSearchAddress").html(""),e.Success)$("#searchAreaAddress").collapse("hide"),$("#formSearchAddress").next(".results-area").html(e.Message).show(),_loadAddressData(e.Data);else{var t="<div class='alert alert-danger'>"+e.Message+"</div>";$("#formSearchAddress").next(".results-area").html(t).show()}},error:function(e){$("#searchAddress").next(".results-area").html("<div class='alert alert-danger'>Ocorreu um erro ao executar a pesquisa.</div>")},complete:function(e){_showLoading(!1)}})}),$("#resultsSearchAddress").on("click","a[data-page]",function(e){_showLoading(!0),$.ajax({type:"POST",url:$("#formSearchAddress").attr("action"),traditional:!0,data:$("#formSearchAddress").serialize()+"&page="+$(this).attr("data-page"),success:function(e){$("#resultsSearchAddress").html(""),e.Success?($("#resultsSearchAddress").html(e.Message).show(),_loadAddressData(e.Data)):("0"==$("#Id").prop("value")&&$("#Id").prop("value",e.Id),$("#windowModal").modal("hide"),$("#informationDiv").informationModal({heading:"Informação",body:"Ocorreu um erro ao executar a pesquisa.",messageClass:"alert alert-error",callback:function(){}}))},error:function(e){$("#resultsSearchAddress").html("")},complete:function(e){_showLoading(!1)}})}),$("#resultsSearchAddress").on("click","a.road-record",_click_road),$("#resultsSearchAddress").on("mouseenter","a.road-record",_mouseenter_road),$("#resultsSearchAddress").on("mouseleave","a.road-record",_mouseleave_road),$("#resultsSearchAddress").on("click","a.road-locator-record",_click_road_locator),$("#resultsSearchAddress").on("mouseenter","a.road-locator-record",_mouseenter_road_locator),$("#resultsSearchAddress").on("mouseleave","a.road-locator-record",_mouseleave_road_locator)};function _click_road(e){e.preventDefault(),_clear_feature();for(var t=$(this).data("road-id"),a=($(this).data("max-zoom"),null),o=[],r=0;r<_address_roads.length;r++)if(_address_roads[r].id==t){a=_address_roads[r];break}if(a){var n=new ol.format.WKT,i=ol.extent.createEmpty();for(r=0;r<a.centerlines.length;r++){var l=n.readGeometry(a.centerlines[r].geom_wkt);l.transform("EPSG:"+a.centerlines[r].geom_srid,Portal.Viewer.getMapProjectionCode()),ol.extent.extend(i,l.getExtent());var s=new ol.Feature({geometry:l,fid:t,modulo:"search"});_layer.getSource().addFeature(s),o.push(s)}_feature=o;var c=Portal.Viewer.getConfig();if(c.map.selection&&c.map.selection.maxZoom&&c.map.selection.maxZoom>0)_map.getView().fit(i,_map.getSize(),{maxZoom:c.map.selection.maxZoom});else{var d={minResolution:.1};l instanceof ol.geom.Point&&(d.minResolution=1),_map.getView().fit(i,_map.getSize(),d)}}}function _mouseenter_road(e){e.preventDefault(),_clear_feature_over();for(var t=$(this).data("road-id"),a=null,o=[],r=0;r<_address_roads.length;r++)if(_address_roads[r].id==t){a=_address_roads[r];break}if(a){var n=new ol.format.WKT;for(r=0;r<a.centerlines.length;r++){var i=n.readGeometry(a.centerlines[r].geom_wkt);i.transform("EPSG:"+a.centerlines[r].geom_srid,Portal.Viewer.getMapProjectionCode());var l=new ol.Feature({geometry:i,fid:t,modulo:"search"});_layer.getSource().addFeature(l),o.push(l)}_feature_over=o}}function _mouseleave_road(e){e.preventDefault(),_clear_feature_over()}function _click_road_locator(e){e.preventDefault(),_clear_feature();for(var t=$(this).data("road-id"),a=$(this).data("road-locator-id"),o=($(this).data("max-zoom"),null),r=0;r<_address_roads.length;r++)if(_address_roads[r].id==t){for(var n=0;n<_address_roads[r].locators.length;n++)if(_address_roads[r].locators[n].id==a){o=_address_roads[r].locators[n];break}if(o)break}if(o){var i=(new ol.format.WKT).readGeometry(o.geom_wkt);i.transform("EPSG:"+o.geom_srid,Portal.Viewer.getMapProjectionCode());var l=new ol.Feature({geometry:i,fid:a,modulo:"search"});_layer.getSource().addFeature(l),_feature=l;var s=Portal.Viewer.getConfig();if(s.map.selection&&s.map.selection.maxZoom&&s.map.selection.maxZoom>0)_map.getView().fit(i.getExtent(),_map.getSize(),{maxZoom:s.map.selection.maxZoom});else{var c={minResolution:.1};i instanceof ol.geom.Point&&(c.minResolution=1),_map.getView().fit(i.getExtent(),_map.getSize(),c)}}}function _mouseenter_road_locator(e){e.preventDefault(),_clear_feature_over();for(var t=$(this).data("road-id"),a=$(this).data("road-locator-id"),o=null,r=0;r<_address_roads.length;r++)if(_address_roads[r].id==t){for(var n=0;n<_address_roads[r].locators.length;n++)if(_address_roads[r].locators[n].id==a){o=_address_roads[r].locators[n];break}if(o)break}if(o){var i=(new ol.format.WKT).readGeometry(o.geom_wkt);i.transform("EPSG:"+o.geom_srid,Portal.Viewer.getMapProjectionCode());var l=new ol.Feature({geometry:i,fid:a,modulo:"search"});_layer.getSource().addFeature(l),_feature_over=l}}function _mouseleave_road_locator(e){e.preventDefault(),_clear_feature_over()}function _clear_feature_over(){if(_feature_over)if(_feature_over instanceof Array)for(var e=0;e<_feature_over.length;e++)_layer.getSource().removeFeature(_feature_over[e]);else _layer.getSource().removeFeature(_feature_over);_feature_over=null}function _clear_feature(){if(_feature)if(_feature instanceof Array)for(var e=0;e<_feature.length;e++)try{_layer.getSource().removeFeature(_feature[e])}catch(e){}else try{_layer.getSource().removeFeature(_feature)}catch(e){}_feature=null}var _loadAddressData=function(e){_address_roads=e},_form_submit=function(e){e.preventDefault();Portal.Viewer.getMapProjectionCode();var t=_map.getView().calculateExtent(_map.getSize());t=ol.geom.Polygon.fromExtent(ol.proj.transformExtent(t,_map.getView().getProjection(),ol.proj.get("EPSG:4326")));var a=Portal.Viewer.getWKTFromGeometry(t),o=$(this).parent().next(".results-area");$("#MapExtent",this).val(a),_showLoading(!0),$.ajax({type:"POST",url:$(this).attr("action"),traditional:!0,data:$(this).serialize(),extraData:{targetElement:o},success:function(e){var t=this.extraData.targetElement;if($(t).html(""),e.Success){$(".panel-collapse",$(t).parent()).collapse("hide"),$(t).html(e.Message).show();var a=$(t).data("search-code");_records_data[a]=e.Data;var o=$("input[name='WidgetConfig']",$(t).parent()).val();if(o){var r=JSON.parse(o.replace(/\'/g,'"'));if(r&&r.filter_layer&&r.filter_layer.name){var n=findLayerBy(Portal.Viewer.getRootLayer(),"id",r.filter_layer.name);if(n&&r.filter_layer.fields&&r.filter_layer.fields.length){for(var i=n.getSource(),l=i.getParams(),s=$("form",$(t).parent()),c="",d=0;d<r.filter_layer.fields.length;d++){var u=r.filter_layer.fields[d].layer_field_name||r.filter_layer.fields[d].name;if($("[name='"+r.filter_layer.fields[d].name+"']",s).length){var p=$("[name='"+r.filter_layer.fields[d].name+"']",s).val();if(p){c&&(c+=" AND ");var g=r.filter_layer.fields[d].type||"",f=r.filter_layer.fields[d].value;"integer"==g.toLowerCase()?c+=u+" = "+p:(f&&(p=f.replace("{value}",p)),c+=u+" ILIKE '"+p+"'")}}}c?l.CQL_FILTER=c:delete l.CQL_FILTER,i.updateParams(l)}}}}else{var m="<div class='alert alert-danger'>"+e.Message+"</div>";$(t).html(m).show()}},error:function(e){var t=this.extraData.targetElement;$(t).html("<div class='alert alert-danger'>Ocorreu um erro ao executar a pesquisa.</div>").show()},complete:function(e){_showLoading(!1)}})},_form_clear=function(e){e.preventDefault(),$(this).closest("form").trigger("reset"),$(this).closest("form").parent().next(".results-area").html("");for(var t=(l=_layer.getSource()).getFeatures(),a=t.length-1;a>=0;a--){var o=t[a];o.get("modulo")==_modulo&&l.removeFeature(o)}var r=$("input[name='WidgetConfig']",$(this).closest("form").parent().parent()).val();if(r){var n=JSON.parse(r.replace(/\'/g,'"'));if(n&&n.filter_layer&&n.filter_layer.name){var i=findLayerBy(Portal.Viewer.getRootLayer(),"id",n.filter_layer.name);if(i){var l,s=(l=i.getSource()).getParams();delete s.CQL_FILTER,l.updateParams(s)}}}},_click_record=function(e){e.preventDefault(),_clear_feature();for(var t=$(this).data("record-id"),a=$(this).closest(".results-area").data("search-code"),o=_records_data[a],r=($(this).data("max-zoom"),null),n=0;n<o.length;n++)if(o[n].id==t){r=o[n];break}if(r&&r.geom_wkt){var i=(new ol.format.WKT).readGeometry(r.geom_wkt);i.transform("EPSG:"+r.geom_srid,Portal.Viewer.getMapProjectionCode());var l=new ol.Feature({geometry:i,fid:t,modulo:"search",sub_modulo:a});_layer.getSource().addFeature(l),_feature=l;var s=Portal.Viewer.getConfig();if(s.map.selection&&s.map.selection.maxZoom&&s.map.selection.maxZoom>0)_map.getView().fit(i.getExtent(),_map.getSize(),{maxZoom:s.map.selection.maxZoom});else{var c={minResolution:.1};i instanceof ol.geom.Point&&(c.minResolution=1),_map.getView().fit(i.getExtent(),_map.getSize(),c)}}},_mouseenter_record=function(e){e.preventDefault(),_clear_feature_over();for(var t=$(this).data("record-id"),a=$(this).closest(".results-area").data("search-code"),o=_records_data[a],r=null,n=0;n<o.length;n++)if(o[n].id==t){r=o[n];break}if(r&&r.geom_wkt){var i=(new ol.format.WKT).readGeometry(r.geom_wkt);i.transform("EPSG:"+r.geom_srid,Portal.Viewer.getMapProjectionCode());var l=new ol.Feature({geometry:i,fid:t,modulo:"search",sub_modulo:a});_layer.getSource().addFeature(l),_feature_over=l}},_mouseleave_record=function(e){e.preventDefault(),_clear_feature_over()};function _click_child_record(e){e.preventDefault(),_clear_feature();for(var t=$(this).data("parent-record-id"),a=$(this).data("child-record-id"),o=$(this).closest(".results-area").data("search-code"),r=$(this).data("child-collection"),n=_records_data[o],i=null,l=0;l<n.length;l++)if(n[l].id==t){for(var s=n[l][r],c=0;c<s.length;c++)if(s[c].id==a){i=s[c];break}if(i)break}if(i){var d=(new ol.format.WKT).readGeometry(i.geom_wkt);d.transform("EPSG:"+i.geom_srid,Portal.Viewer.getMapProjectionCode());var u=new ol.Feature({geometry:d,fid:a,modulo:"search"});_layer.getSource().addFeature(u),_feature=u;var p=Portal.Viewer.getConfig();if(p.map.selection&&p.map.selection.maxZoom&&p.map.selection.maxZoom>0)_map.getView().fit(d.getExtent(),_map.getSize(),{maxZoom:p.map.selection.maxZoom});else{var g={minResolution:.1};d instanceof ol.geom.Point&&(g.minResolution=1),_map.getView().fit(d.getExtent(),_map.getSize(),g)}}}var _mouseenter_child_record=function(e){e.preventDefault(),_clear_feature_over();for(var t=$(this).data("parent-record-id"),a=$(this).data("child-record-id"),o=$(this).closest(".results-area").data("search-code"),r=$(this).data("child-collection"),n=_records_data[o],i=null,l=0;l<n.length;l++)if(n[l].id==t){for(var s=n[l][r],c=0;c<s.length;c++)if(s[c].id==a){i=s[c];break}if(i)break}if(i){var d=(new ol.format.WKT).readGeometry(i.geom_wkt);d.transform("EPSG:"+i.geom_srid,Portal.Viewer.getMapProjectionCode());var u=new ol.Feature({geometry:d,fid:a,modulo:"search"});_layer.getSource().addFeature(u),_feature_over=u}},_change_select=function(e){var t=$(this).data("select-action"),a=$(this).data("select-param"),o=$("#"+$(this).data("select-target"));$(o).empty().append('<option value=""></option>');var r={};r[a]=$(this).val(),_showLoading(!0),$.ajax({type:"POST",url:t,traditional:!0,data:r,extraData:{targetElement:o},success:function(e){var t=this.extraData.targetElement;if(e.Success)for(var a=e.Data,o=0;o<a.length;o++)$(t).append('<option value="'+a[o].key+'">'+a[o].value+"</option>")},error:function(e){},complete:function(e){_showLoading(!1)}})},_showLoading=function(e){e?Portal.Viewer.ShowLoading(".menu-bar-widget."+_modulo+" .menu-bar-body"):Portal.Viewer.HideLoading(".menu-bar-widget."+_modulo+" .menu-bar-body")},_setMap=function(e){_map=e,_layer=Portal.Viewer.getTemporaryLayer()};return{Init:_init,Load:_load,setMap:_setMap}}(),Portal||(Portal={}),Portal.Viewer||(Portal.Viewer={}),Portal.Viewer.Planos=function(){var e,t,a={},o=function(e){var t=$(this).siblings(".resultsList")[0];if(t||(t=$(this).parent().siblings(".resultsList")[0]),$(t).hasClass("opened")){if($(t).removeClass("opened").addClass("closed"),$(this).is("span"))$(this).removeClass("opened-icon").addClass("closed-icon");else if($(this).is("a")){(a=$(this).prev(".icon"))[0]||(a=$(".icon.group-icon",$(this).parent())),a.removeClass("opened-icon").addClass("closed-icon")}}else if($(t).removeClass("closed").addClass("opened"),$(this).is("span"))$(this).removeClass("closed-icon").addClass("opened-icon");else if($(this).is("a")){var a;(a=$(this).prev(".icon"))[0]||(a=$(".icon.group-icon",$(this).parent())),a.removeClass("closed-icon").addClass("opened-icon")}return!1},r=function(a){var o=$(this),r=t.getSource();if(r.clear(),o.data("plano-features")){var i=o.data("plano-features");r.addFeatures(i),e.getView().fit(ol.extent.buffer(r.getExtent(),200),map.getSize())}else n(o,!0);var l=function(e,t,a){var o=e;t=t;o.get("id")!=t?o instanceof ol.layer.Group&&o.getLayers().forEach(function(e){return e.get("id")==t?void e.set("visible",!0):void l(e,t,o)}):a?a.set("visible",!0):o.set("visible",!0)},s=$(this).data("layer-id");e.getLayers().forEach(function(e){l(e,s,null)})},n=function(o,r){if(a.layerRequest&&a.layerRequest.url){var n=o.data("value"),i=a.layerRequest;i.valueFilter=n,Portal.Viewer.getFeature(i,function(a){if(a&&a.length&&a.length>0){var n=t.getSource();o.data("plano-features",a),n.addFeatures(a),r&&e.getView().fit(ol.extent.buffer(n.getExtent(),200),map.getSize())}})}};return{Init:function(){},Load:function(e){var i=$("input.wigdet-config",e).val();if(i)try{a=JSON.parse(i.replace(/'/g,'"'))}catch(e){a={}}else a={};$(e).on("click","span.group-icon",o),$(e).on("click","a.group-title",o),$(e).on("click","span.zoom-icon",r),a.drawMode&&"mouseover"==a.drawMode&&($(e).on("mouseover","span.zoom-icon",function(e){var a=$(this),o=t.getSource();if(o.clear(),$(this).data("plano-features")){var r=$(this).data("plano-features");r&&r.length&&r.length>0&&o.addFeatures(r)}else n(a,!1)}),$(e).on("mouseout","span.zoom-icon",function(e){t.getSource().clear()}))},setMap:function(a){e=a,t=Portal.Viewer.getTemporaryLayer()}}}(),Portal||(Portal={}),Portal.Viewer||(Portal.Viewer={}),Portal.Viewer.Confrontation=function(){var e,t,a,o,r,n={},i={srid:3763,geomEWKT:"",format:""},l=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#1b465a",width:5}),image:new ol.style.Circle({fill:new ol.style.Fill({color:"#ff0000"}),stroke:new ol.style.Stroke({color:"#1b465a",width:5}),radius:6})}),s=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"red",width:5}),image:new ol.style.Circle({fill:new ol.style.Fill({color:"#ff0000"}),stroke:new ol.style.Stroke({color:"#1b465a",width:5}),radius:6})});return{Init:function(){},Load:function(c){!function(e){var t=Portal.Viewer.getMap(),o=Portal.Viewer.getTemporaryLayer().getSource(),i=function(e){var t=Portal.Viewer.getTemporaryLayer();t&&t.getSource().clear()},s=function(e){e.feature.set("modulo","confrontation"),e.feature.setStyle(l),a=e.feature},c=new ol.interaction.Draw({source:o,type:"Point"});c.on("drawstart",i),c.on("drawend",s),n.ctrlCFTCreatePoint=c,(c=new ol.interaction.Draw({source:o,type:"LineString"})).on("drawstart",i),c.on("drawend",s),n.ctrlCFTCreateLine=c,(c=new ol.interaction.Draw({source:o,type:"Polygon"})).on("drawstart",i),c.on("drawend",s),n.ctrlCFTCreatePolygon=c,r=new app.genericDrawControl({layer:Portal.Viewer.getTemporaryLayer(),onEnableControl:function(e,t){},onDisableControl:function(t){$(".btn-group[data-group='btn-geometry'] a",e).removeClass("active")}}),t.addControl(r)}(c),$(c).on("click",'.btn-group[data-group="btn-geometry"] button',function(e){var t=!$(this).hasClass("active");if($(".btn-group[data-group='btn-geometry'] button",c).removeClass("active"),t){$(this).addClass("active");var o=$(this).attr("data-button-id");if("ctrlCFTModifyGeometry"==o){var i=new ol.interaction.Modify({features:new ol.Collection(Portal.Viewer.getTemporaryLayer().getSource().getFeatures()),deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}});r.enableControl(e,i)}else if("ctrlCFTSelectGeometry"==o){var s=new ol.interaction.Select({condition:ol.events.condition.click});r.enableControl(e,s),s.on("select",function(e){var t=Portal.Viewer.getTemporaryLayer();if(t){for(var o=t.getSource(),r=o.getFeatures(),n=r.length-1;n>=0;n--){var i=r[n];i.get("modulo")==this.modulo&&o.removeFeature(i)}if(e.target.getFeatures()&&e.target.getFeatures().getLength()>0)for(var l=e.target.getFeatures().getArray(),s=0;s<l.length;s++){var c=l[s],d=new ol.Feature;d.setStyle(this.style),d.set("modulo",this.modulo),c.getGeometry()instanceof ol.geom.MultiPoint?d.setGeometry(c.getGeometry().clone().getPoint(0)):c.getGeometry()instanceof ol.geom.MultiLineString?d.setGeometry(c.getGeometry().clone().getLineString(0)):c.getGeometry()instanceof ol.geom.MultiPolygon?d.setGeometry(c.getGeometry().clone().getPolygon(0)):d.setGeometry(c.getGeometry().clone()),o.addFeature(d),a=d,e.target.getFeatures().clear();break}}},{style:l,modulo:"confrontation"})}else r.enableControl(e,n[o])}else r.disableControl(e)}),$(c).on("click",'.btn-group button[id="btnCFTZoomGeometry"]',function(t){a&&e.getView().fit(ol.extent.buffer(a.getGeometry().getExtent(),200),e.getSize())}),$(c).on("click","#btnCFTClearGeometry",function(e){a&&Portal.Viewer.getTemporaryLayer().getSource().removeFeature(a),a=null}),$(c).on("click","#btnAnalisar",function(e){if(e.preventDefault(),r&&(r.disableControl(),$(c).find(".btn-group[data-group='btn-geometry'] button").removeClass("active")),!a)return $("#validation",c).empty().html("<div class='alert alert-danger'>É obrigatório indicar no mapa o local de confrontação</div>").show(),!1;if($("#cftinfo",c).hide(),t.getSource().clear&&t.getSource().clear(),o){try{Portal.Viewer.getTemporaryLayer().getSource().removeFeature(o)}catch(e){}o=null}$("#confrontation-results").empty().html(""),$("#validation",c).empty().html("");var n=$(this).attr("data-action"),l=3763;$("#srid",c).length>0&&(l=$("#srid",c).val());var d=new ol.format.WKT,u=null;a&&(u=d.writeGeometry(a.getGeometry()),u="SRID="+Portal.Viewer.getMapSRID()+";"+u),i={srid:l,geomEWKT:u,buffer:$("#ctrlCFTBuffer").val()||0,mapId:$("#map_id").val(),config:$("#ctrlCFTConfig").val()||""},$.ajax({type:"POST",url:n,traditional:!0,data:i,beforeSend:function(){Portal.Viewer.ShowLoading(".menu-bar-widget.confrontation .menu-bar-body")},success:function(e){if(e.Success){if($("#confrontation-results").html(e.Message),e.Data&&e.Data.output_geom){var t=e.Data.output_geom.split(";").pop(),a={dataProjection:"EPSG:"+l,featureProjection:"EPSG:"+Portal.Viewer.getMapSRID()};(o=d.readFeature(t,a)).setStyle(s)}$(".btnExportIntersectCFT",c).each(function(){var e=$(this).data("action"),t=$(this).data("format"),a=$.extend({format:t},i),o=$.param(a);$(this).attr("href",e+"?"+o)})}else null!=e.Data&&e.Data.info&&$("#validation",c).empty().html(e.Message)},complete:function(){Portal.Viewer.HideLoading(".menu-bar-widget.confrontation .menu-bar-body")},error:function(e){}})}),$(c).on("click",".tree-toggler.nav-header",function(e){$(this).next().toggle()}),$(c).on("click","#cftRealGeom",function(e){var t=Portal.Viewer.getTemporaryLayer().getSource();this.checked?t.addFeature(o):t.removeFeature(o)}),$(c).on("click",".cft-toggle-group",function(e){var t="#cft-group-results-"+[$(this).data("schema"),$(this).data("table")].join("-"),a=$(t).css("display");$(this).text("none"===a?"-":"+"),$(t).toggle()}),$(c).on("click",".cft-toggle-group-geom",function(e){var t=this,a="#cft-group-results-"+[$(this).data("schema"),$(this).data("table")].join("-");$(c).find(a+" input.results-cft-geom").each(function(e,a){t.checked&&!this.checked&&$(this).click(),!t.checked&&this.checked&&$(this).click()})}),$(c).on("click",".results-cft-geom",function(e){var a=function(e){for(var a=null,o=$(e).data("record-id"),r=t.getSource().getFeatures(),n=0;n<r.length;n++)r[n].get("recordId")===o&&(a=r[n]);return a}(this);!this.checked&&a&&t.getSource().removeFeature(a),this.checked&&!a&&function(e){if(null!=$(e).attr("data-geom")&&""!=$(e).attr("data-geom")){var a=$(e).data("geom"),o=$(e).data("record-id"),r={recordId:o};if(null!=a&&a.length>0){var n=Portal.Viewer.getTransformedGeometry(a,Portal.Viewer.getMapProjectionCode());r.geometry=n}var i=new ol.Feature(r);t.getSource().addFeature(i)}}(this)})},setMap:function(a){for(var o=null,r=(e=a).getLayers().getArray(),n=0;n<r.length;n++)if("viewer-confrontation-layer"==r[n].get("name")){o=r[n];break}null==o&&(o=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),name:"viewer-confrontation-layer",group:"vector"})),e.addLayer(o),t=o}}}(),Portal||(Portal={}),Portal.Viewer||(Portal.Viewer={}),Portal.Viewer.DrawTools=function(){var e,t,a={},o={hist:[],history_now:0,click:!1,draw_geom:!1,draw_symbol:!1,draw_text:!1,fill:{r:"255",g:"255",b:"255",a:"1"},stroke:{r:"0",g:"0",b:"0",a:"1"},stroke_type:"normal",fill_type:"1",size:"2",geom_type:null,symbol_type:"x",text_style:"normal",text_size:"18px",text_font:"Arial",text_value:"texto",displayFillPicker:!1,displayStrokePicker:!1,editing:null,drawings:[]},r=[{key:"1",text:"1",value:"1"},{key:"2",text:"2",value:"2"},{key:"3",text:"3",value:"3"},{key:"4",text:"4",value:"4"},{key:"5",text:"5",value:"5"},{key:"10",text:"10",value:"10"},{key:"15",text:"15",value:"15"},{key:"20",text:"20",value:"20"}],n=[{key:"1",text:"circle",value:"circle"},{key:"2",text:"square",value:"square"},{key:"3",text:"triangle",value:"triangle"},{key:"4",text:"star",value:"star"},{key:"5",text:"cross",value:"cross"},{key:"10",text:"x",value:"x"}],i=[{key:"1",text:"normal",value:"normal"},{key:"2",text:"italico",value:"italic"},{key:"3",text:"negrito",value:"bold"}],l=[{key:"1",text:"8px",value:"8px"},{key:"2",text:"11px",value:"11px"},{key:"3",text:"15px",value:"15px"},{key:"4",text:"20px",value:"20px"},{key:"5",text:"25px",value:"25px"}],s=[{key:"1",text:"Arial",value:"Arial, Helvetica, sans-serif"},{key:"2",text:"Georgia",value:"Georgia, serif"}],c=[{key:"1",text:"Normal",value:"solid"},{key:"2",text:"Tracejado",value:"dashed"}],d=[{key:"1",text:"Opaco",value:"1"},{key:"2",text:"Transparente",value:"0"}],u=null,p=(new ol.Collection,null),g=null,f=(new ol.Collection,null),m=new ol.interaction.Select({condition:ol.events.condition.singleClick,hitTolerance:5,wrapX:!1}),h=new ol.Collection,v=function(){h.forEach(function(e){if(e.get("state")){var t=e.getProperties(),a=e.get("state"),o=w(e,a,t.state.stroke);e.setStyle(o)}}),p.getSource().refresh()};m.on("select",function(e){f&&u.removeInteraction(f);var t=e.selected,a=e.deselected;if(t&&t.forEach(function(e){if(e.get("state")){h.push(e);var t=e.get("state"),a=w(e,t,{r:255,g:0,b:0,a:1});e.setStyle(a)}}),a&&a.forEach(function(e){if(e.get("state")){var t=e.getProperties(),a=e.get("state"),o=w(e,a,t.state.stroke);e.setStyle(o)}}),t||a||v(),p.getSource().refresh(),!t||0===t.length)return f&&u.removeInteraction(f),m.getFeatures()&&m.getFeatures().clear(),F({draw_geom:!1,draw_symbol:!1,draw_text:!1,editing:null},!0);"drawtools"==t[0].get("modulo")&&b(t[0])}),draw=null,format=new ol.format.WKT;var y=function(e,t){var a=null;switch(e){case"square":a=new ol.style.RegularShape({fill:new ol.style.Fill({color:t.fillStr}),stroke:new ol.style.Stroke({color:t.strokeStr,width:t.width||2}),radius:parseInt(t.size,10),points:4,angle:Math.PI/4});break;case"triangle":a=new ol.style.RegularShape({fill:new ol.style.Fill({color:t.fillStr}),stroke:new ol.style.Stroke({color:t.strokeStr,width:t.width||2}),radius:parseInt(t.size,10),points:3,rotation:Math.PI/4,angle:0});break;case"star":a=new ol.style.RegularShape({fill:new ol.style.Fill({color:t.fillStr}),stroke:new ol.style.Stroke({color:t.strokeStr,width:t.width||2}),radius:parseInt(t.size,10),points:5,radius2:4,angle:0});break;case"cross":a=new ol.style.RegularShape({fill:new ol.style.Fill({color:t.fillStr}),stroke:new ol.style.Stroke({color:t.strokeStr,width:t.width||2}),radius:parseInt(t.size,10),points:4,radius2:0,angle:0});break;case"circle":a=new ol.style.Circle({fill:new ol.style.Fill({color:t.fillStr}),stroke:new ol.style.Stroke({color:t.strokeStr,width:t.width||2}),radius:parseInt(t.size,10)});break;case"x":default:a=new ol.style.RegularShape({fill:new ol.style.Fill({color:t.fillStr}),stroke:new ol.style.Stroke({color:t.strokeStr,width:t.width||2}),points:4,radius:10,radius2:0,angle:Math.PI/4})}return a},w=function(e,t,a){var o=function(e,t,a){var o=t.size,r=t.fill,n=a||t.stroke,i="rgba("+[r.r,r.g,r.b,t.fill_type?t.fill_type:1].join(",")+")",l="rgba("+[n.r,n.g,n.b,n.a].join(",")+")",s=new ol.style.Style({stroke:new ol.style.Stroke({color:l,width:parseInt(10,10)}),fill:new ol.style.Fill({color:i})});switch(e){case"MultiPoint":case"Point":s=new ol.style.Style({image:new ol.style.Circle({radius:parseInt(o,10),fill:new ol.style.Fill({color:i}),stroke:new ol.style.Stroke({color:l,width:2})})});break;case"MultiLineString":case"LineString":var c={color:l,width:parseInt(o,10)};"dashed"===t.stroke_type&&(c.lineDash=[4]),s=new ol.style.Style({stroke:new ol.style.Stroke(c)});break;case"MultiPolygon":case"Polygon":case"Circle":c={color:l,width:parseInt(o,10)},"dashed"===t.stroke_type&&(c.lineDash=[4]),s=new ol.style.Style({stroke:new ol.style.Stroke(c),fill:new ol.style.Fill({color:i})})}return s}(e.getGeometry().getType(),t,a);return"Symbol"===e.get("type")&&(o=function(e,t,a){var o=t.size,r=t.fill,n=a||t.stroke,i="rgba("+[r.r,r.g,r.b,r.a].join(",")+")",l="rgba("+[n.r,n.g,n.b,n.a].join(",")+")";return new ol.style.Style({image:y(e,{size:o,fillStr:i,strokeStr:l,width:2})})}(t.symbol_type,t,a)),"Text"===e.get("type")&&(o=function(e,t,a){var o=t.size,r=t.fill,n=a||t.stroke,i="rgba("+[r.r,r.g,r.b,r.a].join(",")+")",l="rgba("+[n.r,n.g,n.b,n.a].join(",")+")",s=t.text_style,c=t.text_size,d=t.text_font,u=t.text_value,p=[s,c,d].join(" ");return new ol.style.Style({text:new ol.style.Text({font:p,textAlign:"left",fill:new ol.style.Fill({color:i}),stroke:new ol.style.Stroke({color:l,width:parseInt(o,10)}),textBaseline:"top",text:u})})}(0,t,a)),o},b=function(e){o=Object.assign(o,e.getProperties().state),F({editing:e.getProperties(),geom_type:e.getProperties().type.toLowerCase()},!0,function(){var t=new ol.Collection;t.push(e),f=new ol.interaction.Modify({features:t,deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}}),u.addInteraction(f),f.setActive(!0)})};function _(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}var C=function(e,t){var a=e.getId()?e.getId():_();e.setId(a),e.set("id",a),e.set("modulo","drawtools");var o=e.getGeometry().getType();t.draw_symbol&&(o="Symbol"),t.draw_text&&(o="Text"),e.set("type",o),e.set("state",{draw_geom:t.draw_geom,draw_symbol:t.draw_symbol,draw_text:t.draw_text,fill:Object.assign({},t.fill),fill_type:t.fill_type,stroke:Object.assign({},t.stroke),stroke_type:t.stroke_type,size:t.size,symbol_type:t.symbol_type,text_style:t.text_style,text_size:t.text_size,text_font:t.text_font,text_value:t.text_value});var r=(new ol.format.GeoJSON).writeFeatureObject(e,{dataProjection:"EPSG:3857",featureProjection:"EPSG:3857",decimals:6});return r.crs={type:"name",properties:{name:"urn:ogc:def:crs:EPSG::3857"}},r},S=function(e){for(var t=null,a=g.getFeatures(),o=0;o<a.length;o++){var r=a[o];r.get("id")===e&&(t=r)}return t},x=function(){for(var e=g.getFeatures(),t=e.length-1;t>=0;t--){var a=e[t];"drawtools"==a.get("modulo")&&g.removeFeature(a)}F({drawings:[]},!1)},P=function(e){var t=new ol.format.GeoJSON,a={dataProjection:e||"EPSG:4326",featureProjection:u.getView().getProjection(),decimals:6},o=[];g.forEachFeature(function(e){if("drawtools"==e.get("modulo")){var t=e.clone();t.setId(e.getId()),"state"in t.values_&&delete t.values_.state,"modulo"in t.values_&&delete t.values_.modulo,t.set("_style",function(e){var t=e.getStyle(),a={};return t.getFill()&&(a.fill={color:t.getFill().getColor()}),t.getStroke()&&(a.stroke={color:t.getStroke().getColor(),width:t.getStroke().getWidth(),lineDash:t.getStroke().getLineDash()}),t.getText()?a.text={text:t.getText().getText(),font:t.getText().getFont(),stroke:{color:t.getText().getStroke().getColor(),width:t.getText().getStroke().getWidth(),lineDash:t.getText().getStroke().getLineDash()},fill:{color:t.getText().getFill().getColor()},width:parseInt(new RegExp("([0-9]{1,3})(?=px)").exec(t.getText().getFont())[0])}:"Symbol"==e.get("type")?a.shape={type:e.get("state").symbol_type,size:e.get("state").size,fill:{color:t.getImage().getFill().getColor()},stroke:{color:t.getImage().getStroke().getColor(),width:t.getImage().getStroke().getWidth(),lineDash:t.getImage().getStroke().getLineDash()}}:"Point"==e.getGeometry().getType()&&(a.image={radius:t.getImage().getRadius(),fill:{color:t.getImage().getFill().getColor()},stroke:{color:t.getImage().getStroke().getColor(),width:t.getImage().getStroke().getWidth(),lineDash:t.getImage().getStroke().getLineDash()}}),a}(e)),"Text"==t.get("type")&&e.values_.state&&e.values_.state.text_value&&t.set("text_value",e.values_.state.text_value),o.push(t)}});var r=t.writeFeaturesObject(o,a);return r.crs=e?{type:"name",properties:{name:"urn:ogc:def:crs:"+e.replace("::",":").replace(":","::")}}:{type:"name",properties:{name:"urn:ogc:def:crs:EPSG::4326"}},JSON.stringify(r)};function k(e){var t=e.toString(16);return 1==t.length?"0"+t:t}function L(e,t,a){return k(e)+k(t)+k(a)}var T=function(){$("#DrawTools .pick-a-color").pickAColor({showSpectrum:!1,showSavedColors:!1,saveColorsPerElement:!1,fadeMenuToggle:!0,showAdvanced:!0,showBasicColors:!0,showHexInput:!1,allowBlank:!1}),$($("#DrawTools #draw-stroke")[0]).parent().attr("title","Côr de rebordo"),$($("#DrawTools #draw-fill")[0]).parent().attr("title","Côr de preenchimento"),$(".pick-a-color-markup .advanced-content .color-preview .color-select.btn.advanced").text("Aplicar"),$(".pick-a-color-markup .advanced-content .preview-text").text("Pré-visualizar"),$(".pick-a-color-markup .advanced-content .saturation-text").text("Saturação"),$(".pick-a-color-markup .advanced-content .lightness-text").text("Luminosidade"),$(".pick-a-color-markup .advanced-content .hue-text").text("Côr"),$(".pick-a-color-markup .color-menu-tabs .advanced-tab a").text("Avançado"),$(".pick-a-color-markup .color-menu-tabs .basicColors-tab a").text("Básico");var r={white:"Branco",red:"Vermelho",orange:"Laranja",yellow:"Amarelo",green:"Verde",blue:"Azul",purple:"Roxo",black:"Preto"};$.each(Object.keys(r),function(e,t){$(".pick-a-color-markup .color-menu .basicColors-content li>a."+t+" .color-label").text(r[t])}),$("#DrawTools .pick-a-color").on("change",function(){var e,t=$(this).attr("name"),a=$(this).val(),r=(e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null;r.a=1;var n={rgb:r};if("stroke"===t&&function(e){F({stroke:e.rgb})}(n),"fill"===t&&(r.a=parseInt(o.fill_type),function(e){F({fill:e.rgb})}(n)),o.editing){var i=S(o.editing.id);if(i){"fill"===t&&Object.assign(i.get("state").fill,r),"stroke"===t&&Object.assign(i.get("state").stroke,r);var l=w(i,o,o.stroke);i.setStyle(l)}}}),$(e).on("click","#DrawTools .btn-geometry-draw",function(o){var r=!$(this).hasClass("active");if($(".btn-group[data-group='btn-geometry'] button",e).removeClass("active"),$("#clear",e).addClass("hidden"),$("#clearall",e).removeClass("hidden"),m.getFeatures()&&m.getFeatures().clear(),r){$(this).addClass("active");var n=$(this).attr("data-button-id");t.enableControl(o,a[n])}else t.disableControl(o)}),$(e).on("click","#DrawTools .btn-geometry-zoom",function(e){for(var t=null,a=g.getFeatures(),o=0;o<a.length;o++){var r=a[o];"drawtools"==r.get("modulo")&&(t=t?ol.extent.extend(t,r.getGeometry().getExtent()):r.getGeometry().getExtent())}t&&u.getView().fit(ol.extent.buffer(t,200),u.getSize())}),$(e).on("change",'#DrawTools  [name="symbol_type"]',function(e){if(F({symbol_type:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").symbol_type=o.symbol_type;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("change",'#DrawTools  [name="text_font"]',function(e){if(F({text_font:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").text_font=o.text_font;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("change",'#DrawTools  [name="text_size"]',function(e){if(F({text_size:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").text_size=o.text_size;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("change",'#DrawTools  [name="text_style"]',function(e){if(F({text_style:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").text_style=o.text_style;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("change",'#DrawTools  [name="text_value"]',function(e){if(F({text_value:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").text_value=o.text_value;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("keyup",'#DrawTools  [name="text_value"]',function(e){if(F({text_value:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").text_value=o.text_value;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("change",'#DrawTools  [name="size"]',function(e){if(F({size:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").size=o.size;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("change",'#DrawTools  [name="stroke_type"]',function(e){if(F({stroke_type:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){t.get("state").stroke_type=o.stroke_type;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("change",'#DrawTools  [name="fill_type"]',function(e){if(F({fill_type:$(this).val()}),o.editing){var t=S(o.editing.id);if(t){Object.assign(t.get("state").fill,o.fill),t.get("state").fill_type=o.fill_type;var a=w(t,o,o.stroke);t.setStyle(a)}}}),$(e).on("click","#DrawTools .draw-action-del",function(t){!function(){if(o.editing){var t=o.drawings,a=S(o.editing.id);a&&(u.removeInteraction(f),m.getFeatures().clear(),t=t.filter(function(e){e.id,a.getId()}),o.drawings=t,g.removeFeature(a)),F({draw_geom:!1,draw_symbol:!1,draw_text:!1,editing:null}),$("#clear",e).addClass("hidden"),$("#clearall",e).removeClass("hidden")}}()}),$(e).on("click","#DrawTools .draw-action-delall",function(e){$.jsPanel({paneltype:"modal",headerTitle:"Eliminar desenhos",theme:"danger",show:"animated",contentSize:{width:250,height:120},content:'<div style="text-align:center;padding:20px">Deseja eliminar todos os desenhos?</div><div style="text-align:center;padding-top:10px"><div class="col-md-6"><button class="btn btn-block btn-danger btn-sm confirm-delete" type="button">Sim</button></div><div class="col-md-6"><button class="btn btn-block btn-default btn-sm cancel-delete" type="button">Não</button></div></div>',callback:function(e){$("button.confirm-delete",this.content).click(function(){x(),e.close()}),$("button.cancel-delete",this.content).click(function(){e.close()})}})}),$(e).on("click","#DrawTools .btn-export",function(e){var t=P(),a=new Blob([t],{type:"data:application/vnd.geo+json;base64;"});saveAs(a,"export.json")}),$(e).on("click","#DrawTools .btn-import",function(t){$("#features-file-import",e).trigger("click")}),$("#features-file-import",e).change(function(e){var t=this;t.files.length>0&&function(e,t){try{var a=new FileReader;a.readAsText(e),a.onload=function(e){e.target&&e.target.result?t(e.target.result):console.error("File could not be loaded")},a.onerror=function(e){console.error("File could not be read")}}catch(e){console.error("File could not be read")}}(t.files[0],function(e){var a=(new ol.format.GeoJSON).readFeatures(e,{featureProjection:u.getView().getProjection()});$(a).each(function(e,t){var a=null;t.get("_style")?a=function(e,t){var a={};if(t.fill?a.fill=new ol.style.Fill({color:t.fill.color}):a.fill=null,t.stroke?a.stroke=new ol.style.Stroke({color:t.stroke.color,width:t.stroke.width,lineDash:t.stroke.lineDash}):a.stroke=null,e.get("type")&&"text"==e.get("type").toLocaleLowerCase())a.text=new ol.style.Text({font:t.text.font,text:t.text.text,fill:new ol.style.Fill({color:t.text.fill.color}),stroke:t.text.stroke.width>0?new ol.style.Stroke({color:t.text.stroke.color,width:t.text.stroke.width}):void 0,offsetX:t.text.offsetX||0,offsetY:t.text.offsetY||0,textAlign:t.text.textAlign||"left",textBaseline:t.text.textAlign||"top"});else if("Symbol"==e.get("type"))a.image=y(t.shape.type,{size:t.shape.size,fillStr:t.shape.fill.color,strokeStr:t.shape.stroke.color,width:t.shape.stroke.width});else if("Point"==e.getGeometry().getType()){var o=5;t.image&&t.image.radius&&(o=t.image.radius);var r="rgba(255,255,255,1)";t.image&&t.image.fill&&t.image.fill.color&&(r=t.image.fill.color),a.image=new ol.style.Circle({radius:o,fill:new ol.style.Fill({color:r}),stroke:new ol.style.Stroke({color:t.image.stroke.color,width:t.image.stroke.width,lineDash:t.image.stroke.lineDash})})}return new ol.style.Style(a)}(t,t.get("_style")):(a=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),t.get("id")||t.set("id",_())),t.setStyle(a),t.set("modulo","drawtools"),t.setId(_());var o=function(e){var t=e.substring(5,e.length-1).replace(/ /g,"").split(",");return{r:t[0],g:t[1],b:t[2],a:t[3]}};!function(e,t){var a={draw_geom:!1,draw_symbol:!1,draw_text:!1,fill:{r:"255",g:"255",b:"255",a:"0"},fill_type:"0",stroke:{r:"0",g:"0",b:"0",a:"1"},stroke_type:"normal",size:"2",symbol_type:"x",text_style:"normal",text_size:"18px",text_font:"Arial",text_value:"texto"};if(e.get("type")){if("point"==e.get("type").toLocaleLowerCase())a.draw_geom=!0,a.geom_type="point",a.size=t.getImage().getRadius(),a.fill=o(t.getImage().getFill().getColor()),a.fill_type=o(t.getImage().getFill().getColor()).a||"1",a.stroke=o(t.getImage().getStroke().getColor()),(n=t.getImage().getStroke().getLineDash())&&n.length>0&&4==n[0]?a.stroke_type="dashed":a.stroke_type="normal";else if("polygon"==e.get("type").toLocaleLowerCase())a.draw_geom=!0,a.geom_type="polygon",a.size=t.getStroke().getWidth(),a.fill=o(t.getFill().getColor()),a.fill_type=o(t.getFill().getColor()).a||"1",a.stroke=o(t.getStroke().getColor()),(n=t.getStroke().getLineDash())&&n.length>0&&4==n[0]?a.stroke_type="dashed":a.stroke_type="normal";else if("linestring"==e.get("type").toLocaleLowerCase())a.draw_geom=!0,a.geom_type="line",a.size=t.getStroke().getWidth(),a.stroke=o(t.getStroke().getColor()),(n=t.getStroke().getLineDash())&&n.length>0&&4==n[0]?a.stroke_type="dashed":a.stroke_type="normal";else if("text"==e.get("type").toLocaleLowerCase()){a.draw_text=!0,a.size=t.getText().getStroke().getWidth(),a.fill=o(t.getText().getFill().getColor()),a.fill_type=o(t.getText().getFill().getColor()).a||"1",a.stroke=o(t.getText().getStroke().getColor()),(n=t.getText().getStroke().getLineDash())&&n.length>0&&4==n[0]?a.stroke_type="dashed":a.stroke_type="normal";var r=t.getText().getFont().split(" ");a.text_font=r[2],a.text_size=r[1],a.text_style=r[0],a.text_value=t.getText().getText()}else if("symbol"==e.get("type").toLocaleLowerCase()){var n;a.draw_symbol=!0,a.symbol_type=e.get("_style").shape.type,a.size=t.getImage().getRadius(),a.fill=o(t.getImage().getFill().getColor()),a.fill_type=o(t.getImage().getFill().getColor()).a||"1",a.stroke=o(t.getImage().getStroke().getColor()),(n=t.getImage().getStroke().getLineDash())&&n.length>0&&4==n[0]?a.stroke_type="dashed":a.stroke_type="normal"}}else{a.draw_geom=!0,-1!==e.getGeometry().getType().toLowerCase().indexOf("polygon")?e.set("type","Polygon"):-1!==e.getGeometry().getType().toLowerCase().indexOf("line")?e.set("type","Line"):e.set("type","Point"),a.geom_type=e.get("type").toLowerCase();var i=w(e,a);e.setStyle(i)}e.set("state",a)}(t,a),"_style"in t.getProperties()&&delete t.values_._style}),g.addFeatures(a),$(t)[0].value=""})})},M=function(){if($parent=$("#DrawTools"),o.draw_geom&&null==o.editing)switch((o.geom_type||"").toLocaleLowerCase()){case"point":$parent.find('[data-button-id="point"]').addClass("active");break;case"line":case"linestring":$parent.find('[data-button-id="line"]').addClass("active");break;case"polygon":$parent.find('[data-button-id="polygon"]').addClass("active")}else $parent.find(".draw-geom").removeClass("active");if(o.draw_symbol&&null==o.editing?$parent.find(".draw-symbol").addClass("active"):($parent.find(".draw-symbol").removeClass("active"),$parent.find("#draw-symbol-options").addClass("hidden")),o.draw_text&&null==o.editing?$parent.find(".draw-text").addClass("active"):($parent.find(".draw-text").removeClass("active"),$parent.find("#draw-text-options").addClass("hidden")),$parent.find("#draw-stroke-options").addClass("hidden"),$parent.find("#draw-fill-options").addClass("hidden"),o.draw_geom)switch((o.geom_type||"").toLocaleLowerCase()){case"point":break;case"line":case"linestring":$parent.find("#draw-stroke-options").removeClass("hidden");break;case"polygon":$parent.find("#draw-fill-options").removeClass("hidden"),$parent.find("#draw-stroke-options").removeClass("hidden")}if($parent.find('[name="size"]').attr("title","Tamanho da linha"),o.draw_symbol&&($parent.find("#draw-symbol-options").removeClass("hidden"),$parent.find('[name="size"]').attr("title","Tamanho do símbolo")),o.draw_text&&$parent.find("#draw-text-options").removeClass("hidden"),$parent.find("#clear").addClass("hidden"),$parent.find("#clearall").addClass("hidden"),m.getFeatures().getLength()?$parent.find("#clear").removeClass("hidden"):$parent.find("#clearall").removeClass("hidden"),o.editing){if(o.fill){$("#draw-fill",".menu-bar.drawtools").val(L(o.fill.r,o.fill.g,o.fill.b));var e="rgb("+o.fill.r+","+o.fill.g+","+o.fill.b+")";$(".color-preview.current-color",$(".menu-bar.drawtools #draw-fill").parent()).css("background-color",e)}if(o.stroke){$("#draw-stroke",".menu-bar.drawtools").val(L(o.stroke.r,o.stroke.g,o.stroke.b));e="rgb("+o.stroke.r+","+o.stroke.g+","+o.stroke.b+")";$(".color-preview.current-color",$(".menu-bar.drawtools #draw-stroke").parent()).css("background-color",e)}}$('#draw-symbol-options [name="symbol_type"]').empty();for(var t=0;t<=n.length-1;t++)$('#draw-symbol-options [name="symbol_type"]').append($("<option>",{value:n[t].value,text:n[t].text,selected:o.symbol_type===n[t].value}));$('#draw-text-options [name="text_font"]').empty();for(t=0;t<=s.length-1;t++)$('#draw-text-options [name="text_font"]').append($("<option>",{value:s[t].value,text:s[t].text,selected:o.text_font===s[t].value}));$('#draw-text-options [name="text_style"]').empty();for(t=0;t<=i.length-1;t++)$('#draw-text-options [name="text_style"]').append($("<option>",{value:i[t].value,text:i[t].text,selected:o.text_style===i[t].value}));$('#draw-text-options [name="text_size"]').empty();for(t=0;t<=l.length-1;t++)$('#draw-text-options [name="text_size"]').append($("<option>",{value:l[t].value,text:l[t].text,selected:o.text_size===l[t].value}));$('#draw-text-options [name="text_value"]').val(o.text_value),$('#DrawTools [name="size"]').empty();for(t=0;t<=r.length-1;t++)$('#DrawTools [name="size"]').append($("<option>",{value:r[t].value,text:r[t].text,selected:""+(o.size||"")===r[t].value}));$('#draw-stroke-options [name="stroke_type"]').empty();for(t=0;t<=c.length-1;t++)$('#draw-stroke-options [name="stroke_type"]').append($("<option>",{value:c[t].value,text:c[t].text,selected:o.stroke_type===c[t].value}));$('#draw-fill-options [name="fill_type"]').empty();for(t=0;t<=d.length-1;t++)$('#draw-fill-options [name="fill_type"]').append($("<option>",{value:d[t].value,text:d[t].text,selected:o.fill_type===d[t].value}));$('#DrawTools [name="fill"]').val(L(o.fill.r,o.fill.g,o.fill.b)),$('#DrawTools [name="stroke"]').val(L(o.stroke.r,o.stroke.g,o.stroke.b))},F=function(e,t,a){o=Object.assign(o,e),t&&M(),a&&a(o)},V=function(r){var n,i=p,l=i.getSource(),s=function(e){},c=function(e){var t,a,r=C(e.feature,o);t=e.feature,a=w(t,o),t.setStyle(a),o.drawings.push(r);var n=o.hist,i=o.history_now;setTimeout(function(){for(var e=[],t=g.getFeatures(),a=0;a<=t.length-1;a++){var r=t[a],l=C(r,r.getProperties().state);e.push(Object.assign({},l))}n.push(e),o=Object.assign(o,{hist:n,history_now:i+1})},350)};(n=new ol.interaction.Draw({source:l,type:"Point"})).on("drawstart",s),n.on("drawend",c),a.text=n,(n=new ol.interaction.Draw({source:l,type:"Point"})).on("drawstart",s),n.on("drawend",c),a.symbol=n,(n=new ol.interaction.Draw({source:l,type:"Point"})).on("drawstart",s),n.on("drawend",c),a.point=n,(n=new ol.interaction.Draw({source:l,type:"LineString"})).on("drawstart",s),n.on("drawend",c),a.line=n,(n=new ol.interaction.Draw({source:l,type:"Polygon"})).on("drawstart",s),n.on("drawend",c),a.polygon=n,a.select=m,t=new app.genericDrawControl({layer:i,onEnableControl:function(e,t){if(f&&u.removeInteraction(f),v(),"text"==$(e.currentTarget).data("button-id"))F({draw_geom:!1,draw_symbol:!1,draw_text:!0,editing:null},!0);else if("symbol"==$(e.currentTarget).data("button-id"))F({draw_geom:!1,draw_symbol:!0,draw_text:!1,editing:null},!0);else if($(e.currentTarget).hasClass("draw-geom")){var a=$(e.currentTarget).data("button-id");F({draw_geom:!0,draw_symbol:!1,draw_text:!1,geom_type:a,editing:null},!0)}},onDisableControl:function(t){f&&u.removeInteraction(f),v(),$(".btn-group[data-group='btn-geometry'] button",e).removeClass("active")}}),u.addControl(t)};return{Init:function(){},Load:function(t){e=t,T()},setMap:function(e){(u=e).getLayers(),p=Portal.Viewer.getDrawtoolsLayer(),g=p.getSource(),p.setVisible(!0),V(),M()},SetControl:function(e){e},clear:function(){x()},getFeatures:function(){return g.getFeatures()},getFeaturesByAttributes:function(e,t){return function(e,t){if(!e)throw new Error("Invalid attributes");if(!t)throw new Error("Invalid attribute values");if("object"!=typeof e)throw new Error("Invalid attributes");if("object"!=typeof t)throw new Error("Invalid attribute values");if(e.length!==t.length)throw new Error("Attributes and values length do not match");var a=[];return g.forEachFeature(function(o){var r=0;$.each(e,function(e,a){o.get(a)===t[e]&&r++}),r===e.length&&a.push(o)}),a}(e,t)},getFeaturesByGeometry:function(e){return function(e){if(!e)throw new Error("Invalid geometry");var t=[];return g.forEachFeature(function(a){a.getExtent().intersects(e.getExtent())&&t.push(a)}),t}(e)},getFeaturesAsGeoJSON:function(e){return P(e)}}}();var owsCatalog=null,widgets=[],roles=[],store_map_state=!0,LoadApp=function(url_config,proxy){OpenLayers.ProxyHost=proxy+"?url=",mapProxy=proxy,Portal.Viewer.ShowLoading("#map");var xhr=$.ajax({url:url_config,method:"get",dataType:"json"}).then(function(e){if(1==e.Success){$("<script>").attr("type","text/javascript").text("var cfg_tmp = "+e.Data).appendTo("head");var t=cfg_tmp;cfg_tmp=null,delete cfg_tmp,t.id=$("#container>#map_id").val(),e.Widgets&&(widgets=e.Widgets),e.Roles&&(roles=e.Roles),loadConfig(t,proxy),updateLeftMenuPos(),updateRightMenuPos(),showDefaultWidget(),showActiveLayers(),executeAction(map)}else{"Ocorreu um erro ao abrir o mapa.","</div>",$.jsPanel({theme:"danger",resizeit:!1,dragit:!1,headerTitle:"Erro",headerControls:{controls:"none"},content:'<div class="message-info alert" role="alert">Ocorreu um erro ao abrir o mapa.</div>'})}}).fail(function(e){$.jsPanel({theme:"danger",resizeit:!1,dragit:!1,headerTitle:"Erro",headerControls:{controls:"none"},content:'<div class="message-info alert" role="alert">Ocorreu um erro ao abrir o mapa.</div>'})}).always(function(e){Portal.Viewer.HideLoading("#map")}),loadConfig=function(cfg,proxy){var map_default_props={proxy:proxy,style:{},selection:{multi:!0}};if(cfg.map=$.extend({},map_default_props,cfg.map),map=Portal.Viewer.Load(cfg,"map"),hasWidget("zoom_previous")){var map_view_history=[],storeMapView=function(){if(store_map_state){var e={zoom:map.getView().getZoom(),center:map.getView().getCenter(),rotation:map.getView().getRotation()};map_view_history.push(e)>10&&map_view_history.shift()}else store_map_state=!0};map.on("moveend",storeMapView);var mapHistoryControl=new app.mapHistoryControl({target:"zoomPreviousPanel",className:"map-control",map_view_history:map_view_history});map.addControl(mapHistoryControl)}map.addControl(new ol.control.Zoom({target:"zoomPanel",zoomInTipLabel:"Aproximar",zoomOutTipLabel:"Afastar",className:"map-control"}));var icon=document.createElement("i");icon.className="fa fa-globe";var att=document.createAttribute("aria-hidden");att.value="true",icon.setAttributeNode(att);var extent=void 0;cfg.map.extent&&cfg.map.extent.bounds&&(extent=ol.proj.transformExtent(cfg.map.extent.bounds,cfg.map.extent.projection||map.getView().getProjection(),map.getView().getProjection())),map.addControl(new ol.control.ZoomToExtent({target:"zoomExtentPanel",tipLabel:"Ver Tudo",className:"map-control",label:icon,extent:extent})),map.addControl(new app.measureControl({target:"measurePanel",measureDistanceTipLabel:"Medir Distância",measureAreaTipLabel:"Medir Área",projection:cfg.map.displayProjection,className:"map-control",label:icon,layer:Portal.Viewer.getTemporaryLayer()})),hasWidget("scaleline")&&map.addControl(new ol.control.ScaleLine({target:$(".scaleline-control")[0]})),hasWidget("attribution")&&(map.addControl(new ol.control.Attribution({collapsible:!1})),setTimeout(function(){$(".ol-attribution ul li a").each(function(){$(this).attr("target","_blank")})},1e3)),hasWidget("basemaps")&&map.addControl(new app.BasemapsControl({target:"basemapPanel",group:"basemap"})),hasWidget("basemaps_map")&&map.addControl(new app.BasemapsMapControl({target:$(".basemaps-map-control")[0],group:"basemap"}));var lc=new app.LayersControl({target:"layersPanel",groups:cfg.map.groups,styleRestrictedScales:cfg.map.toc&&cfg.map.toc.styleRestrictedScales||null,parentLayerVisible:cfg.map.toc&&cfg.map.toc.parentLayerVisible||null,wms:cfg.map.toc&&cfg.map.toc.wms||null});if(map.addControl(lc),hasWidget("mouse_position")&&(mousePositionControl=new app.MousePositionControl({coordinateFormat:ol.coordinate.createStringXY(4),projection:cfg.map.displayProjection||cfg.map.projection||map.getView().getProjection().getCode(),projections:cfg.map.projections,target:$(".map-coordsys-control")[0],undefinedHTML:"&nbsp;"}),map.addControl(mousePositionControl)),hasWidget("coordinates")&&$(".menu-bar-widget.coordinates").length>0){var coordinatesControl=new app.coordinatesControl({target:"coordinatesPanel",coordinatesTipLabel:"Obter Coordenadas",className:"map-control",layer:Portal.Viewer.getTemporaryLayer(),onMapClick:function(e){var t=e.coordinate;Portal.Viewer.Coordenadas.Transform(t[0],t[1])},onDisable:function(){Portal.Viewer.Coordenadas.Disable()}});map.addControl(coordinatesControl),Portal.Viewer.Coordenadas.SetControl(coordinatesControl)}if(hasWidget("drawtools")&&$(".menu-bar-widget.drawtools").length>0){var drawtoolsControl=new app.drawtoolsControl({target:"drawToolsViewPanel",drawtoolsTipLabel:"Ferramentas de Desenho",className:"map-control",layer:Portal.Viewer.getTemporaryLayer(),onDisable:function(){}});map.addControl(drawtoolsControl),Portal.Viewer.DrawTools.SetControl(drawtoolsControl),drawtoolsControl.setViewer(Portal.Viewer.DrawTools)}if(hasWidget("feature_info")){var featureInfoControl=new app.featureInfoControl({config:getWidgetConfig("feature_info"),target:"featureInfoPanel",containment:"#map",proxy:proxy,buttonTipLabel:"Obter Informação",className:"map-control",rootLayer:lc.getRootLayer(),queryLayers:cfg.map.queryLayers||[],showLoading:Portal.Viewer.ShowLoading,hideLoading:Portal.Viewer.HideLoading,showDirectory:Portal.Viewer.ShowDirectory,showEditor:Portal.Viewer.ShowEditor,executeAction:function(action){eval(action)},addWMSLayer:function(e){this.getMap();var t=$(e).data("target-layer"),a=$(e).data("url"),o=$(e).data("layer-name"),r=$(e).data("layer-name"),n=$(e).data("layer-title"),i=owsLayers.addWMSLayer(a,null,o,"image/png",!0,n,null,!0,"1.3.0","","","",r,!1,!1,null,t);if(t){var l=findLayerBy(this.rootLayer,"id",t);l?l.getLayers().push(i):this.rootLayer.getLayers().push(i)}else this.rootLayer.getLayers().push(i)}});map.addControl(featureInfoControl)}if(hasWidget("feature_select")){var featureSelectControl=new app.featureSelectControl({containment:"#map",condition:ol.events.condition.click,multi:cfg.map.selection.multi,rootLayer:lc.getRootLayer(),styles:{selection:cfg.map.style.selection||Portal.Viewer.getSelectionStyles(),active:cfg.map.style.active||Portal.Viewer.getActiveStyles()}});map.addControl(featureSelectControl)}if(hasWidget("google_streetview")){var googleStreetViewControl=new app.googleStreetViewControl({target:"googleStreetViewPanel",buttonTipLabel:"Ver Google Street View",panelTitle:"Google Street View",className:"map-control",iconStyle:null,layer:Portal.Viewer.getTemporaryLayer(),onMapClick:null,onDisable:null});map.addControl(googleStreetViewControl)}if(hasWidget("numeric_scale")){var numericScaleControl=new app.NumericScaleControl({target:$(".numericscale-control-container")[0]});map.addControl(numericScaleControl),numericScaleControl.set("active",!0)}if(hasWidget("numeric_scale")&&hasWidget("scaleline")){var selectedScaleControlName="scaleline",toggleScaleControl=function(e){$(".scale-controls .item").each(function(t,a){$(a).data("name")!==e?$(a).addClass("hidden"):$(a).removeClass("hidden")}),selectedScaleControlName=e},selectScaleControlListener=function(){$(".scale-controls").removeClass("open"),toggleScaleControl($(this).data("name"))};$(".scale-controls .scale-control-selector").click(function(){!1===$(".scale-controls").hasClass("open")?($(".scale-controls .item").removeClass("hidden"),$(".scale-controls").addClass("open"),$(".scale-controls .item").click(selectScaleControlListener)):($(".scale-controls .item").unbind("click",selectScaleControlListener),toggleScaleControl(selectedScaleControlName),$(".scale-controls").removeClass("open"))}),toggleScaleControl(selectedScaleControlName)}else $(".scale-controls").addClass("single");if(hasWidget("overviewmap")){var overviewMapControl=new ol.control.OverviewMap({collapsed:!1,collapsible:!0,tipLabel:"Mapa de enquadramento",layers:[new ol.layer.Tile({source:new ol.source.OSM})]});map.addControl(overviewMapControl)}geonamesServices.setMap(map),owsLayers=new OWS({rootElementId:".menu-bar-widget.toc",parentId:".toc #addLayersPanel",layers:lc.rootLayer.getLayers()}),owsLayers.setMap(map),$(".menu-button").bind("open",function(e){$(".menu-button").not(this).each(function(){$(this).removeClass("active")}),$(this).hasClass("active")||$(this).addClass("active");var t=".menu-bar";"right"==$(this).data("target-menu")&&(t=".menu-bar-right");var a=$(this).data("target"),o=$(t+a)[0];o&&($(t).not(o).each(function(){$(this).removeClass("open"),$(this).trigger("onRemoveClassOpen")}),$(o).hasClass("open")||$(o).addClass("open"),setTimeout(function(){updateMapControlsPos(o)},300))}),$(".menu-button").click(function(e){e.preventDefault();var _this=this,menu=".menu",menu_bar=".menu-bar";"right"==$(_this).data("target-menu")&&(menu=".menu-right",menu_bar=".menu-bar-right"),$(".menu-button",menu).not(_this).each(function(){$(this).removeClass("active")}),$(_this).toggleClass("active");var filter=$(_this).data("target"),elem=$(menu_bar+filter)[0],action=$(_this).data("action"),loaded=$(elem).data("loaded"),data={map_id:$("#map_id").val()},show_panel=function(){elem&&($(menu_bar).not(elem).each(function(){$(this).removeClass("open"),$(this).trigger("onRemoveClassOpen")}),$(elem).toggleClass("open"),setTimeout(function(){updateMapControlsPos(elem)},300))};if(action&&""!=action)if(loaded)show_panel();else{Portal.Viewer.ShowLoading(menu_bar);var jqxhr=$.ajax({type:"POST",data:data,url:action+window.location.search}).done(function(e){e.Success&&($(elem).empty().html(e.Message),$(elem).data("loaded",!0)),Portal.Viewer.HideLoading(menu_bar)}).fail(function(e){console.log("fail")}).always(function(r){show_panel(),Portal.Viewer.HideLoading(menu_bar),r.Data&&r.Data.script&&eval(r.Data.script)})}else show_panel()}),$(".menu-bar-widget.home .menu-button-link").click(function(e){e.preventDefault();var _this=this,menu=".menu",menu_bar=".menu-bar";"right"==$(_this).data("target-menu")&&(menu=".menu-right",menu_bar=".menu-bar-right"),$(".menu-button",menu).not(_this).each(function(){$(this).removeClass("active")});var filter=$(_this).data("target"),elem=$(menu_bar+filter)[0],action=$(_this).data("action"),loaded=$(elem).data("loaded"),data={map_id:$("#map_id").val()},show_panel=function(){$(".menu-button"+filter).toggleClass("active"),elem&&($(menu_bar).not(elem).each(function(){$(this).removeClass("open"),$(this).trigger("onRemoveClassOpen")}),$(elem).toggleClass("open"),setTimeout(function(){updateMapControlsPos(elem)},300))};if(action&&""!=action)if(loaded)show_panel();else{Portal.Viewer.ShowLoading(menu_bar);var jqxhr=$.ajax({type:"POST",url:action,data:data}).done(function(e){e.Success&&($(elem).empty().html(e.Message),$(elem).data("loaded",!0)),Portal.Viewer.HideLoading(menu_bar)}).fail(function(e){console.log("fail")}).always(function(r){show_panel(),Portal.Viewer.HideLoading(menu_bar),r.Data&&r.Data.script&&eval(r.Data.script)})}else show_panel()}),$(".search-button").on("click",function(e){e.preventDefault();var t=$(this).closest(".input-group");$("input.search-input",t).val(""),$(this).removeClass("searching active")}),$(".nav-layers-panel a").click(function(e){e.preventDefault();var t=$(this).data("target");$(".layers-panel").hide(),$(t).show(),$(".nav-layers-panel>a").not(this).show(),$(this).hide()}),$("a.login").click(function(e){return e.preventDefault(),$("#menu-info-container").hide("fast"),$($(this).data("target")).toggle(),!1}),$("a.menu-info").click(function(e){return e.preventDefault(),$("#user-info-container").hide("fast"),$($(this).data("target")).toggle(),!1}),$(document).click(function(){$("#user-info-container").hide("fast")}),$("#user-info-container").click(function(e){e.stopPropagation()}),$("#menu-info-container").click(function(){$("#send-feedback","#contact-form").empty().html("").hide("fast")}),$("#contact-form").submit(function(e){e.preventDefault();var t=$("#name","#contact-form").val(),a=$("#email","#contact-form").val(),o=$("#message","#contact-form").val();Portal.Viewer.ShowLoading("#menu-info-container"),$("#send-feedback","#contact-form").empty().html("").removeClass("alert-success alert-warning").hide();$.ajax({type:"POST",url:$("#contact-form").data("action"),data:"name="+t+"&email="+a+"&message="+o}).done(function(e){e.Success?($("#send-feedback","#contact-form").empty().html(e.Message).addClass("alert-success"),$("#message","#contact-form").val("")):$("#send-feedback","#contact-form").empty().html(e.Message).addClass("alert-warning")}).fail(function(e){$("#send-feedback","#contact-form").empty().html("Ocorreu um erro ao enviar a mensagem").addClass("alert-warning")}).always(function(e){Portal.Viewer.HideLoading("#menu-info-container"),$("#send-feedback","#contact-form").show()})}),Portal.Viewer.Coordenadas.Load("TransformCoordenadas"),Portal.Viewer.DrawTools.Load(".menu-bar-widget.drawtools"),Portal.Viewer.DrawTools.setMap(map),Portal.Viewer.PDM.Load(".menu-bar-widget.pdm"),Portal.Viewer.PDM.setMap(map),Portal.Viewer.Print.Load(".menu-bar-widget.print"),Portal.Viewer.Print.setMap(map),Portal.Viewer.Catalog.Load(null,lc.rootLayer.getLayers()),Portal.Viewer.Catalog.setMap(map),Portal.Viewer.Search.Load(".menu-bar-widget.search"),Portal.Viewer.Search.setMap(map),Portal.Viewer.Planos.Load(".menu-bar-widget.planos_list"),Portal.Viewer.Planos.setMap(map),$(".menu-bar-right")&&$(".menu-bar-right").length},showDefaultWidget=function(){var e=$("#show_widget").val();if(window.location.hash&&(e=window.location.hash.substr(1)),e){var t=$(".menu-button."+e);t.length>0&&t.trigger("click")}},updateMapControlsPos=function(e){$(e).hasClass("menu-bar")?$(".ol-overviewmap").css("left",$(e).position().left+$(e).outerWidth()+5):$(e).hasClass("menu-bar-right")&&($("#map-toolbar-container").css("right",$(e).outerWidth()+$("#map-toolbar-container").outerWidth()+3),$(".map-coordsys-control").css("right",$(e).outerWidth()+$("#map-toolbar-container").outerWidth()),$(".basemaps-map-control").css("right",$(e).outerWidth()+$("#map-toolbar-container").outerWidth()+10),$(".ol-attribution").css("right",$(e).outerWidth()+$("#map-toolbar-container").outerWidth()+$(".basemaps-map-control").outerWidth()+12),$(".scale-controls").css("right",$(e).outerWidth()+$("#map-toolbar-container").outerWidth()+$(".map-coordsys-control").outerWidth()+25))},updateLeftMenuPos=function(){var e=$(".menu").outerWidth();$(".ol-overviewmap").css("left",e+5)},updateRightMenuPos=function(){$(".basemaps-map-control");if(0==$("#header").length){var e=$("#map-navbar-container").position().top+$("#map-navbar-container").outerHeight();$(".menu-right").css("top",e+1),$(".menu-bar-right").css("top",e+1),$(".ol-overviewmap").css("bottom",5)}var t=$(".menu-right"),a=$(".menu-bar-widget.menu-bar-right"),o=($(t).outerWidth()||0)+($(a).outerWidth()||0);$("#map-toolbar-container").css("right",o+3),$(".map-coordsys-control").css("right",o),$(".basemaps-map-control").css("right",o+10),$(".ol-attribution").css("right",o+$(".basemaps-map-control").outerWidth()+12),$(".scale-controls").css("right",o+$(".map-coordsys-control").outerWidth()+25)},showActiveLayers=function(){var e=$("#show_layers").val();if(e)for(var t=e.split(";"),a=0;a<t.length;a++){var o=t[a];Portal.Viewer.showLayer(Portal.Viewer.getRootLayer(),o,null)}},executeAction=function(e){var t=JSON.parse($("#url_params").val());if(0==t.nb_params)return null;var a=Portal.Viewer.getConfig(),o=t.geom;if(null!=o){var r=(new ol.format.WKT).readGeometry(o);r.transform("EPSG:3763",Portal.Viewer.getMapProjectionCode()),_layer=Portal.Viewer.getTemporaryLayer();var n=new ol.Feature({geometry:r,fid:1});if(a.map.style&&a.map.style.selection?n.setStyle(a.map.style.selection):a.map.selection&&a.map.selection.style&&n.setStyle(a.map.selection.style),_layer.getSource().addFeature(n),_feature_over=n,_map=e,a.map.selection&&a.map.selection.maxZoom&&a.map.selection.maxZoom>0)_map.getView().fit(r.getExtent(),_map.getSize(),{maxZoom:a.map.selection.maxZoom});else{var i={minResolution:.1};r instanceof ol.geom.Point&&(i.minResolution=1),_map.getView().fit(r.getExtent(),_map.getSize(),i)}}var l=t.url_args.action;if(null==l)return null;action_url="/"+l.replace(/\./g,"/");$.ajax({url:action_url,type:"post",dataType:"json"}).then(function(t){if(1==t.Success){if(null==o&&t.Data.show_alert_if_null_geom&&ShowAlert(t.Data.alert_body,t.Data.alert_title,t.Data.alert_type),null!=o||null==o&&t.Data.activate_layer_if_null_geom)for(var a=0;a<t.Data.layers.length;a++)lay=t.Data.layers[a],ol_lay=findLayerBy(e.getLayerGroup(),"id",lay.name),ol_lay.setVisible(lay.visible)}else console.log("Error")}).fail(function(e){console.log("fail")}).always(function(e){})},hasWidget=function(e){for(var t=0;t<widgets.length;t++)if(widgets[t].codigo==e)return!0;return!1},getWidgetConfig=function(e){for(var t=null,a=0;a<widgets.length;a++)if(widgets[a].codigo==e){widgets[a].config&&(t=widgets[a].config);break}return t}};function findLayerBy(e,t,a){if(e.get(t)===a)return e;if(e.getLayers)for(var o,r=e.getLayers().getArray(),n=r.length,i=0;i<n;i++)if(o=findLayerBy(r[i],t,a))return o;return null}var ShowAlert=function(e,t,a){var o='<div class="message-info alert" role="alert">';o+="<h3>"+e+"</h3>",o+="</div>",$.jsPanel({theme:a,resizeit:!1,dragit:!1,headerTitle:t,headerControls:{controls:"closeonly"},content:o})},GetAuthToken=function(){var e=null;return $("#auth_token")&&$("#auth_token").val&&(e=$("#auth_token").val()),e};$.expr[":"].icontains=$.expr.createPseudo(function(e){return function(t){return $(t).text().toUpperCase().indexOf(e.toUpperCase())>=0}}),String.format||(String.format=function(e){var t=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/g,function(e,a){return void 0!==t[a]?t[a]:e})}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var a=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>a.length)&&(t=a.length),t-=e.length;var o=a.indexOf(e,t);return-1!==o&&o===t}),Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e};